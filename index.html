<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø´Ø§Øª Ø®Ø§Øµ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
  <script src="https://unpkg.com/videojs-youtube/dist/Youtube.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    body { 
      font-family: 'Tajawal', sans-serif; 
      background: #121212;
      color: #e0e0e0;
      display: flex; 
      flex-direction: column; 
      position: relative; 
    }
    #chat-container { display: flex; flex-direction: column; height: 100%; }
    
    #messages { 
      flex: 1; 
      overflow-y: auto; 
      padding: 15px; 
      background: #1e1e1e;
      scroll-behavior: smooth; 
    }
    
    .msg { 
      margin: 8px 0; 
      display: flex; 
      gap: 10px; 
      align-items: center; 
      direction: ltr; 
      text-align: left; 
      font-size: 15px; 
      line-height: 1.4; 
    }
    .sys { 
      text-align: center; 
      color: #aaa;
      font-size: 12px; 
      margin: 10px auto; 
      font-style: italic; 
      background-color: #2a2a2a;
      padding: 4px 10px; 
      border-radius: 12px; 
      transition: opacity 0.5s; 
    }
    
    .user { 
      font-weight: bold; 
      color: #4dabf7;
    }
    
    .time { 
      font-size: 11px; 
      color: #888; 
      min-width: 40px; 
    }
    
    #inputArea {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 8px;
      padding: 10px;
      background: #1e1e1e;
      border-top: 1px solid #333;
    }

    #messageInput { 
      flex: 1; 
      font-size: 16px; 
      height: 45px;
      padding: 0 15px;
      border: 1px solid #444;
      border-radius: 25px; 
      font-family: 'Tajawal', sans-serif; 
      background: #2a2a2a;
      color: #e0e0e0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
      box-sizing: border-box;
    }
    #messageInput:focus { 
      border-color: #4dabf7;
      outline: none; 
    }
    #messageInput::placeholder {
      color: #888;
    }
    
    #sendBtn { 
      height: 45px;
      padding: 0 25px; 
      border: none; 
      border-radius: 25px; 
      background: #4dabf7;
      color: white; 
      cursor: pointer; 
      font-family: 'Tajawal', sans-serif;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex; 
      align-items: center; 
      justify-content: center;
      box-sizing: border-box;
    }

    #sendBtn:hover { 
      background: #3b99e6;
    }
    
    #topButtons { 
      position: fixed; 
      top: 10px; 
      right: 10px; 
      display: flex; 
      gap: 8px; 
      z-index: 1000; 
    }
    .btn { 
      padding: 6px 10px; 
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 20px; 
      cursor: pointer; 
      font-size: 16px; 
      line-height: 1; 
      display: flex; 
      align-items: center; 
      color: #e0e0e0;
    }
    .btn .count-text { 
      font-size: 14px; 
      margin-right: 4px; 
    }
    
    #onlineList { 
      position: fixed; 
      top: 10px; 
      right: 10px; 
      border: 1px solid #444;
      background: #2a2a2a;
      padding: 8px 14px; 
      border-radius: 20px; 
      font-size: 14px; 
      cursor: pointer; 
      z-index: 1000; 
      display: flex; 
      align-items: center; 
      gap: 5px; 
      color: #e0e0e0;
    }
    #usersBox, #setVideoModal, #videoSelectionModal { 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      background: #2a2a2a;
      padding: 20px; 
      border-radius: 8px; 
      box-shadow: 0 5px 15px rgba(0,0,0,0.5); 
      z-index: 1003; 
      display: none; 
      color: #e0e0e0;
      border: 1px solid #444;
    }
    #videoSelectionModal {
      z-index: 1004;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }
    #usersList { 
      max-height: 200px; 
      overflow-y: auto; 
    }
    .user-item { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      padding: 5px 2px; 
      border-bottom: 1px solid #444;
      font-size: 14px; 
    }
    .status-indicator { 
      width: 10px; 
      height: 10px; 
      border-radius: 50%; 
    }
    .status-green { background-color: #51cf66; } 
    .status-yellow { background-color: #fcc419; } 
    .status-gray { background-color: #868e96; }
    
    #loginScreen { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0, 0, 0, 0.85);
      display: flex; 
      justify-content: center; 
      align-items: center; 
      z-index: 10000; 
    }
    #loginBox { 
      background: #2a2a2a;
      padding: 30px; 
      border-radius: 15px; 
      text-align: center; 
      min-width: 300px; 
      color: #e0e0e0;
      border: 1px solid #444;
    }
    #usernameInput { 
      width: 100%; 
      padding: 12px; 
      margin: 10px 0; 
      border: 2px solid #444;
      border-radius: 8px; 
      font-size: 16px; 
      text-align: center; 
      box-sizing: border-box; 
      font-family: 'Tajawal', sans-serif;
      background: #1e1e1e;
      color: #e0e0e0;
    }
    #usernameInput::placeholder {
      color: #888;
    }
    #loginBtn { 
      background: #4dabf7;
      color: white; 
      border: none; 
      padding: 12px 30px; 
      border-radius: 8px; 
      font-size: 16px; 
      cursor: pointer; 
      font-family: 'Tajawal', sans-serif; 
      margin-top: 10px; 
    }
    #loginBtn:hover {
      background: #3b99e6;
    }
    
    #overlay { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.7);
      z-index: 1001; 
      display: none; 
    }
    
    #pinnedVideoPlayer { 
      position: fixed; 
      top: 50px; 
      left: 50px; 
      width: clamp(300px, 90vw, 480px); 
      background: #000; 
      border: 1px solid #444;
      border-radius: 8px; 
      box-shadow: 0 5px 20px rgba(0,0,0,0.6); 
      z-index: 998; 
      display: none; 
      flex-direction: column; 
      overflow: hidden; 
    }
    .video-header { 
      background-color: #333;
      color: #e0e0e0;
      padding: 5px 10px; 
      border-top-left-radius: 7px; 
      border-top-right-radius: 7px; 
      cursor: move; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      flex-shrink: 0; 
      touch-action: none; 
      font-size: 14px; 
    }
    .video-body { 
      width: 100%; 
      background: #000; 
      flex-grow: 1; 
    }
    .video-js .vjs-tech { 
      object-fit: contain; 
    }
    .close-pinned-video { 
      background: #fa5252;
      border: 1px solid #e03131; 
      color: white; 
      border-radius: 50%; 
      width: 22px; 
      height: 22px; 
      cursor: pointer; 
      font-size: 14px; 
      line-height: 20px; 
      text-align: center; 
    }
    .resize-handle { 
      position: absolute; 
      width: 20px; 
      height: 20px; 
      bottom: 0; 
      right: 0; 
      cursor: nwse-resize; 
      z-index: 10; 
    }
    
    .video-option {
      padding: 10px;
      margin: 8px 0;
      background: #1e1e1e;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
      border: 2px solid transparent;
    }
    
    .video-option:hover {
      background: #333;
    }
    
    .video-option.active {
      border: 2px solid #4dabf7;
      background: #2a2a2a;
    }
    
    .video-option strong {
      color: #4dabf7;
    }
    
    .video-option small {
      color: #aaa;
      font-size: 12px;
    }
    
    #videoOptions {
      margin: 15px 0;
    }
    
    #closeVideoSelection {
      background: #444;
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }
    
    #closeVideoSelection:hover {
      background: #555;
    }
    
    /* Netflix Theme for Video.js - ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
    .video-js.vjs-netflix-theme { 
      background-color: #000; 
    }
    .vjs-netflix-theme .vjs-control-bar { 
      height: 6em; 
      background: none; 
      background-image: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%); 
    }
    .vjs-netflix-theme .vjs-big-play-button { 
      display: none !important; 
    }
    .vjs-netflix-theme .vjs-progress-control { 
      position: absolute; 
      left: 0; 
      right: 0; 
      width: 100%; 
      top: -3em; 
      height: 2.5em; 
    }
    .vjs-netflix-theme .vjs-progress-holder { 
      height: 0.3em; 
      margin: 1.1em 0; 
    }
    .vjs-netflix-theme .vjs-play-progress, .vjs-netflix-theme .vjs-load-progress { 
      height: 100%; 
    }
    .vjs-netflix-theme .vjs-play-progress:before { 
      display: none; 
    }
    .vjs-netflix-theme .vjs-play-progress { 
      background-color: #e50914; 
    }
    .vjs-netflix-theme .vjs-load-progress { 
      background: rgba(255, 255, 255, 0.4); 
    }
    .vjs-netflix-theme .vjs-time-control { 
      line-height: 5em; 
      padding: 0 1em; 
    }
    .vjs-netflix-theme .vjs-remaining-time { 
      line-height: 5em; 
    }
    .vjs-netflix-theme .vjs-button > .vjs-icon-placeholder:before { 
      font-size: 2.2em; 
      line-height: 2.2; 
    }
    .vjs-netflix-theme .vjs-volume-panel, .vjs-netflix-theme .vjs-fullscreen-control { 
      margin-right: 1em; 
    }
    .video-js.vjs-netflix-theme.vjs-has-started.vjs-user-inactive .vjs-control-bar { 
      opacity: 0; 
      visibility: hidden; 
    }

    #messages::-webkit-scrollbar {
      width: 8px;
    }
    #messages::-webkit-scrollbar-track {
      background: #1e1e1e;
    }
    #messages::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 4px;
    }
    #messages::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>
<body>

  <div id="loginScreen">
    <div id="loginBox">
      <h2>ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h2>
      <input type="text" id="usernameInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ (Ø¨Ø¯ÙˆÙ† Ø±Ù…ÙˆØ² Ø®Ø§ØµØ©)" maxlength="15" autofocus>
      <button id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>

  <div id="chat-container" style="display: none;">
    <div id="topButtons">
      <div class="btn" id="setVideoBtn" title="ØªØ«Ø¨ÙŠØª ÙÙŠØ¯ÙŠÙˆ">ğŸ“º</div>
      <div class="btn" id="onlineListBtn" title="Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†">ğŸ‘¥ <span id="count" class="count-text">0</span></div>
    </div>
    
    <div id="pinnedVideoPlayer"></div>
    
    <div id="setVideoModal">
      <h4>ØªØ«Ø¨ÙŠØª ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø¬Ù…ÙŠØ¹</h4>
      <input type="text" id="videoUrlInput" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ØŒ ØªÙˆÙŠØªØ±ØŒ M3UØŒ Ø£Ùˆ MP4"/>
      <button id="submitVideoUrlBtn">ØªØ«Ø¨ÙŠØª</button>
    </div>
    
    <div id="videoSelectionModal">
      <h4>Ø§Ø®ØªØ± Ù…Ù‚Ø·Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</h4>
      <div id="videoOptions"></div>
      <button id="closeVideoSelection">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    
    <div id="usersBox">
      <h4>Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†</h4>
      <div id="usersList"></div>
    </div>
    
    <div id="overlay"></div>
    
    <div id="messages" role="list"></div>
    
    <form id="inputArea">
      <button type="submit" id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button>
      <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." autocomplete="off" />
    </form>
  </div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const firebaseConfig = {
        apiKey: "AIzaSyB1AsEHXP05nQ8M66jYPusheLaE60q_JwU",
        authDomain: "mychat-2d881.firebaseapp.com",
        databaseURL: "https://mychat-2d881-default-rtdb.firebaseio.com",
      };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let username = '';
    let userRef, messagesRef, onlineRef, pinnedVideoRef;
    let serverTimeOffset = 0;
    let videoPlayerInstance = null;

    const loginScreen = document.getElementById('loginScreen');
    const usernameInput = document.getElementById('usernameInput');
    const loginBtn = document.getElementById('loginBtn');
    const chatContainer = document.getElementById('chat-container');
    const messagesDiv = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");
    const onlineListBtn = document.getElementById("onlineListBtn");
    const setVideoBtn = document.getElementById("setVideoBtn");
    const usersBox = document.getElementById("usersBox");
    const setVideoModal = document.getElementById("setVideoModal");
    const videoUrlInput = document.getElementById("videoUrlInput");
    const submitVideoUrlBtn = document.getElementById("submitVideoUrlBtn");
    const pinnedVideoPlayer = document.getElementById("pinnedVideoPlayer");
    const overlay = document.getElementById("overlay");
    const videoSelectionModal = document.getElementById('videoSelectionModal');
    const videoOptionsDiv = document.getElementById('videoOptions');
    const closeVideoSelectionBtn = document.getElementById('closeVideoSelection');

    function attemptLogin() {
        let inputName = usernameInput.value.trim();
        const invalidChars = /[.#$\[\]]/;
        if (invalidChars.test(inputName)) {
            alert("Ø§Ù„Ø§Ø³Ù… Ù„Ø§ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ù…ÙˆØ² Ø®Ø§ØµØ©");
            return;
        }
        if (inputName.length < 2) {
            alert("Ø§Ù„Ø§Ø³Ù… Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹");
            return;
        }

        username = inputName;
        userRef = db.ref("online/" + username);
        messagesRef = db.ref("messages");
        onlineRef = db.ref("online");
        pinnedVideoRef = db.ref("pinned_video");
        
        startChat();
    }

    loginBtn.onclick = attemptLogin;
    usernameInput.onkeypress = (e) => { if (e.key === 'Enter') attemptLogin(); };

    function startChat() {
      loginScreen.style.display = 'none';
      chatContainer.style.display = 'flex';

      db.ref('.info/serverTimeOffset').on('value', snap => serverTimeOffset = snap.val() || 0);

      userRef.set({ lastActive: firebase.database.ServerValue.TIMESTAMP });
      userRef.onDisconnect().remove();

      setInterval(() => {
        userRef.update({ lastActive: firebase.database.ServerValue.TIMESTAMP });
      }, 60000);

      setInterval(() => {
         const now = Date.now() + serverTimeOffset;
         onlineRef.once('value', snap => {
             snap.forEach(child => {
                 if (now - child.val().lastActive > 90000) child.ref.remove();
             });
         });
      }, 60000);

      onlineListBtn.onclick = (e) => { e.stopPropagation(); usersBox.style.display = 'block'; overlay.style.display = 'block'; };
      setVideoBtn.onclick = (e) => { e.stopPropagation(); setVideoModal.style.display = 'block'; overlay.style.display = 'block'; };
      overlay.onclick = closeAllModals;
      closeVideoSelectionBtn.onclick = closeVideoSelection;
      
      document.getElementById("inputArea").onsubmit = (e) => {
        e.preventDefault();
        const text = messageInput.value.trim();
        if (!text) return;
        
        const time = new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', hour12: false});
        messagesRef.push({ user: username, text: text, time: time, timestamp: firebase.database.ServerValue.TIMESTAMP });
        messageInput.value = "";
        userRef.update({ lastActive: firebase.database.ServerValue.TIMESTAMP });
        scrollToBottom();
      };

      messagesRef.limitToLast(100).on("child_added", snap => {
        addMessageToUI(snap.key, snap.val());
      });

      messagesRef.on("child_removed", snap => {
        const msgElement = document.getElementById(`msg-${snap.key}`);
        if (msgElement) {
            msgElement.style.opacity = '0';
            setTimeout(() => msgElement.remove(), 300);
        }
      });

      onlineRef.on("value", snap => {
        document.getElementById("count").textContent = snap.numChildren();
        renderUsersList(snap.val() || {});
      });

      submitVideoUrlBtn.onclick = async () => {
        const url = videoUrlInput.value.trim();
        if (!url) return;
        
        const youtubeId = getYoutubeVideoId(url);
        const tweetId = getTweetId(url);
        
        if (youtubeId) {
          pinnedVideoRef.set({ type: 'youtube', id: youtubeId, setBy: username });
        } else if (tweetId) {
          try {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø© Ù…Ø®ØªÙ„ÙØ© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† ØªÙˆÙŠØªØ±
            const videos = await getTwitterVideos(tweetId);
            
            if (videos && videos.length > 1) {
              showVideoSelection(videos, tweetId);
              return;
            } else if (videos && videos.length === 1) {
              pinnedVideoRef.set({ 
                type: 'twitter', 
                id: tweetId,
                video_index: 0,
                video_url: videos[0].url,
                setBy: username 
              });
            } else {
              // Ø¥Ø°Ø§ Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ Ù†Ø³ØªØ®Ø¯Ù… iframe
              pinnedVideoRef.set({ 
                type: 'twitter_embed', 
                id: tweetId,
                setBy: username 
              });
            }
          } catch (error) {
            console.error("Error checking Twitter video:", error);
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©
            pinnedVideoRef.set({ 
              type: 'twitter_embed', 
              id: tweetId,
              setBy: username 
            });
          }
        } else if (url.toLowerCase().includes('.m3u')) {
          pinnedVideoRef.set({ type: 'm3u', url: url, setBy: username });
        } else if (isDirectVideo(url)) {
          pinnedVideoRef.set({ type: 'direct', url: url, setBy: username });
        } else {
          alert("Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ….");
          return;
        }
        
        closeAllModals();
      };

      pinnedVideoRef.on("value", async (snap) => {
        const data = snap.val();
        if (videoPlayerInstance) {
          videoPlayerInstance.dispose();
          videoPlayerInstance = null;
        }
        pinnedVideoPlayer.innerHTML = '';

        if (data) {
          pinnedVideoPlayer.style.display = 'flex';
          const header = document.createElement('div');
          header.className = 'video-header';
          header.innerHTML = `<span>Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± - ${data.setBy}</span>`;
          const closeBtn = document.createElement('button');
          closeBtn.className = 'close-pinned-video';
          closeBtn.innerHTML = 'âœ–';
          closeBtn.onclick = () => pinnedVideoRef.remove();
          header.appendChild(closeBtn);
          const body = document.createElement('div');
          body.className = 'video-body';
          
          const resizeHandle = document.createElement('div');
          resizeHandle.className = 'resize-handle';
          
          pinnedVideoPlayer.appendChild(header);
          pinnedVideoPlayer.appendChild(body);
          pinnedVideoPlayer.appendChild(resizeHandle);
          
          makeDraggable(pinnedVideoPlayer, header);
          makeResizable(pinnedVideoPlayer, resizeHandle);

          let videoSource = null;
          let videoType = '';

          if (data.type === 'youtube') {
            videoSource = `https://www.youtube.com/watch?v=${data.id}`;
            videoType = 'video/youtube';
            
            const videoEl = document.createElement('video-js');
            videoEl.className = 'vjs-netflix-theme';
            body.appendChild(videoEl);

            const playerOptions = {
              autoplay: true,
              muted: true,
              controls: true,
              aspectRatio: '16:9',
              playsinline: true,
              techOrder: ['youtube'],
              sources: [{ type: videoType, src: videoSource }]
            };
            
            videoPlayerInstance = videojs(videoEl, playerOptions);
            
          } else if (data.type === 'm3u') {
            videoSource = data.url;
            videoType = 'application/x-mpegURL';
            
            const videoEl = document.createElement('video-js');
            videoEl.className = 'vjs-netflix-theme';
            body.appendChild(videoEl);

            const playerOptions = {
              autoplay: true,
              muted: true,
              controls: true,
              aspectRatio: '16:9',
              playsinline: true,
              techOrder: ['html5'],
              sources: [{ type: videoType, src: videoSource }]
            };
            
            videoPlayerInstance = videojs(videoEl, playerOptions);
            
          } else if (data.type === 'direct') {
            videoSource = data.url;
            videoType = 'video/mp4';
            
            const videoEl = document.createElement('video-js');
            videoEl.className = 'vjs-netflix-theme';
            body.appendChild(videoEl);

            const playerOptions = {
              autoplay: true,
              muted: true,
              controls: true,
              aspectRatio: '16:9',
              playsinline: true,
              techOrder: ['html5'],
              sources: [{ type: videoType, src: videoSource }]
            };
            
            videoPlayerInstance = videojs(videoEl, playerOptions);
            
          } else if (data.type === 'twitter') {
            try {
              if (data.video_url) {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ Ù…Ø¨Ø§Ø´Ø± Ù…Ø®Ø²Ù†
                videoSource = data.video_url;
                videoType = 'video/mp4';
              } else {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                const videos = await getTwitterVideos(data.id);
                if (videos && videos.length > 0) {
                  const selectedIndex = data.video_index || 0;
                  const selectedVideo = videos[selectedIndex] || videos[0];
                  videoSource = selectedVideo.url;
                  videoType = 'video/mp4';
                }
              }
              
              if (videoSource) {
                const videoEl = document.createElement('video-js');
                videoEl.className = 'vjs-netflix-theme';
                body.appendChild(videoEl);

                const playerOptions = {
                  autoplay: true,
                  muted: true,
                  controls: true,
                  aspectRatio: '16:9',
                  playsinline: true,
                  techOrder: ['html5'],
                  sources: [{ type: videoType, src: videoSource }]
                };
                
                videoPlayerInstance = videojs(videoEl, playerOptions);
              } else {
                // Ø¥Ø°Ø§ ÙØ´Ù„ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… iframe
                body.innerHTML = `
                  <iframe 
                    src="https://twitframe.com/show?url=https://twitter.com/i/status/${data.id}"
                    style="width:100%;height:100%;border:none;"
                    allowfullscreen
                  ></iframe>
                `;
              }
            } catch (error) {
              console.error("Error loading Twitter video:", error);
              // Ø§Ø³ØªØ®Ø¯Ø§Ù… iframe ÙƒØ­Ù„ Ø¨Ø¯ÙŠÙ„
              body.innerHTML = `
                <iframe 
                  src="https://twitframe.com/show?url=https://twitter.com/i/status/${data.id}"
                  style="width:100%;height:100%;border:none;"
                  allowfullscreen
                ></iframe>
              `;
            }
          } else if (data.type === 'twitter_embed') {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… iframe Ù…Ø¨Ø§Ø´Ø±Ø©
            body.innerHTML = `
              <iframe 
                src="https://twitframe.com/show?url=https://twitter.com/i/status/${data.id}"
                style="width:100%;height:100%;border:none;"
                allowfullscreen
              ></iframe>
            `;
          }

          addNotification(`${data.setBy} Ù‚Ø§Ù… Ø¨ØªØ´ØºÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ`);
        } else {
          pinnedVideoPlayer.style.display = 'none';
        }
      });
    }

    async function getTwitterVideos(tweetId) {
      try {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¹Ø¯Ø© Ø®Ø¯Ù…Ø§Øª Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        const services = [
          `https://api.vxtwitter.com/i/status/${tweetId}`,
          `https://api.fxtwitter.com/i/status/${tweetId}`,
          `https://api.twittervideodownloader.com/tweet/${tweetId}`
        ];
        
        for (const serviceUrl of services) {
          try {
            const response = await fetch(serviceUrl, {
              headers: {
                'Accept': 'application/json',
                'User-Agent': 'Mozilla/5.0'
              }
            });
            
            if (response.ok) {
              const data = await response.json();
              
              if (data.media_extended && data.media_extended.length > 0) {
                return data.media_extended.map((media, index) => ({
                  index: index,
                  url: media.url || media.video_url || media.media_url,
                  type: media.type || 'video',
                  duration: media.duration || media.duration_ms / 1000,
                  bitrate: media.bitrate
                }));
              }
            }
          } catch (e) {
            console.log(`Service failed: ${serviceUrl}`, e);
            continue;
          }
        }
        
        // Ø¥Ø°Ø§ ÙØ´Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§ØªØŒ Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©
        try {
          const response = await fetch(`https://publish.twitter.com/oembed?url=https://twitter.com/i/status/${tweetId}`);
          const data = await response.json();
          
          // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† HTML
          if (data.html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(data.html, 'text/html');
            const video = doc.querySelector('video');
            if (video && video.src) {
              return [{
                index: 0,
                url: video.src,
                type: 'video',
                duration: null
              }];
            }
          }
        } catch (e) {
          console.log("OEmbed failed:", e);
        }
        
        return null;
      } catch (error) {
        console.error("Error getting Twitter videos:", error);
        return null;
      }
    }

    function showVideoSelection(videos, tweetId) {
      videoOptionsDiv.innerHTML = '';
      
      videos.forEach((video, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'video-option';
        const duration = video.duration ? Math.round(video.duration) + ' Ø«Ø§Ù†ÙŠØ©' : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        const quality = video.bitrate ? Math.round(video.bitrate / 1000) + ' ÙƒÙŠÙ„ÙˆØ¨Øª' : '';
        
        optionDiv.innerHTML = `
          <strong>Ù…Ù‚Ø·Ø¹ ${index + 1}</strong><br>
          <small>${video.type || 'video'} â€¢ ${duration} ${quality ? 'â€¢ ' + quality : ''}</small>
        `;
        
        optionDiv.onclick = () => {
          document.querySelectorAll('.video-option').forEach(el => {
            el.classList.remove('active');
          });
          optionDiv.classList.add('active');
          
          setTimeout(() => {
            pinnedVideoRef.set({ 
              type: 'twitter', 
              id: tweetId,
              video_index: index,
              video_url: video.url,
              setBy: username 
            });
            closeVideoSelection();
            closeAllModals();
          }, 300);
        };
        
        videoOptionsDiv.appendChild(optionDiv);
      });
      
      videoSelectionModal.style.display = 'block';
      overlay.style.display = 'block';
    }

    function closeVideoSelection() {
      videoSelectionModal.style.display = 'none';
    }

    function addMessageToUI(key, { user, text, time, timestamp }) {
      const div = document.createElement("div");
      div.className = "msg";
      div.id = `msg-${key}`;
      
      const timeElement = document.createElement("span");
      timeElement.className = "time";
      timeElement.id = `time-${key}`;
      
      updateTimeDisplay(key, timestamp, timeElement);
      
      div.innerHTML = `
        <span class="user">${escapeHtml(user)}</span>
        <span style="flex:1; word-break: break-word;">${escapeHtml(text)}</span>
      `;
      
      div.appendChild(timeElement);

      messagesDiv.appendChild(div);
      scrollToBottom();
      
      setInterval(() => {
        updateTimeDisplay(key, timestamp, timeElement);
      }, 60000);
    }

    function updateTimeDisplay(key, timestamp, timeElement) {
      if (!timestamp) return;
      
      const now = Date.now() + serverTimeOffset;
      const messageTime = timestamp + serverTimeOffset;
      const diffMs = now - messageTime;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHours = Math.floor(diffMin / 60);
      const diffDays = Math.floor(diffHours / 24);
      const diffWeeks = Math.floor(diffDays / 7);
      const diffMonths = Math.floor(diffDays / 30);
      const diffYears = Math.floor(diffDays / 365);
      
      let timeText = "";
      
      if (diffSec < 5) {
        timeText = "Ø§Ù„Ø¢Ù†";
      } else if (diffSec < 60) {
        timeText = "Ø«ÙˆØ§Ù†ÙŠ";
      } else if (diffMin < 2) {
        timeText = "Ø¯1";
      } else if (diffMin < 60) {
        timeText = `Ø¯${diffMin}`;
      } else if (diffHours < 24) {
        timeText = `Ø³${diffHours}`;
      } else if (diffDays < 7) {
        timeText = `ÙŠ${diffDays}`;
      } else if (diffWeeks < 4) {
        timeText = `Ø£${diffWeeks}`;
      } else if (diffMonths < 12) {
        timeText = `Ø´${diffMonths}`;
      } else {
        timeText = `Ø¹${diffYears}`;
      }
      
      timeElement.textContent = timeText;
    }

    function addNotification(text) {
      const div = document.createElement("div");
      div.className = "sys";
      div.textContent = text;
      messagesDiv.appendChild(div);
      scrollToBottom();
    }

    function renderUsersList(users) {
        const list = document.getElementById("usersList");
        list.innerHTML = '';
        const now = Date.now() + serverTimeOffset;
        Object.keys(users).forEach(uName => {
            const uData = users[uName];
            const div = document.createElement("div");
            div.className = "user-item";
            let colorClass = 'status-green';
            const diff = now - (uData.lastActive || 0);
            if (diff > 60000) colorClass = 'status-gray';
            else if (diff > 30000) colorClass = 'status-yellow';
            div.innerHTML = `<span class="status-indicator ${colorClass}"></span><span>${escapeHtml(uName)}</span>`;
            list.appendChild(div);
        });
    }

    function closeAllModals() {
      usersBox.style.display = 'none';
      setVideoModal.style.display = 'none';
      videoSelectionModal.style.display = 'none';
      overlay.style.display = 'none';
    }

    function makeDraggable(element, handle) {
      let offsetX = 0, offsetY = 0;
      let isDragging = false;
      
      const getPointerPosition = (e) => e.touches ? e.touches[0] : e;
      
      const onDragStart = (e) => {
        isDragging = true;
        const pointer = getPointerPosition(e);
        offsetX = pointer.clientX - element.offsetLeft;
        offsetY = pointer.clientY - element.offsetTop;
        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('touchmove', onDragMove, { passive: false });
        document.addEventListener('mouseup', onDragEnd);
        document.addEventListener('touchend', onDragEnd);
      };
      
      const onDragMove = (e) => {
        if (isDragging) {
          e.preventDefault();
          const pointer = getPointerPosition(e);
          element.style.left = (pointer.clientX - offsetX) + "px";
          element.style.top = (pointer.clientY - offsetY) + "px";
        }
      };
      
      const onDragEnd = () => {
        isDragging = false;
        document.removeEventListener('mousemove', onDragMove);
        document.removeEventListener('touchmove', onDragMove);
        document.removeEventListener('mouseup', onDragEnd);
        document.removeEventListener('touchend', onDragEnd);
      };
      
      handle.addEventListener('mousedown', onDragStart);
      handle.addEventListener('touchstart', onDragStart, { passive: false });
    }

    function makeResizable(element, handle) {
      let initialWidth, initialHeight, initialX, initialY;
      const getPointerPosition = (e) => e.touches ? e.touches[0] : e;

      function onResizeStart(e) {
        if(e.type === 'touchstart') e.preventDefault();
        const pointer = getPointerPosition(e);
        initialWidth = element.offsetWidth;
        initialHeight = element.offsetHeight;
        initialX = pointer.clientX;
        initialY = pointer.clientY;
        document.addEventListener('mousemove', onResizeMove);
        document.addEventListener('touchmove', onResizeMove, { passive: false });
        document.addEventListener('mouseup', onResizeEnd);
        document.addEventListener('touchend', onResizeEnd);
      }

      function onResizeMove(e) {
        if(e.type === 'touchmove') e.preventDefault();
        const pointer = getPointerPosition(e);
        const newWidth = initialWidth + (pointer.clientX - initialX);
        const newHeight = initialHeight + (pointer.clientY - initialY);
        if (newWidth > 300) { element.style.width = newWidth + 'px'; }
        if (newHeight > 200) { element.style.height = newHeight + 'px'; }
      }

      function onResizeEnd() {
        document.removeEventListener('mousemove', onResizeMove);
        document.removeEventListener('touchmove', onResizeMove);
        document.removeEventListener('mouseup', onResizeEnd);
        document.removeEventListener('touchend', onResizeEnd);
      }
      
      handle.addEventListener('mousedown', onResizeStart);
      handle.addEventListener('touchstart', onResizeStart, { passive: false });
    }

    function getYoutubeVideoId(url) {
      if (!url) return null;
      const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
      return (url.match(regex) || [])[1] || null;
    }

    function getTweetId(url) {
      if (!url) return null;
      const regex = /(?:https?:\/\/)?(?:www\.)?(?:twitter|x)\.com\/(?:\w+)\/status\/(\d+)/;
      return (url.match(regex) || [])[1] || null;
    }

    function isDirectVideo(url) {
      return /\.(mp4|webm|ogv)$/.test(url);
    }

    function scrollToBottom() { messagesDiv.scrollTop = messagesDiv.scrollHeight; }
    function escapeHtml(unsafe) { if(!unsafe) return ""; return unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
  });
</script>
</body>
</html>
