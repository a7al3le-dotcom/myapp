<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ø´Ø§Øª Ø®Ø§Øµ</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
body{background:#36393f;color:#fff;height:100vh;overflow:hidden;touch-action:pan-y}

/* ===== LOGIN ===== */
#loginScreen{
    height:100vh;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    padding:20px;
    background: linear-gradient(135deg, #36393f 0%, #2f3136 100%);
}
#loginContainer{
    background:#2f3136;
    padding:30px;
    border-radius:12px;
    box-shadow:0 8px 32px rgba(0,0,0,0.3);
    width:100%;
    max-width:400px;
}
#loginScreen h2{
    margin-bottom:20px;
    text-align:center;
    color:#7289da;
}
#loginScreen input{
    padding:12px 15px;
    margin-bottom:15px;
    width:100%;
    border:2px solid #40444b;
    border-radius:8px;
    background:#40444b;
    color:#fff;
    font-size:16px;
}
#loginScreen input:focus{
    outline:none;
    border-color:#7289da;
}
#loginScreen button{
    padding:12px 20px;
    width:100%;
    background:#7289da;
    color:#fff;
    border:none;
    border-radius:8px;
    font-size:16px;
    font-weight:bold;
    cursor:pointer;
    transition:background 0.3s;
}
#loginScreen button:hover{
    background:#5f73bc;
}
#loginScreen button:active{
    transform:scale(0.98);
}

/* ===== CHAT ===== */
#chatScreen{display:none;height:100vh}

/* ===== TOP BAR ===== */
#topBar{
    position:fixed;
    top:0;
    width:100%;
    background:#2f3136;
    padding:12px 16px;
    font-size:14px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    z-index:20;
    border-bottom:1px solid #202225;
    height:60px;
}
#myStatus{
    color:#43b581;
    font-weight:bold;
}
#onlineBtn{
    cursor:pointer;
    color:#9aff9a;
    background:#202225;
    padding:6px 12px;
    border-radius:6px;
    font-size:13px;
    transition:background 0.3s;
}
#onlineBtn:active{
    background:#36393f;
}

/* ===== POPUP ===== */
#overlay{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.7);
    display:none;
    z-index:30;
    animation:fadeIn 0.3s;
}
@keyframes fadeIn{
    from{opacity:0} to{opacity:1}
}
#onlinePopup{
    background:#2f3136;
    width:90%;
    max-width:300px;
    max-height:80vh;
    overflow-y:auto;
    padding:16px;
    border-radius:12px;
    position:absolute;
    top:70px;
    right:5%;
    border:1px solid #202225;
    box-shadow:0 4px 20px rgba(0,0,0,0.5);
}
#onlinePopup h4{
    margin-bottom:12px;
    font-size:16px;
    text-align:center;
    color:#7289da;
    padding-bottom:8px;
    border-bottom:1px solid #40444b;
}
.user{
    font-size:14px;
    margin-bottom:8px;
    padding:6px 10px;
    border-radius:6px;
    transition:background 0.2s;
}
.user:hover{
    background:#40444b;
}
.user.you{
    background:rgba(114,137,218,0.2);
    border-right:3px solid #7289da;
}

/* ===== MESSAGES ===== */
.messages{
    position:absolute;
    top:60px;
    bottom:110px;
    width:100%;
    overflow-y:auto;
    padding:10px;
    display:flex;
    flex-direction:column-reverse; /* Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ù„Ø£Ø¹Ù„Ù‰ */
    scroll-behavior:smooth;
}

/* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙˆÙ„ÙƒÙ† Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªÙ…Ø±ÙŠØ± */
.messages::-webkit-scrollbar{width:6px}
.messages::-webkit-scrollbar-track{background:#2f3136}
.messages::-webkit-scrollbar-thumb{background:#7289da;border-radius:3px}
.messages::-webkit-scrollbar-thumb:hover{background:#5f73bc}

.message{
    margin-bottom:16px;
    padding:8px 12px;
    border-radius:8px;
    animation:fadeInUp 0.3s;
    max-width:85%;
    word-wrap:break-word;
}
@keyframes fadeInUp{
    from{opacity:0;transform:translateY(10px)}
    to{opacity:1;transform:translateY(0)}
}
.message.mine{
    background:rgba(114,137,218,0.15);
    align-self:flex-end;
    margin-left:auto;
    margin-right:0;
}
.message.other{
    background:rgba(79,84,92,0.15);
    align-self:flex-start;
    margin-left:0;
    margin-right:auto;
}
.name{
    font-weight:bold;
    font-size:14px;
    margin-bottom:4px;
    color:#7289da;
}
.message.other .name{
    color:#43b581;
}
.text{
    margin-top:4px;
    font-size:15px;
    line-height:1.4;
}
.time{
    font-size:11px;
    color:#aaa;
    margin-top:6px;
    text-align:left;
    direction:ltr;
}
.video iframe, .video video{
    width:100%;
    max-width:560px;
    height:315px;
    margin-top:8px;
    border-radius:8px;
    border:none;
}
.image img{
    max-width:100%;
    max-height:400px;
    border-radius:8px;
    margin-top:8px;
    display:block;
}

/* ===== TYPING ===== */
#typingStatus{
    position:fixed;
    bottom:70px;
    padding:8px 16px;
    font-size:13px;
    color:#aaa;
    background:#2f3136;
    border-radius:20px;
    margin:0 16px;
    right:0;
    animation:fadeIn 0.3s;
    border:1px solid #40444b;
}

/* ===== INPUT ===== */
.input-box{
    position:fixed;
    bottom:0;
    width:100%;
    background:#2f3136;
    border-top:1px solid #202225;
    padding:8px 0;
}
.input-row{
    display:flex;
    padding:0 8px;
    gap:8px;
}
.input-row input{
    flex:1;
    border:none;
    padding:12px 16px;
    border-radius:25px;
    background:#40444b;
    color:#fff;
    font-size:15px;
    min-height:44px; /* Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚Ø© Ù„Ù…Ø³ Ø£ÙØ¶Ù„ */
}
.input-row input:focus{
    outline:none;
}
.input-row button{
    border:none;
    border-radius:50%;
    width:44px;
    height:44px;
    background:#7289da;
    color:#fff;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:background 0.3s;
    font-size:18px;
}
.input-row button:active{
    background:#5f73bc;
    transform:scale(0.95);
}

/* ===== CONNECTION STATUS ===== */
#connectionStatus{
    position:fixed;
    top:60px;
    width:100%;
    background:#faa81a;
    color:#000;
    text-align:center;
    padding:10px;
    font-size:14px;
    z-index:15;
    display:none;
    font-weight:bold;
}

/* ===== LOADING ===== */
.loading{
    text-align:center;
    padding:20px;
    color:#aaa;
    font-size:14px;
}

/* ===== MEDIA QUERIES Ù„Ù„Ù‡ÙˆØ§ØªÙ ===== */
@media (max-width: 768px){
    #loginContainer{
        padding:20px;
        margin:10px;
    }
    
    .message{
        max-width:90%;
        padding:10px;
    }
    
    .video iframe, .video video{
        height:200px;
    }
    
    #onlinePopup{
        width:95%;
        right:2.5%;
    }
    
    .input-row{
        padding:0 12px;
    }
    
    .messages{
        padding:12px;
    }
}

@media (max-width: 480px){
    #topBar{
        padding:10px;
        font-size:13px;
        height:55px;
    }
    
    .messages{
        top:55px;
        bottom:100px;
    }
    
    .input-row input{
        font-size:14px;
        padding:10px 14px;
    }
    
    .video iframe, .video video{
        height:180px;
    }
    
    .message{
        max-width:95%;
    }
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù„ÙˆØ­ÙŠØ© */
@media (min-width: 769px) and (max-width: 1024px){
    .messages{
        padding:20px;
        max-width:800px;
        margin:0 auto;
    }
    
    .message{
        max-width:80%;
    }
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen">
    <div id="loginContainer">
        <h2>ğŸ’¬ Ø´Ø§Øª Ø®Ø§Øµ</h2>
        <input id="usernameInput" placeholder="Ø§Ø³Ù…Ùƒ (Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)" autocomplete="off">
        <button onclick="login()" id="loginBtn">Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Øª</button>
    </div>
</div>

<!-- CHAT -->
<div id="chatScreen">
    <!-- TOP BAR -->
    <div id="topBar">
        <span id="myStatus">ğŸŸ¢ Ù…ØªØµÙ„</span>
        <span id="onlineBtn">ğŸ‘¥ Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† (<span id="onlineCount">0</span>)</span>
    </div>

    <!-- CONNECTION STATUS -->
    <div id="connectionStatus">ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...</div>

    <!-- POPUP -->
    <div id="overlay" onclick="closePopup()">
        <div id="onlinePopup" onclick="event.stopPropagation()">
            <h4>ğŸ‘¥ Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø§Ù„Ø¢Ù†</h4>
            <div id="onlineUsersList"></div>
        </div>
    </div>

    <!-- CHAT -->
    <div class="messages" id="messages">
        <div class="loading">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</div>
    </div>
    <div id="typingStatus"></div>

    <!-- INPUT -->
    <div class="input-box">
        <div class="input-row">
            <input id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø£Ùˆ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨/ØµÙˆØ±Ø©" autocomplete="off">
            <button onclick="send()" id="sendBtn">â¤</button>
        </div>
    </div>

</div>

<script>
// ===== FIREBASE CONFIG (ÙŠØ¬Ø¨ Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ù„Ù…Ù„Ù Ù…Ù†ÙØµÙ„ ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬) =====
const firebaseConfig = {
    apiKey: "AIzaSyB1AsEHXP05nQ8M66jYPusheLaE60q_JwU",
    databaseURL: "https://mychat-2d881-default-rtdb.firebaseio.com"
};

// ===== INITIALIZATION =====
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== GLOBAL VARIABLES =====
let username = "";
let messageListeners = [];
let typingListeners = [];
let onlineListeners = [];
let connectionListeners = [];
let lastMessageKey = null;
let isScrolledUp = false;

// ===== DOM ELEMENTS =====
const usernameInput = document.getElementById("usernameInput");
const loginScreen = document.getElementById("loginScreen");
const chatScreen = document.getElementById("chatScreen");
const messageInput = document.getElementById("messageInput");
const messages = document.getElementById("messages");
const typingStatus = document.getElementById("typingStatus");
const onlineCount = document.getElementById("onlineCount");
const onlineUsersList = document.getElementById("onlineUsersList");
const overlay = document.getElementById("overlay");
const onlineBtn = document.getElementById("onlineBtn");
const connectionStatus = document.getElementById("connectionStatus");
const loginBtn = document.getElementById("loginBtn");
const sendBtn = document.getElementById("sendBtn");

// ===== UTILITY FUNCTIONS =====
// Ø¯Ø§Ù„Ø© Ù„Ù…Ù†Ø¹ Ù‡Ø¬Ù…Ø§Øª XSS
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª
function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString('ar-SA', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
    });
}

// ===== LOGIN FUNCTION =====
function login() {
    const rawUsername = usernameInput.value.trim();
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (!rawUsername || rawUsername.length < 2) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ­ÙŠØ­ (Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)");
        return;
    }
    
    if (rawUsername.length > 20) {
        alert("Ø§Ù„Ø§Ø³Ù… Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹ (20 Ø­Ø±Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)");
        return;
    }
    
    // ØªÙ†Ø¸ÙŠÙ ÙˆØ¥Ø¹Ø¯Ø§Ø¯ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    username = escapeHtml(rawUsername);
    
    // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø§Øª
    loginScreen.style.display = "none";
    chatScreen.style.display = "block";
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    loadMessages();
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    setupConnection();
    
    // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    setTimeout(() => {
        messageInput.focus();
    }, 300);
}

// ===== CONNECTION MANAGEMENT =====
function setupConnection() {
    // Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    const connectedRef = db.ref(".info/connected");
    const connectionListener = connectedRef.on("value", (snap) => {
        if (snap.val()) {
            // Ù…ØªØµÙ„
            connectionStatus.style.display = "none";
            
            // ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒÙ…ØªØµÙ„
            const onlineRef = db.ref("onlineUsers/" + encodeURIComponent(username));
            onlineRef.set({
                name: username,
                status: "online",
                lastActive: Date.now()
            });
            
            // ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
            onlineRef.onDisconnect().remove();
            
            // ØªÙ†Ø¸ÙŠÙ Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
            const typingRef = db.ref("typing/" + encodeURIComponent(username));
            typingRef.onDisconnect().remove();
            
            connectionListeners.push(connectionListener);
        } else {
            // ØºÙŠØ± Ù…ØªØµÙ„
            connectionStatus.style.display = "block";
        }
    });
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†
    setupOnlineUsers();
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
    setupTyping();
}

// ===== MESSAGES MANAGEMENT =====
function loadMessages() {
    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ø³Ø§Ø¨Ù‚ÙŠÙ†
    cleanupListeners();
    
    const chatRef = db.ref("messages");
    
    // Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø·
    const messageListener = chatRef.limitToLast(30).on("child_added", (snap) => {
        const data = snap.val();
        if (!data) return;
        
        lastMessageKey = snap.key;
        renderMessage(data);
    });
    
    messageListeners.push(messageListener);
}

function renderMessage(data) {
    const isMine = data.user === username;
    const messageClass = isMine ? "message mine" : "message other";
    
    const div = document.createElement("div");
    div.className = messageClass;
    
    // Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    div.innerHTML = `<div class="name">${escapeHtml(data.user)}</div>`;
    
    // Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    div.innerHTML += `<div class="text">${escapeHtml(data.text)}</div>`;
    
    // Ø§Ù„ÙˆÙ‚Øª
    div.innerHTML += `<div class="time">${formatTime(data.time)}</div>`;
    
    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
    if (data.mediaType === "youtube") {
        div.innerHTML += `<div class="video">
            <iframe 
                src="https://www.youtube.com/embed/${escapeHtml(data.mediaId)}" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen>
            </iframe>
        </div>`;
    } else if (data.mediaType === "file") {
        div.innerHTML += `<div class="video">
            <video controls src="${escapeHtml(data.mediaId)}"></video>
        </div>`;
    } else if (data.mediaType === "image") {
        div.innerHTML += `<div class="image">
            <img 
                src="${escapeHtml(data.mediaId)}" 
                alt="ØµÙˆØ±Ø©" 
                loading="lazy"
                onerror="this.style.display='none'">
        </div>`;
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ù„Ø£Ù†Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… flex-direction: column-reverse)
    const loadingElement = messages.querySelector('.loading');
    if (loadingElement) {
        loadingElement.remove();
    }
    
    messages.insertBefore(div, messages.firstChild);
    
    // Ø§Ù„ØªÙ…Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ø£Ø³ÙÙ„ Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ‚Ø±Ø£ Ø±Ø³Ø§Ø¦Ù„ Ù‚Ø¯ÙŠÙ…Ø©
    if (!isScrolledUp) {
        setTimeout(() => {
            messages.scrollTop = 0;
        }, 100);
    }
}

// ===== SEND MESSAGE =====
function extractMedia(text) {
    const yt = text.match(/(?:youtube\.com\/.*[?&]v=|youtu\.be\/)([A-Za-z0-9_-]{11})/);
    if (yt) return { type: "youtube", id: yt[1] };
    
    const mp4 = text.match(/https?:\/\/\S+\.(mp4|webm|ogg)/i);
    if (mp4) return { type: "file", id: mp4[0] };
    
    const img = text.match(/https?:\/\/\S+\.(jpg|jpeg|png|gif|webp)/i);
    if (img) return { type: "image", id: img[0] };
    
    return null;
}

function send() {
    const text = messageInput.value.trim();
    if (!text || !username) return;
    
    const media = extractMedia(text);
    
    const chatRef = db.ref("messages");
    chatRef.push({
        user: username,
        text: text,
        mediaType: media ? media.type : null,
        mediaId: media ? media.id : null,
        time: Date.now()
    });
    
    // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    messageInput.value = "";
    
    // Ø¥Ø²Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
    const typingRef = db.ref("typing/" + encodeURIComponent(username));
    typingRef.remove();
    
    // Ø§Ù„ØªØ±ÙƒÙŠØ² Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚Ù„
    messageInput.focus();
}

// ===== TYPING MANAGEMENT =====
function setupTyping() {
    const typingRef = db.ref("typing");
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
    messageInput.addEventListener("input", () => {
        if (!username) return;
        
        const userTypingRef = db.ref("typing/" + encodeURIComponent(username));
        userTypingRef.set(Date.now());
        
        // Ø¥Ø²Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¨Ø¹Ø¯ 2 Ø«Ø§Ù†ÙŠØ© Ù…Ù† Ø§Ù„ØªÙˆÙ‚Ù
        clearTimeout(window.typingTimeout);
        window.typingTimeout = setTimeout(() => {
            userTypingRef.remove();
        }, 2000);
    });
    
    // Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø£Ø®Ø±Ù‰
    const typingListener = typingRef.on("value", (snap) => {
        const data = snap.val() || {};
        const now = Date.now();
        
        // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ÙŠÙƒØªØ¨ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ (Ø®Ù„Ø§Ù„ Ø¢Ø®Ø± 2 Ø«Ø§Ù†ÙŠØ©)
        const activeTyping = Object.keys(data).filter(key => {
            const user = decodeURIComponent(key);
            return user !== username && (now - data[key] < 2000);
        });
        
        if (activeTyping.length === 0) {
            typingStatus.textContent = "";
        } else {
            const names = activeTyping.map(key => decodeURIComponent(key));
            if (names.length === 1) {
                typingStatus.textContent = `${names[0]} ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†...`;
            } else {
                typingStatus.textContent = `${names.length} Ø£Ø´Ø®Ø§Øµ ÙŠÙƒØªØ¨ÙˆÙ† Ø§Ù„Ø¢Ù†...`;
            }
        }
    });
    
    typingListeners.push(typingListener);
}

// ===== ONLINE USERS MANAGEMENT =====
function setupOnlineUsers() {
    const onlineRef = db.ref("onlineUsers");
    
    const onlineListener = onlineRef.on("value", (snap) => {
        const users = snap.val() || {};
        const userNames = Object.keys(users);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
        onlineCount.textContent = userNames.length;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        onlineUsersList.innerHTML = userNames.map(key => {
            const userData = users[key];
            const userName = userData.name || decodeURIComponent(key);
            const isYou = userName === username;
            
            return `<div class="user ${isYou ? 'you' : ''}">
                ğŸŸ¢ ${escapeHtml(userName)} ${isYou ? '(Ø£Ù†Øª)' : ''}
            </div>`;
        }).join('');
    });
    
    onlineListeners.push(onlineListener);
}

// ===== SCROLL MANAGEMENT =====
messages.addEventListener('scroll', () => {
    const scrollTop = messages.scrollTop;
    const scrollHeight = messages.scrollHeight;
    const clientHeight = messages.clientHeight;
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹ÙŠØ¯Ø§Ù‹ Ø¹Ù† Ø§Ù„Ø£Ø³ÙÙ„ Ø¨Ù…Ø³Ø§ÙØ© ÙƒØ¨ÙŠØ±Ø©
    isScrolledUp = scrollTop < scrollHeight - clientHeight - 100;
});

// ===== POPUP MANAGEMENT =====
onlineBtn.onclick = () => {
    overlay.style.display = "block";
};

function closePopup() {
    overlay.style.display = "none";
}

// ===== KEYBOARD EVENTS =====
messageInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        send();
    }
});

// ===== MEMORY MANAGEMENT =====
function cleanupListeners() {
    // ØªÙ†Ø¸ÙŠÙ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
    messageListeners.forEach(listener => {
        if (listener && typeof listener === 'function') {
            const chatRef = db.ref("messages");
            chatRef.off("child_added", listener);
        }
    });
    
    typingListeners.forEach(listener => {
        if (listener && typeof listener === 'function') {
            const typingRef = db.ref("typing");
            typingRef.off("value", listener);
        }
    });
    
    onlineListeners.forEach(listener => {
        if (listener && typeof listener === 'function') {
            const onlineRef = db.ref("onlineUsers");
            onlineRef.off("value", listener);
        }
    });
    
    connectionListeners.forEach(listener => {
        if (listener && typeof listener === 'function') {
            const connectedRef = db.ref(".info/connected");
            connectedRef.off("value", listener);
        }
    });
    
    // ØªÙØ±ÙŠØº Ø§Ù„Ù…ØµÙÙˆÙØ§Øª
    messageListeners = [];
    typingListeners = [];
    onlineListeners = [];
    connectionListeners = [];
}

// ===== LOGOUT FUNCTION =====
function logout() {
    if (!username) return;
    
    // ØªÙ†Ø¸ÙŠÙ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const onlineRef = db.ref("onlineUsers/" + encodeURIComponent(username));
    onlineRef.remove();
    
    const typingRef = db.ref("typing/" + encodeURIComponent(username));
    typingRef.remove();
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
    cleanupListeners();
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
    username = "";
    lastMessageKey = null;
    isScrolledUp = false;
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶
    chatScreen.style.display = "none";
    loginScreen.style.display = "flex";
    usernameInput.value = "";
    messages.innerHTML = '<div class="loading">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</div>';
}

// ===== PAGE VISIBILITY =====
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        // Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± Ù…Ø±Ø¦ÙŠØ©
        if (username) {
            const typingRef = db.ref("typing/" + encodeURIComponent(username));
            typingRef.remove();
        }
    }
});

// ===== BEFORE UNLOAD =====
window.addEventListener('beforeunload', () => {
    logout();
});

// ===== INITIAL FOCUS =====
window.onload = () => {
    usernameInput.focus();
    
    // ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù‡Ø§ØªÙ
    if ('ontouchstart' in window) {
        document.body.classList.add('touch-device');
    }
};
</script>

</body>
</html>
