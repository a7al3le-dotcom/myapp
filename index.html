<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>public-room</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: 'Tajawal', sans-serif;
    background: #020617;
    color: #e5e7eb;
  }

  /* الهيدر */
  .header {
    height: 55px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 0 15px;
    position: sticky;
    top: 0;
    z-index: 20;
    background: rgba(2,6,23,0.8);
    backdrop-filter: blur(6px);
  }

  .online-pill {
    padding: 8px 14px;
    border-radius: 999px;
    background: #1e293b;
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-size: 14px;
  }
  .online-dot {
    width: 8px;
    height: 8px;
    background: #22c55e;
    border-radius: 999px;
  }

  /* المشغل */
  #player-wrapper {
    width: 800px;
    max-width: 100%;
    margin: 20px auto;
  }
  #player-container {
    width: 100%;
    aspect-ratio: 16/9;
  }
  video, iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: block;
  }

  /* أزرار التشغيل */
  #controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 10px auto;
  }
  #url-input {
    padding: 8px;
    border-radius: 6px;
    border: none;
    background: #1e293b;
    color: white;
    width: 250px;
  }
  #load-btn, #file-btn {
    background: none;
    border: 1px solid #6366f1;
    color: #6366f1;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
  }

  #twitter-selector {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin-top: 5px;
  }
  #twitter-selector button {
    background: none;
    border: 1px solid #334155;
    color: white;
    padding: 4px 8px;
    border-radius: 6px;
    cursor: pointer;
  }
  #twitter-selector button.active {
    border-color: #6366f1;
    color: #6366f1;
  }

  /* الدردشة */
  .chat {
    padding: 15px;
    height: calc(100vh - 55px - 350px);
    overflow-y: auto;
  }
  .message {
    margin-bottom: 12px;
    font-size: 15px;
  }
  .name {
    font-weight: bold;
    color: #93c5fd;
  }
  .timestamp {
    color: #64748b;
    font-size: 12px;
    margin-right: 6px;
  }

  /* مربع الإدخال */
  .input-area {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(2,6,23,0.9);
    padding: 10px;
    display: flex;
    gap: 10px;
  }
  .input-area input {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: none;
    background: #1e293b;
    color: white;
  }
  .input-area button {
    padding: 10px 16px;
    border-radius: 8px;
    border: none;
    background: #6366f1;
    color: white;
    cursor: pointer;
  }

  /* نافذة المتواجدين */
  #membersOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    display: none;
  }
  #membersPanel {
    position: absolute;
    top: 0;
    right: -50%;
    width: 50%;
    max-width: 320px;
    height: 100%;
    background: #0f172a;
    padding: 20px;
    transition: 0.25s ease;
    overflow-y: auto;
  }
  #membersPanel.open {
    right: 0;
  }

  .member {
    padding: 8px 0;
    border-bottom: 1px solid #1e293b;
  }
</style>
</head>
<body>

<div class="header">
  <div class="online-pill" id="openMembers">
    <div class="online-dot"></div>
    <span id="onlineText">0 متواجد الآن</span>
  </div>
</div>

<div id="player-wrapper">
  <div id="player-container">
    <video id="video-element" controls autoplay muted></video>
  </div>
</div>

<div id="controls">
  <input id="url-input" type="text" placeholder="رابط فيديو">
  <button id="load-btn">تشغيل</button>
  <input id="file-input" type="file" accept="video/*" style="display:none;">
  <button id="file-btn">رفع ملف</button>
</div>

<div id="twitter-selector"></div>

<div class="chat" id="messages"></div>

<div class="input-area">
  <input id="chatInput" type="text" placeholder="اكتب رسالة...">
  <button id="sendChat">إرسال</button>
</div>

<div id="membersOverlay">
  <div id="membersPanel">
    <h3>المتواجدون الآن</h3>
    <div id="membersList"></div>
  </div>
</div>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB1AsEHXP05nQ8M66jYPusheLaE60q_JwU",
  authDomain: "mychat-2d881.firebaseapp.com",
  databaseURL: "https://mychat-2d881-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const ROOM = "public-room";

/* ===== المتواجدون ===== */
const openMembers = document.getElementById("openMembers");
const membersOverlay = document.getElementById("membersOverlay");
const membersPanel = document.getElementById("membersPanel");

openMembers.onclick = () => {
  membersOverlay.style.display = "block";
  setTimeout(() => membersPanel.classList.add("open"), 10);
};
membersOverlay.onclick = e => {
  if (e.target === membersOverlay) {
    membersPanel.classList.remove("open");
    setTimeout(() => membersOverlay.style.display = "none", 200);
  }
};

const presenceRef = db.ref(`rooms/${ROOM}/presence`);
const connectedRef = db.ref(".info/connected");
let myPresence = presenceRef.push();
let myName = "مستخدم";

connectedRef.on("value", snap => {
  if (snap.val() === true) {
    myPresence.onDisconnect().remove();
    myPresence.set({ name: myName, ts: Date.now() });
  }
});

presenceRef.on("value", snap => {
  document.getElementById("onlineText").textContent =
    snap.numChildren() + " متواجد الآن";

  const list = document.getElementById("membersList");
  list.innerHTML = "";
  snap.forEach(child => {
    const v = child.val();
    list.innerHTML += `<div class="member">${v.name}</div>`;
  });
});

/* ===== الدردشة ===== */
const messages = document.getElementById("messages");
const chatInput = document.getElementById("chatInput");
const sendChat = document.getElementById("sendChat");
const chatRef = db.ref(`rooms/${ROOM}/chat`);

sendChat.onclick = () => {
  const text = chatInput.value.trim();
  if (!text) return;
  chatRef.push({ name: myName, text, ts: Date.now() });
  chatInput.value = "";
};

chatRef.on("child_added", snap => {
  const v = snap.val();
  messages.innerHTML += `
    <div class="message">
      <span class="name">${v.name}</span>
      <span class="timestamp">${new Date(v.ts).toLocaleTimeString()}</span>
      <div>${v.text}</div>
    </div>
  `;
  messages.scrollTop = messages.scrollHeight;
});

/* ===== المشغل ===== */
const videoEl = document.getElementById("video-element");
const urlInput = document.getElementById("url-input");
const loadBtn = document.getElementById("load-btn");
const fileBtn = document.getElementById("file-btn");
const fileInput = document.getElementById("file-input");
const twitterSelector = document.getElementById("twitter-selector");

function isYouTube(url){ return /youtube\.com|youtu\.be/.test(url); }
function getYouTubeID(url){ const m=url.match(/(?:v=|\/)([a-zA-Z0-9_-]{11})/); return m?m[1]:null; }
function isTwitter(url){ return /twitter\.com|x\.com/.test(url); }
function isDirect(url){ return /\.(mp4|webm|ogg)$/i.test(url); }
function isM3U8(url){ return /\.m3u8$/i.test(url); }

loadBtn.onclick = async () => {
  const url = urlInput.value.trim();
  if (!url) return;

  videoEl.src = "";
  twitterSelector.innerHTML = "";

  if (isYouTube(url)) {
    const id = getYouTubeID(url);
    videoEl.outerHTML = `
      <iframe width="100%" height="100%" src="https://www.youtube.com/embed/${id}?autoplay=1&mute=1"></iframe>
    `;
    return;
  }

  if (isDirect(url)) {
    videoEl.src = url;
    videoEl.play();
    return;
  }

  if (isM3U8(url)) {
    if (Hls.isSupported()) {
      const hls = new Hls();
      hls.loadSource(url);
      hls.attachMedia(videoEl);
      videoEl.play();
    }
    return;
  }

  if (isTwitter(url)) {
    const id = url.match(/status\/(\d+)/)[1];
    const res = await fetch(`https://api.vxtwitter.com/i/status/${id}`);
    const data = await res.json();

    data.media_extended.forEach((m,i)=>{
      const btn = document.createElement("button");
      btn.textContent = "مقطع " + (i+1);
      btn.onclick = () => {
        twitterSelector.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        videoEl.src = m.url;
        videoEl.play();
      };
      twitterSelector.appendChild(btn);
    });

    twitterSelector.querySelector("button").click();
  }
};

fileBtn.onclick = ()=>fileInput.click();
fileInput.onchange = ()=>{
  const file = fileInput.files[0];
  if (!file) return;
  videoEl.src = URL.createObjectURL(file);
  videoEl.play();
};
</script>

</body>
</html>
