<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ø´Ø§Øª Ø®Ø§Øµ Ù…Ø¹ Ù…Ø´ØºÙ„ ÙˆØ³Ø§Ø¦Ø·</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
body{background:#36393f;color:#fff;height:100vh;overflow:hidden;touch-action:pan-y}

/* ===== LOGIN ===== */
#loginScreen{
    height:100vh;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    padding:20px;
    background: linear-gradient(135deg, #36393f 0%, #2f3136 100%);
}
#loginContainer{
    background:#2f3136;
    padding:30px;
    border-radius:12px;
    box-shadow:0 8px 32px rgba(0,0,0,0.3);
    width:100%;
    max-width:400px;
}
#loginScreen h2{
    margin-bottom:20px;
    text-align:center;
    color:#7289da;
}
#loginScreen input{
    padding:12px 15px;
    margin-bottom:15px;
    width:100%;
    border:2px solid #40444b;
    border-radius:8px;
    background:#40444b;
    color:#fff;
    font-size:16px;
}
#loginScreen input:focus{
    outline:none;
    border-color:#7289da;
}
#loginScreen button{
    padding:12px 20px;
    width:100%;
    background:#7289da;
    color:#fff;
    border:none;
    border-radius:8px;
    font-size:16px;
    font-weight:bold;
    cursor:pointer;
    transition:background 0.3s;
}
#loginScreen button:hover{
    background:#5f73bc;
}
#loginScreen button:active{
    transform:scale(0.98);
}

/* ===== MEDIA PLAYER ===== */
#mediaPlayerContainer {
    position: fixed;
    top: 60px;
    left: 0;
    right: 0;
    z-index: 19;
    background: rgba(32, 34, 37, 0.95);
    border-bottom: 2px solid #7289da;
    backdrop-filter: blur(10px);
    transform: translateY(-100%);
    transition: transform 0.3s ease;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}

#mediaPlayerContainer.visible {
    transform: translateY(0);
}

#mediaPlayer {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    gap: 15px;
    max-width: 1200px;
    margin: 0 auto;
}

#playerToggleBtn {
    background: #7289da;
    color: white;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.3s;
    flex-shrink: 0;
}

#playerToggleBtn:hover {
    background: #5f73bc;
    transform: scale(1.05);
}

#playerToggleBtn:active {
    transform: scale(0.95);
}

#playerToggleBtn.pinned {
    background: #43b581;
}

#nowPlaying {
    flex: 1;
    min-width: 0;
    overflow: hidden;
}

#nowPlaying h4 {
    color: #7289da;
    margin-bottom: 5px;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

#trackInfo {
    font-size: 13px;
    color: #b9bbbe;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

#playerControls {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
}

.playerBtn {
    background: #40444b;
    border: none;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.2s;
}

.playerBtn:hover {
    background: #7289da;
    transform: scale(1.05);
}

.playerBtn:active {
    transform: scale(0.95);
}

.playerBtn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.playerBtn.disabled:hover {
    background: #40444b;
    transform: none;
}

#progressContainer {
    flex: 2;
    min-width: 150px;
    max-width: 300px;
    display: flex;
    align-items: center;
    gap: 10px;
}

#progressBar {
    flex: 1;
    height: 6px;
    background: #202225;
    border-radius: 3px;
    overflow: hidden;
    cursor: pointer;
}

#progress {
    height: 100%;
    background: #7289da;
    width: 0%;
    transition: width 0.1s;
    border-radius: 3px;
}

#timeDisplay {
    font-size: 12px;
    color: #b9bbbe;
    min-width: 80px;
    text-align: center;
}

#volumeContainer {
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 120px;
}

#volumeIcon {
    color: #7289da;
    font-size: 16px;
    min-width: 20px;
}

#volumeSlider {
    flex: 1;
    height: 4px;
    background: #202225;
    border-radius: 2px;
    outline: none;
    -webkit-appearance: none;
}

#volumeSlider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    background: #7289da;
    border-radius: 50%;
    cursor: pointer;
}

#volumeSlider::-moz-range-thumb {
    width: 14px;
    height: 14px;
    background: #7289da;
    border-radius: 50%;
    cursor: pointer;
    border: none;
}

#mediaElement {
    display: none;
}

/* ===== CHAT ===== */
#chatScreen{display:none;height:100vh}

/* ===== TOP BAR ===== */
#topBar{
    position:fixed;
    top:0;
    width:100%;
    background:#2f3136;
    padding:12px 16px;
    font-size:14px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    z-index:20;
    border-bottom:1px solid #202225;
    height:60px;
}
#myStatus{
    color:#43b581;
    font-weight:bold;
}
#onlineBtn{
    cursor:pointer;
    color:#9aff9a;
    background:#202225;
    padding:6px 12px;
    border-radius:6px;
    font-size:13px;
    transition:background 0.3s;
}
#onlineBtn:active{
    background:#36393f;
}

/* ===== POPUP ===== */
#overlay{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.7);
    display:none;
    z-index:30;
    animation:fadeIn 0.3s;
}
@keyframes fadeIn{
    from{opacity:0} to{opacity:1}
}
#onlinePopup{
    background:#2f3136;
    width:90%;
    max-width:300px;
    max-height:80vh;
    overflow-y:auto;
    padding:16px;
    border-radius:12px;
    position:absolute;
    top:70px;
    right:5%;
    border:1px solid #202225;
    box-shadow:0 4px 20px rgba(0,0,0,0.5);
}
#onlinePopup h4{
    margin-bottom:12px;
    font-size:16px;
    text-align:center;
    color:#7289da;
    padding-bottom:8px;
    border-bottom:1px solid #40444b;
}
.user{
    font-size:14px;
    margin-bottom:8px;
    padding:6px 10px;
    border-radius:6px;
    transition:background 0.2s;
}
.user:hover{
    background:#40444b;
}
.user.you{
    background:rgba(114,137,218,0.2);
    border-right:3px solid #7289da;
}

/* ===== MESSAGES ===== */
.messages{
    position:absolute;
    top:60px;
    bottom:110px;
    width:100%;
    overflow-y:auto;
    padding:10px;
    display:flex;
    flex-direction:column-reverse;
    scroll-behavior:smooth;
}

/* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‡Ø§Ù…Ø´ Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…Ø´ØºÙ„ */
.messages.with-player {
    top: 110px; /* 60px Ù„Ù„Ø¨Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ + 50px Ù„Ù„Ù…Ø´ØºÙ„ */
}

.messages::-webkit-scrollbar{width:6px}
.messages::-webkit-scrollbar-track{background:#2f3136}
.messages::-webkit-scrollbar-thumb{background:#7289da;border-radius:3px}
.messages::-webkit-scrollbar-thumb:hover{background:#5f73bc}

.message{
    margin-bottom:16px;
    padding:8px 12px;
    border-radius:8px;
    animation:fadeInUp 0.3s;
    max-width:85%;
    word-wrap:break-word;
}
@keyframes fadeInUp{
    from{opacity:0;transform:translateY(10px)}
    to{opacity:1;transform:translateY(0)}
}
.message.mine{
    background:rgba(114,137,218,0.15);
    align-self:flex-end;
    margin-left:auto;
    margin-right:0;
}
.message.other{
    background:rgba(79,84,92,0.15);
    align-self:flex-start;
    margin-left:0;
    margin-right:auto;
}
.name{
    font-weight:bold;
    font-size:14px;
    margin-bottom:4px;
    color:#7289da;
}
.message.other .name{
    color:#43b581;
}
.text{
    margin-top:4px;
    font-size:15px;
    line-height:1.4;
}
.time{
    font-size:11px;
    color:#aaa;
    margin-top:6px;
    text-align:left;
    direction:ltr;
}
.video iframe, .video video{
    width:100%;
    max-width:560px;
    height:315px;
    margin-top:8px;
    border-radius:8px;
    border:none;
}
.image img{
    max-width:100%;
    max-height:400px;
    border-radius:8px;
    margin-top:8px;
    display:block;
}

/* Ø²Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
.media-play-btn {
    background: #7289da;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    margin-top: 5px;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    transition: all 0.2s;
}

.media-play-btn:hover {
    background: #5f73bc;
    transform: scale(1.05);
}

.media-play-btn:active {
    transform: scale(0.95);
}

/* ===== TYPING ===== */
#typingStatus{
    position:fixed;
    bottom:70px;
    padding:8px 16px;
    font-size:13px;
    color:#aaa;
    background:#2f3136;
    border-radius:20px;
    margin:0 16px;
    right:0;
    animation:fadeIn 0.3s;
    border:1px solid #40444b;
}

/* ===== INPUT ===== */
.input-box{
    position:fixed;
    bottom:0;
    width:100%;
    background:#2f3136;
    border-top:1px solid #202225;
    padding:8px 0;
}
.input-row{
    display:flex;
    padding:0 8px;
    gap:8px;
}
.input-row input{
    flex:1;
    border:none;
    padding:12px 16px;
    border-radius:25px;
    background:#40444b;
    color:#fff;
    font-size:15px;
    min-height:44px;
}
.input-row input:focus{
    outline:none;
}
.input-row button{
    border:none;
    border-radius:50%;
    width:44px;
    height:44px;
    background:#7289da;
    color:#fff;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:background 0.3s;
    font-size:18px;
}
.input-row button:active{
    background:#5f73bc;
    transform:scale(0.95);
}

/* ===== CONNECTION STATUS ===== */
#connectionStatus{
    position:fixed;
    top:60px;
    width:100%;
    background:#faa81a;
    color:#000;
    text-align:center;
    padding:10px;
    font-size:14px;
    z-index:15;
    display:none;
    font-weight:bold;
}

/* ===== LOADING ===== */
.loading{
    text-align:center;
    padding:20px;
    color:#aaa;
    font-size:14px;
}

/* ===== MEDIA QUERIES Ù„Ù„Ù‡ÙˆØ§ØªÙ ===== */
@media (max-width: 768px){
    #loginContainer{
        padding:20px;
        margin:10px;
    }
    
    .message{
        max-width:90%;
        padding:10px;
    }
    
    .video iframe, .video video{
        height:200px;
    }
    
    #onlinePopup{
        width:95%;
        right:2.5%;
    }
    
    .input-row{
        padding:0 12px;
    }
    
    .messages{
        padding:12px;
    }
    
    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø´ØºÙ„ Ù„Ù„Ù‡ÙˆØ§ØªÙ */
    #mediaPlayer {
        flex-wrap: wrap;
        padding: 8px;
        gap: 8px;
    }
    
    #progressContainer {
        order: 3;
        max-width: none;
        min-width: 100%;
        margin-top: 5px;
    }
    
    #volumeContainer {
        min-width: 100px;
    }
    
    .messages.with-player {
        top: 120px;
    }
}

@media (max-width: 480px){
    #topBar{
        padding:10px;
        font-size:13px;
        height:55px;
    }
    
    .messages{
        top:55px;
        bottom:100px;
    }
    
    .messages.with-player {
        top: 115px;
    }
    
    .input-row input{
        font-size:14px;
        padding:10px 14px;
    }
    
    .video iframe, .video video{
        height:180px;
    }
    
    .message{
        max-width:95%;
    }
    
    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø´ØºÙ„ Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
    #mediaPlayer {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
    }
    
    #nowPlaying {
        text-align: center;
    }
    
    #playerControls {
        justify-content: center;
    }
    
    #progressContainer {
        order: 0;
    }
    
    #volumeContainer {
        min-width: 100%;
        justify-content: center;
    }
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù„ÙˆØ­ÙŠØ© */
@media (min-width: 769px) and (max-width: 1024px){
    .messages{
        padding:20px;
        max-width:800px;
        margin:0 auto;
    }
    
    .message{
        max-width:80%;
    }
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen">
    <div id="loginContainer">
        <h2>ğŸ’¬ Ø´Ø§Øª Ø®Ø§Øµ Ù…Ø¹ Ù…Ø´ØºÙ„ ÙˆØ³Ø§Ø¦Ø·</h2>
        <input id="usernameInput" placeholder="Ø§Ø³Ù…Ùƒ (Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)" autocomplete="off">
        <button onclick="login()" id="loginBtn">Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Øª</button>
    </div>
</div>

<!-- CHAT -->
<div id="chatScreen">
    <!-- MEDIA PLAYER -->
    <div id="mediaPlayerContainer">
        <div id="mediaPlayer">
            <button id="playerToggleBtn" title="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø´ØºÙ„">ğŸµ</button>
            
            <div id="nowPlaying">
                <h4 id="currentTrackTitle">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØ³Ø§Ø¦Ø· Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„</h4>
                <div id="trackInfo">Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ´ØºÙŠÙ„</div>
            </div>
            
            <div id="playerControls">
                <button id="prevBtn" class="playerBtn disabled" title="Ø§Ù„Ø³Ø§Ø¨Ù‚">â®</button>
                <button id="playPauseBtn" class="playerBtn" title="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù">â–¶</button>
                <button id="nextBtn" class="playerBtn disabled" title="Ø§Ù„ØªØ§Ù„ÙŠ">â­</button>
            </div>
            
            <div id="progressContainer">
                <div id="progressBar">
                    <div id="progress"></div>
                </div>
                <div id="timeDisplay">00:00 / 00:00</div>
            </div>
            
            <div id="volumeContainer">
                <span id="volumeIcon">ğŸ”Š</span>
                <input type="range" id="volumeSlider" min="0" max="100" value="80" title="Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª">
            </div>
        </div>
    </div>
    
    <audio id="mediaElement" preload="metadata"></audio>

    <!-- TOP BAR -->
    <div id="topBar">
        <span id="myStatus">ğŸŸ¢ Ù…ØªØµÙ„</span>
        <span id="onlineBtn">ğŸ‘¥ Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† (<span id="onlineCount">0</span>)</span>
    </div>

    <!-- CONNECTION STATUS -->
    <div id="connectionStatus">ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...</div>

    <!-- POPUP -->
    <div id="overlay" onclick="closePopup()">
        <div id="onlinePopup" onclick="event.stopPropagation()">
            <h4>ğŸ‘¥ Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø§Ù„Ø¢Ù†</h4>
            <div id="onlineUsersList"></div>
        </div>
    </div>

    <!-- CHAT -->
    <div class="messages" id="messages">
        <div class="loading">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</div>
    </div>
    <div id="typingStatus"></div>

    <!-- INPUT -->
    <div class="input-box">
        <div class="input-row">
            <input id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø£Ùˆ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨/ØµÙˆØ±Ø©/ØµÙˆØªÙŠ/ÙÙŠØ¯ÙŠÙˆ" autocomplete="off">
            <button onclick="send()" id="sendBtn">â¤</button>
        </div>
    </div>

</div>

<script>
// ===== FIREBASE CONFIG =====
const firebaseConfig = {
    apiKey: "AIzaSyB1AsEHXP05nQ8M66jYPusheLaE60q_JwU",
    databaseURL: "https://mychat-2d881-default-rtdb.firebaseio.com"
};

// ===== INITIALIZATION =====
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== GLOBAL VARIABLES =====
let username = "";
let messageListeners = [];
let typingListeners = [];
let onlineListeners = [];
let connectionListeners = [];
let lastMessageKey = null;
let isScrolledUp = false;

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø´ØºÙ„
let currentPlaylist = [];
let currentTrackIndex = -1;
let isPlayerVisible = false;
let isPlayerPinned = false;
let lastPlayerState = null;

// ===== DOM ELEMENTS =====
const usernameInput = document.getElementById("usernameInput");
const loginScreen = document.getElementById("loginScreen");
const chatScreen = document.getElementById("chatScreen");
const messageInput = document.getElementById("messageInput");
const messages = document.getElementById("messages");
const typingStatus = document.getElementById("typingStatus");
const onlineCount = document.getElementById("onlineCount");
const onlineUsersList = document.getElementById("onlineUsersList");
const overlay = document.getElementById("overlay");
const onlineBtn = document.getElementById("onlineBtn");
const connectionStatus = document.getElementById("connectionStatus");
const loginBtn = document.getElementById("loginBtn");
const sendBtn = document.getElementById("sendBtn");

// Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø´ØºÙ„
const mediaPlayerContainer = document.getElementById("mediaPlayerContainer");
const playerToggleBtn = document.getElementById("playerToggleBtn");
const currentTrackTitle = document.getElementById("currentTrackTitle");
const trackInfo = document.getElementById("trackInfo");
const playPauseBtn = document.getElementById("playPauseBtn");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const progressBar = document.getElementById("progressBar");
const progress = document.getElementById("progress");
const timeDisplay = document.getElementById("timeDisplay");
const volumeSlider = document.getElementById("volumeSlider");
const volumeIcon = document.getElementById("volumeIcon");
const mediaElement = document.getElementById("mediaElement");

// ===== UTILITY FUNCTIONS =====
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString('ar-SA', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
    });
}

// Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª Ù…Ù† Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
function formatDuration(seconds) {
    if (!seconds || seconds < 0) return "00:00";
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// ===== MEDIA PLAYER FUNCTIONS =====
function togglePlayerVisibility() {
    isPlayerVisible = !isPlayerVisible;
    
    if (isPlayerVisible) {
        mediaPlayerContainer.classList.add('visible');
        messages.classList.add('with-player');
        if (!isPlayerPinned) {
            // Ø¥Ø®ÙØ§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø«Ø¨ØªØ§Ù‹
            setTimeout(() => {
                if (!isPlayerPinned && isPlayerVisible) {
                    hidePlayer();
                }
            }, 10000);
        }
    } else {
        hidePlayer();
    }
    
    updatePlayerToggleButton();
}

function hidePlayer() {
    isPlayerVisible = false;
    mediaPlayerContainer.classList.remove('visible');
    messages.classList.remove('with-player');
}

function togglePlayerPin() {
    isPlayerPinned = !isPlayerPinned;
    updatePlayerToggleButton();
    
    if (isPlayerPinned && !isPlayerVisible) {
        togglePlayerVisibility();
    }
}

function updatePlayerToggleButton() {
    playerToggleBtn.innerHTML = isPlayerPinned ? 'ğŸ“Œ' : 'ğŸµ';
    playerToggleBtn.title = isPlayerPinned ? 'Ø¥Ù„ØºØ§Ø¡ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…Ø´ØºÙ„' : 'Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø´ØºÙ„';
    playerToggleBtn.classList.toggle('pinned', isPlayerPinned);
}

function addToPlaylist(mediaData, userName) {
    if (!mediaData || !mediaData.id || !mediaData.type) return;
    
    const track = {
        id: mediaData.id,
        type: mediaData.type,
        title: `ÙˆØ³Ø§Ø¦Ø· Ù…Ù† ${userName}`,
        user: userName,
        url: mediaData.id,
        timestamp: Date.now()
    };
    
    currentPlaylist.push(track);
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø´ØºÙ„ Ù…Ø®ÙÙŠØŒ Ø¥Ø¸Ù‡Ø§Ø±Ù‡ Ù…Ø¤Ù‚ØªØ§Ù‹
    if (!isPlayerVisible && currentPlaylist.length === 1) {
        togglePlayerVisibility();
    }
    
    // ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø´ÙŠØ¡ ÙŠØ¹Ù…Ù„
    if (currentTrackIndex === -1 && currentPlaylist.length === 1) {
        playTrack(0);
    }
    
    updatePlaylistControls();
}

function playTrack(index) {
    if (index < 0 || index >= currentPlaylist.length) return;
    
    const track = currentPlaylist[index];
    currentTrackIndex = index;
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¹Ù†ØµØ± Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
    if (track.type === 'file' || track.type === 'audio') {
        mediaElement.src = track.url;
        mediaElement.type = 'audio/mpeg';
        currentTrackTitle.textContent = `ğŸµ ${escapeHtml(track.title)}`;
        trackInfo.textContent = `Ø¨ÙˆØ§Ø³Ø·Ø© ${escapeHtml(track.user)}`;
    }
    
    // ØªØ´ØºÙŠÙ„
    mediaElement.play().then(() => {
        playPauseBtn.innerHTML = 'â¸';
        playPauseBtn.title = 'Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø´ØºÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø®ÙÙŠØ§Ù‹
        if (!isPlayerVisible) {
            togglePlayerVisibility();
        }
    }).catch(error => {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„:', error);
    });
    
    updatePlaylistControls();
}

function playPause() {
    if (mediaElement.src) {
        if (mediaElement.paused) {
            mediaElement.play();
            playPauseBtn.innerHTML = 'â¸';
            playPauseBtn.title = 'Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
        } else {
            mediaElement.pause();
            playPauseBtn.innerHTML = 'â–¶';
            playPauseBtn.title = 'ØªØ´ØºÙŠÙ„';
        }
    }
}

function nextTrack() {
    if (currentPlaylist.length === 0) return;
    const nextIndex = (currentTrackIndex + 1) % currentPlaylist.length;
    playTrack(nextIndex);
}

function prevTrack() {
    if (currentPlaylist.length === 0) return;
    const prevIndex = currentTrackIndex > 0 ? currentTrackIndex - 1 : currentPlaylist.length - 1;
    playTrack(prevIndex);
}

function updatePlaylistControls() {
    prevBtn.classList.toggle('disabled', currentPlaylist.length <= 1);
    nextBtn.classList.toggle('disabled', currentPlaylist.length <= 1);
}

function updateProgress() {
    if (!mediaElement.src) return;
    
    const currentTime = mediaElement.currentTime;
    const duration = mediaElement.duration || 0;
    
    // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
    const progressPercent = duration > 0 ? (currentTime / duration) * 100 : 0;
    progress.style.width = `${progressPercent}%`;
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙˆÙ‚Øª
    timeDisplay.textContent = `${formatDuration(currentTime)} / ${formatDuration(duration)}`;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
    const volume = mediaElement.volume * 100;
    if (volume === 0) {
        volumeIcon.textContent = 'ğŸ”‡';
    } else if (volume < 50) {
        volumeIcon.textContent = 'ğŸ”‰';
    } else {
        volumeIcon.textContent = 'ğŸ”Š';
    }
}

// ===== EVENT LISTENERS Ù„Ù„Ù…Ø´ØºÙ„ =====
playerToggleBtn.addEventListener('click', (e) => {
    if (e.shiftKey) {
        // Shift + Ø²Ø± Ø§Ù„Ù…Ø´ØºÙ„ Ù„Ù„ØªØ«Ø¨ÙŠØª
        togglePlayerPin();
    } else {
        togglePlayerVisibility();
    }
});

playPauseBtn.addEventListener('click', playPause);
prevBtn.addEventListener('click', prevTrack);
nextBtn.addEventListener('click', nextTrack);

progressBar.addEventListener('click', (e) => {
    if (!mediaElement.src || !mediaElement.duration) return;
    
    const rect = progressBar.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    mediaElement.currentTime = percent * mediaElement.duration;
});

volumeSlider.addEventListener('input', (e) => {
    const volume = e.target.value / 100;
    mediaElement.volume = volume;
});

mediaElement.addEventListener('timeupdate', updateProgress);
mediaElement.addEventListener('loadedmetadata', updateProgress);

mediaElement.addEventListener('ended', () => {
    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø¹Ù†ØµØ± Ø§Ù„ØªØ§Ù„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
    if (currentPlaylist.length > 1) {
        nextTrack();
    } else {
        playPauseBtn.innerHTML = 'â–¶';
        playPauseBtn.title = 'ØªØ´ØºÙŠÙ„';
    }
});

mediaElement.addEventListener('error', (e) => {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·:', e);
    currentTrackTitle.textContent = 'Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·';
    trackInfo.textContent = 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù';
});

// ===== LOGIN FUNCTION =====
function login() {
    const rawUsername = usernameInput.value.trim();
    
    if (!rawUsername || rawUsername.length < 2) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ­ÙŠØ­ (Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)");
        return;
    }
    
    if (rawUsername.length > 20) {
        alert("Ø§Ù„Ø§Ø³Ù… Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹ (20 Ø­Ø±Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)");
        return;
    }
    
    username = escapeHtml(rawUsername);
    
    loginScreen.style.display = "none";
    chatScreen.style.display = "block";
    
    loadMessages();
    setupConnection();
    
    setTimeout(() => {
        messageInput.focus();
    }, 300);
}

// ===== CONNECTION MANAGEMENT =====
function setupConnection() {
    const connectedRef = db.ref(".info/connected");
    const connectionListener = connectedRef.on("value", (snap) => {
        if (snap.val()) {
            connectionStatus.style.display = "none";
            
            const onlineRef = db.ref("onlineUsers/" + encodeURIComponent(username));
            onlineRef.set({
                name: username,
                status: "online",
                lastActive: Date.now()
            });
            
            onlineRef.onDisconnect().remove();
            
            const typingRef = db.ref("typing/" + encodeURIComponent(username));
            typingRef.onDisconnect().remove();
            
            connectionListeners.push(connectionListener);
        } else {
            connectionStatus.style.display = "block";
        }
    });
    
    setupOnlineUsers();
    setupTyping();
}

// ===== MESSAGES MANAGEMENT =====
function loadMessages() {
    cleanupListeners();
    
    const chatRef = db.ref("messages");
    
    const messageListener = chatRef.limitToLast(30).on("child_added", (snap) => {
        const data = snap.val();
        if (!data) return;
        
        lastMessageKey = snap.key;
        renderMessage(data);
    });
    
    messageListeners.push(messageListener);
}

function renderMessage(data) {
    const isMine = data.user === username;
    const messageClass = isMine ? "message mine" : "message other";
    
    const div = document.createElement("div");
    div.className = messageClass;
    
    // Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    div.innerHTML = `<div class="name">${escapeHtml(data.user)}</div>`;
    
    // Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    div.innerHTML += `<div class="text">${escapeHtml(data.text)}</div>`;
    
    // Ø§Ù„ÙˆÙ‚Øª
    div.innerHTML += `<div class="time">${formatTime(data.time)}</div>`;
    
    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
    if (data.mediaType === "youtube") {
        div.innerHTML += `<div class="video">
            <iframe 
                src="https://www.youtube.com/embed/${escapeHtml(data.mediaId)}" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen>
            </iframe>
        </div>`;
    } else if (data.mediaType === "file") {
        div.innerHTML += `<div class="video">
            <video controls src="${escapeHtml(data.mediaId)}"></video>
            <button class="media-play-btn" onclick="addToPlaylist(${JSON.stringify({id: data.mediaId, type: 'file'})}, '${escapeHtml(data.user)}')">
                â• Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø´ØºÙ„
            </button>
        </div>`;
    } else if (data.mediaType === "image") {
        div.innerHTML += `<div class="image">
            <img 
                src="${escapeHtml(data.mediaId)}" 
                alt="ØµÙˆØ±Ø©" 
                loading="lazy"
                onerror="this.style.display='none'">
        </div>`;
    } else if (data.mediaType === "audio") {
        div.innerHTML += `<div class="audio">
            <audio controls src="${escapeHtml(data.mediaId)}"></audio>
            <button class="media-play-btn" onclick="addToPlaylist(${JSON.stringify({id: data.mediaId, type: 'audio'})}, '${escapeHtml(data.user)}')">
                â• Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø´ØºÙ„
            </button>
        </div>`;
    }
    
    const loadingElement = messages.querySelector('.loading');
    if (loadingElement) {
        loadingElement.remove();
    }
    
    messages.insertBefore(div, messages.firstChild);
    
    if (!isScrolledUp) {
        setTimeout(() => {
            messages.scrollTop = 0;
        }, 100);
    }
}

// ===== SEND MESSAGE =====
function extractMedia(text) {
    // ÙŠÙˆØªÙŠÙˆØ¨
    const yt = text.match(/(?:youtube\.com\/.*[?&]v=|youtu\.be\/)([A-Za-z0-9_-]{11})/);
    if (yt) return { type: "youtube", id: yt[1] };
    
    // ÙÙŠØ¯ÙŠÙˆ
    const video = text.match(/https?:\/\/\S+\.(mp4|webm|ogg|mov|avi|wmv)/i);
    if (video) return { type: "file", id: video[0] };
    
    // ØµÙˆØª
    const audio = text.match(/https?:\/\/\S+\.(mp3|wav|ogg|m4a|flac)/i);
    if (audio) return { type: "audio", id: audio[0] };
    
    // ØµÙˆØ±
    const img = text.match(/https?:\/\/\S+\.(jpg|jpeg|png|gif|webp|bmp)/i);
    if (img) return { type: "image", id: img[0] };
    
    return null;
}

function send() {
    const text = messageInput.value.trim();
    if (!text || !username) return;
    
    const media = extractMedia(text);
    
    const chatRef = db.ref("messages");
    chatRef.push({
        user: username,
        text: text,
        mediaType: media ? media.type : null,
        mediaId: media ? media.id : null,
        time: Date.now()
    });
    
    messageInput.value = "";
    
    const typingRef = db.ref("typing/" + encodeURIComponent(username));
    typingRef.remove();
    
    messageInput.focus();
}

// ===== TYPING MANAGEMENT =====
function setupTyping() {
    const typingRef = db.ref("typing");
    
    messageInput.addEventListener("input", () => {
        if (!username) return;
        
        const userTypingRef = db.ref("typing/" + encodeURIComponent(username));
        userTypingRef.set(Date.now());
        
        clearTimeout(window.typingTimeout);
        window.typingTimeout = setTimeout(() => {
            userTypingRef.remove();
        }, 2000);
    });
    
    const typingListener = typingRef.on("value", (snap) => {
        const data = snap.val() || {};
        const now = Date.now();
        
        const activeTyping = Object.keys(data).filter(key => {
            const user = decodeURIComponent(key);
            return user !== username && (now - data[key] < 2000);
        });
        
        if (activeTyping.length === 0) {
            typingStatus.textContent = "";
        } else {
            const names = activeTyping.map(key => decodeURIComponent(key));
            if (names.length === 1) {
                typingStatus.textContent = `${names[0]} ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†...`;
            } else {
                typingStatus.textContent = `${names.length} Ø£Ø´Ø®Ø§Øµ ÙŠÙƒØªØ¨ÙˆÙ† Ø§Ù„Ø¢Ù†...`;
            }
        }
    });
    
    typingListeners.push(typingListener);
}

// ===== ONLINE USERS MANAGEMENT =====
function setupOnlineUsers() {
    const onlineRef = db.ref("onlineUsers");
    
    const onlineListener = onlineRef.on("value", (snap) => {
        const users = snap.val() || {};
        const userNames = Object.keys(users);
        
        onlineCount.textContent = userNames.length;
        
        onlineUsersList.innerHTML = userNames.map(key => {
            const userData = users[key];
            const userName = userData.name || decodeURIComponent(key);
            const isYou = userName === username;
            
            return `<div class="user ${isYou ? 'you' : ''}">
                ğŸŸ¢ ${escapeHtml(userName)} ${isYou ? '(Ø£Ù†Øª)' : ''}
            </div>`;
        }).join('');
    });
    
    onlineListeners.push(onlineListener);
}

// ===== SCROLL MANAGEMENT =====
messages.addEventListener('scroll', () => {
    const scrollTop = messages.scrollTop;
    const scrollHeight = messages.scrollHeight;
    const clientHeight = messages.clientHeight;
    
    isScrolledUp = scrollTop < scrollHeight - clientHeight - 100;
});

// ===== POPUP MANAGEMENT =====
onlineBtn.onclick = () => {
    overlay.style.display = "block";
};

function closePopup() {
    overlay.style.display = "none";
}

// ===== KEYBOARD SHORTCUTS =====
messageInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        send();
    }
});

// Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù„Ù„Ù…Ø´ØºÙ„
document.addEventListener('keydown', (e) => {
    // Space Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„/Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù
    if (e.target === document.body && e.key === ' ') {
        e.preventDefault();
        if (mediaElement.src) {
            playPause();
        }
    }
    
    // Ctrl+Arrow Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØµÙˆØª
    if (e.ctrlKey) {
        if (e.key === 'ArrowUp') {
            e.preventDefault();
            volumeSlider.value = Math.min(100, parseInt(volumeSlider.value) + 10);
            volumeSlider.dispatchEvent(new Event('input'));
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            volumeSlider.value = Math.max(0, parseInt(volumeSlider.value) - 10);
            volumeSlider.dispatchEvent(new Event('input'));
        }
    }
});

// ===== MEMORY MANAGEMENT =====
function cleanupListeners() {
    messageListeners.forEach(listener => {
        if (listener && typeof listener === 'function') {
            const chatRef = db.ref("messages");
            chatRef.off("child_added", listener);
        }
    });
    
    typingListeners.forEach(listener => {
        if (listener && typeof listener === 'function') {
            const typingRef = db.ref("typing");
            typingRef.off("value", listener);
        }
    });
    
    onlineListeners.forEach(listener => {
        if (listener && typeof listener === 'function') {
            const onlineRef = db.ref("onlineUsers");
            onlineRef.off("value", listener);
        }
    });
    
    connectionListeners.forEach(listener => {
        if (listener && typeof listener === 'function') {
            const connectedRef = db.ref(".info/connected");
            connectedRef.off("value", listener);
        }
    });
    
    messageListeners = [];
    typingListeners = [];
    onlineListeners = [];
    connectionListeners = [];
}

// ===== LOGOUT FUNCTION =====
function logout() {
    if (!username) return;
    
    const onlineRef = db.ref("onlineUsers/" + encodeURIComponent(username));
    onlineRef.remove();
    
    const typingRef = db.ref("typing/" + encodeURIComponent(username));
    typingRef.remove();
    
    cleanupListeners();
    
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø´ØºÙ„
    mediaElement.pause();
    mediaElement.src = '';
    currentPlaylist = [];
    currentTrackIndex = -1;
    
    username = "";
    lastMessageKey = null;
    isScrolledUp = false;
    isPlayerVisible = false;
    isPlayerPinned = false;
    
    chatScreen.style.display = "none";
    loginScreen.style.display = "flex";
    usernameInput.value = "";
    messages.innerHTML = '<div class="loading">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</div>';
    mediaPlayerContainer.classList.remove('visible');
    messages.classList.remove('with-player');
    updatePlayerToggleButton();
}

// ===== PAGE VISIBILITY =====
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        if (username) {
            const typingRef = db.ref("typing/" + encodeURIComponent(username));
            typingRef.remove();
        }
        
        // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´ØºÙ„
        if (mediaElement.src) {
            lastPlayerState = {
                currentTime: mediaElement.currentTime,
                isPlaying: !mediaElement.paused
            };
            mediaElement.pause();
        }
    } else {
        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´ØºÙ„
        if (lastPlayerState && mediaElement.src) {
            mediaElement.currentTime = lastPlayerState.currentTime;
            if (lastPlayerState.isPlaying) {
                mediaElement.play();
            }
        }
    }
});

// ===== BEFORE UNLOAD =====
window.addEventListener('beforeunload', () => {
    logout();
});

// ===== INITIAL FOCUS =====
window.onload = () => {
    usernameInput.focus();
    
    if ('ontouchstart' in window) {
        document.body.classList.add('touch-device');
    }
    
    // ØªØ¹ÙŠÙŠÙ† Ø­Ø¬Ù… Ø§Ù„ØµÙˆØª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    mediaElement.volume = volumeSlider.value / 100;
};
</script>

</body>
</html>
