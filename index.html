<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø´Ø§Øª Ø®Ø§Øµ</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:tahoma}
body{background:#36393f;color:#fff;height:100vh;display:flex;flex-direction:column}

#loginScreen{
  flex:1;display:flex;flex-direction:column;
  justify-content:center;align-items:center
}

#chatScreen{display:none;flex:1;flex-direction:column}

#statusBar{
  padding:6px 10px;
  background:#2f3136;
  font-size:13px
}

.messages{
  flex:1;overflow-y:auto;
  padding:10px;margin-bottom:110px
}

.message{margin-bottom:10px}
.name{font-weight:bold;font-size:14px}
.text{margin-top:2px}

.video iframe,.video video{
  width:100%;max-width:560px;height:315px;
  margin-top:5px;border-radius:6px
}

.typing{
  font-size:13px;color:#aaa;
  padding:5px 10px;height:20px
}

.input-box{
  position:fixed;bottom:0;width:100%;
  background:#40444b
}

.input-row{
  display:flex;padding:8px
}

.input-row input{
  flex:1;border:none;padding:10px;border-radius:20px
}

.input-row button{
  margin-left:6px;border:none;border-radius:20px;
  padding:10px;background:#7289da;color:#fff
}

#onlineUsersList{
  padding:5px 10px;
  font-size:13px;color:#ccc;
  background:#2f3136
}
</style>
</head>

<body>

<div id="loginScreen">
  <input id="usernameInput" placeholder="Ø§Ø³Ù…Ùƒ">
  <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
</div>

<div id="chatScreen">

  <div id="statusBar">
    <span id="myStatus" style="color:#9aff9a">â— Ù…ØªØµÙ„</span>
    <span id="onlineCount" style="float:left;color:#aaa"></span>
  </div>

  <div id="onlineUsersList"></div>

  <div class="messages" id="messages"></div>
  <div class="typing" id="typingStatus"></div>

  <div class="input-box">
    <div class="input-row">
      <input id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø£Ùˆ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨">
      <button onclick="send()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>

</div>

<script>
// ================= FIREBASE =================
firebase.initializeApp({
  apiKey: "AIzaSyB1AsEHXP05nQ8M66jYPusheLaE60q_JwU",
  databaseURL: "https://mychat-2d881-default-rtdb.firebaseio.com"
});

const db = firebase.database();
const chatRef = db.ref("messages");
const typingRef = db.ref("typing");
const onlineRef = db.ref("onlineUsers");
const connectedRef = db.ref(".info/connected");

let username = "";

// ================= LOGIN =================
function login(){
  username = usernameInput.value.trim();
  if(!username) return;

  loginScreen.style.display="none";
  chatScreen.style.display="flex";

  connectedRef.on("value", snap=>{
    if(snap.val() === true){
      const userRef = onlineRef.child(username);

      userRef.set({
        status:"online",
        lastActive:Date.now()
      });

      userRef.onDisconnect().remove();
    }
  });
}

// ================= VIDEO DETECTION =================
function extractVideo(text){
  const yt = text.match(/(?:youtube\.com\/(?:watch\?v=|shorts\/)|youtu\.be\/)([A-Za-z0-9_-]{11})/);
  if(yt) return {type:"youtube", id:yt[1]};

  const mp4 = text.match(/https?:\/\/\S+\.(mp4|webm|ogg)/i);
  if(mp4) return {type:"file", id:mp4[0]};

  return null;
}

// ================= SEND MESSAGE =================
function send(){
  const txt = messageInput.value.trim();
  if(!txt) return;

  const video = extractVideo(txt);

  chatRef.push({
    user: username,
    text: txt,
    videoType: video ? video.type : null,
    videoId: video ? video.id : null,
    time: Date.now()
  });

  messageInput.value="";
  typingRef.child(username).remove();
  onlineRef.child(username).update({lastActive:Date.now()});
}

// ================= ENTER KEY =================
messageInput.addEventListener("keydown", e=>{
  if(e.key === "Enter"){
    e.preventDefault();
    send();
  }
});

// ================= TYPING =================
let typingTimeout;
messageInput.addEventListener("input", ()=>{
  typingRef.child(username).set(true);

  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=>{
    typingRef.child(username).remove();
  },1500);
});

typingRef.on("value", snap=>{
  const users = snap.val() || {};
  const names = Object.keys(users).filter(u=>u!==username);
  typingStatus.textContent = names.length ? `${names[0]} ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†...` : "";
});

// ================= ONLINE USERS =================
onlineRef.on("value", snap=>{
  const users = snap.val() || {};
  const names = Object.keys(users);

  onlineCount.textContent =
    names.length>1 ? `Ù…ØªØµÙ„ÙˆÙ† (${names.length})` : "Ø£Ù†Øª Ø§Ù„Ù…ØªØµÙ„ Ø§Ù„ÙˆØ­ÙŠØ¯";

  onlineUsersList.innerHTML = names.map(n=>{
    return n===username
      ? `ğŸŸ¢ <strong>${n} (Ø£Ù†Øª)</strong>`
      : `ğŸŸ¢ ${n}`;
  }).join("<br>");
});

// ================= RENDER MESSAGES =================
chatRef.limitToLast(50).on("child_added", snap=>{
  const d = snap.val();
  const div = document.createElement("div");
  div.className="message";

  div.innerHTML = `
    <div class="name">${d.user}</div>
    <div class="text">${d.text}</div>
  `;

  if(d.videoType==="youtube"){
    div.innerHTML += `
      <div class="video">
        <iframe src="https://www.youtube.com/embed/${d.videoId}" allowfullscreen></iframe>
      </div>`;
  }

  if(d.videoType==="file"){
    div.innerHTML += `
      <div class="video">
        <video controls src="${d.videoId}"></video>
      </div>`;
  }

  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
});
</script>

</body>
</html>
