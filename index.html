<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø´Ø§Øª Ø®Ø§Øµ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
  <script src="https://unpkg.com/videojs-youtube/dist/Youtube.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body { 
      height: 100%; 
      margin: 0; 
      padding: 0; 
      overflow: hidden; 
      background: #0f0f0f;
    }
    
    body { 
      font-family: 'Tajawal', sans-serif; 
      background: #0f0f0f;
      color: #ffffff;
      display: flex; 
      flex-direction: column; 
    }
    
    #chat-container { 
      display: flex; 
      flex-direction: column; 
      height: 100%; 
    }
    
    #messages { 
      flex: 1; 
      overflow-y: auto; 
      padding: 15px; 
      background: #0f0f0f;
      scroll-behavior: smooth; 
    }
    
    .msg { 
      margin: 8px 0; 
      display: flex; 
      gap: 10px; 
      align-items: center; 
      direction: ltr; 
      text-align: left; 
      font-size: 15px; 
      line-height: 1.4; 
    }
    
    .sys { 
      text-align: center; 
      color: #aaa;
      font-size: 12px; 
      margin: 10px auto; 
      font-style: italic; 
      background-color: #272727;
      padding: 4px 10px; 
      border-radius: 12px; 
      transition: opacity 0.5s; 
    }
    
    .user { 
      font-weight: bold; 
      color: #3ea6ff;
    }
    
    .time { 
      font-size: 11px; 
      color: #888; 
      min-width: 40px; 
    }
    
    #inputArea {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 8px;
      padding: 10px;
      background: #0f0f0f;
      border-top: 1px solid #272727;
    }

    #messageInput { 
      flex: 1; 
      font-size: 16px; 
      height: 45px;
      padding: 0 15px;
      border: 1px solid #303030;
      border-radius: 25px; 
      font-family: 'Tajawal', sans-serif; 
      background: #272727;
      color: #ffffff;
      box-sizing: border-box;
    }
    
    #messageInput:focus { 
      border-color: #3ea6ff;
      outline: none; 
    }
    
    #messageInput::placeholder {
      color: #888;
    }
    
    #sendBtn { 
      height: 45px;
      padding: 0 25px; 
      border: none; 
      border-radius: 25px; 
      background: #3ea6ff;
      color: white; 
      cursor: pointer; 
      font-family: 'Tajawal', sans-serif;
      display: flex; 
      align-items: center; 
      justify-content: center;
      box-sizing: border-box;
      font-weight: 500;
    }

    #sendBtn:hover { 
      background: #2d8ad9;
    }
    
    #topButtons { 
      position: fixed; 
      top: 10px; 
      right: 10px; 
      display: flex; 
      gap: 8px; 
      z-index: 1000; 
    }
    
    .btn { 
      padding: 6px 10px; 
      background: #272727;
      border: 1px solid #303030;
      border-radius: 20px; 
      cursor: pointer; 
      font-size: 16px; 
      line-height: 1; 
      display: flex; 
      align-items: center; 
      color: #ffffff;
    }
    
    .btn .count-text { 
      font-size: 14px; 
      margin-right: 4px; 
    }
    
    #onlineList { 
      position: fixed; 
      top: 10px; 
      right: 10px; 
      border: 1px solid #303030;
      background: #272727;
      padding: 8px 14px; 
      border-radius: 20px; 
      font-size: 14px; 
      cursor: pointer; 
      z-index: 1000; 
      display: flex; 
      align-items: center; 
      gap: 5px; 
      color: #ffffff;
    }
    
    #usersBox, #setVideoModal { 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      background: #272727;
      padding: 20px; 
      border-radius: 12px; 
      box-shadow: 0 8px 25px rgba(0,0,0,0.5); 
      z-index: 1003; 
      display: none; 
      color: #ffffff;
      border: 1px solid #303030;
      min-width: 300px;
    }
    
    #usersList { 
      max-height: 200px; 
      overflow-y: auto; 
    }
    
    .user-item { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      padding: 8px 4px; 
      border-bottom: 1px solid #303030;
      font-size: 14px; 
    }
    
    .status-indicator { 
      width: 8px; 
      height: 8px; 
      border-radius: 50%; 
    }
    
    .status-green { background-color: #3ea6ff; } 
    .status-yellow { background-color: #ffd600; } 
    .status-gray { background-color: #606060; }
    
    .delete-btn { 
      background: none; 
      border: none; 
      color: #ff6b6b;
      font-size: 12px; 
      cursor: pointer; 
      margin-left: auto; 
      opacity: 0.6; 
      padding: 4px;
    }
    
    .delete-btn:hover { 
      opacity: 1; 
      background-color: rgba(255, 107, 107, 0.1);
      border-radius: 4px; 
    }

    #loginScreen { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(15, 15, 15, 0.98);
      display: flex; 
      justify-content: center; 
      align-items: center; 
      z-index: 10000; 
    }
    
    #loginBox { 
      background: #272727;
      padding: 30px; 
      border-radius: 12px; 
      text-align: center; 
      min-width: 320px; 
      color: #ffffff;
      border: 1px solid #303030;
    }
    
    #usernameInput { 
      width: 100%; 
      padding: 12px; 
      margin: 10px 0; 
      border: 1px solid #303030;
      border-radius: 8px; 
      font-size: 16px; 
      text-align: center; 
      box-sizing: border-box; 
      font-family: 'Tajawal', sans-serif;
      background: #0f0f0f;
      color: #ffffff;
    }
    
    #usernameInput::placeholder {
      color: #888;
    }
    
    #loginBtn { 
      background: #3ea6ff;
      color: white; 
      border: none; 
      padding: 12px 30px; 
      border-radius: 8px; 
      font-size: 16px; 
      cursor: pointer; 
      font-family: 'Tajawal', sans-serif; 
      margin-top: 10px; 
      font-weight: 500;
    }
    
    #loginBtn:hover {
      background: #2d8ad9;
    }
    
    #overlay { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.7);
      z-index: 1001; 
      display: none; 
    }
    
    /* Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø´ÙƒÙ„ ÙŠÙˆØªÙŠÙˆØ¨ */
    #pinnedVideoPlayer { 
      position: fixed; 
      top: 50px; 
      left: 50px; 
      width: clamp(320px, 90vw, 854px); 
      background: #000; 
      border-radius: 12px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.8); 
      z-index: 998; 
      display: none; 
      flex-direction: column; 
      overflow: hidden; 
      font-family: 'Tajawal', sans-serif;
    }
    
    .video-header { 
      background: #0f0f0f;
      color: #ffffff;
      padding: 12px 16px; 
      cursor: move; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      flex-shrink: 0; 
      touch-action: none; 
      font-size: 14px; 
      border-bottom: 1px solid #272727;
    }
    
    .video-body { 
      width: 100%; 
      background: #000; 
      flex-grow: 1; 
      position: relative;
      min-height: 180px;
    }
    
    .video-js {
      width: 100%;
      height: 100%;
    }
    
    .close-pinned-video { 
      background: #606060;
      border: none; 
      color: white; 
      border-radius: 50%; 
      width: 32px; 
      height: 32px; 
      cursor: pointer; 
      font-size: 14px; 
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .close-pinned-video:hover {
      background: #ff6b6b;
    }
    
    .resize-handle { 
      position: absolute; 
      width: 20px; 
      height: 20px; 
      bottom: 0; 
      right: 0; 
      cursor: nwse-resize; 
      z-index: 100; 
      background: linear-gradient(135deg, transparent 50%, #3ea6ff 50%);
    }
    
    /* ØªØ­ÙƒÙ…Ø§Øª ÙŠÙˆØªÙŠÙˆØ¨ Ø§Ù„Ù…Ø®ØµØµØ© */
    .youtube-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.7));
      padding: 0 12px 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .video-body:hover .youtube-controls {
      opacity: 1;
    }
    
    /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
    .progress-container {
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,0.2);
      cursor: pointer;
      position: relative;
      margin-bottom: 4px;
    }
    
    .progress-bar {
      height: 100%;
      background: #3ea6ff;
      width: 0%;
      position: relative;
      transition: width 0.1s linear;
    }
    
    .progress-handle {
      position: absolute;
      right: -6px;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      background: #3ea6ff;
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .progress-container:hover .progress-handle {
      opacity: 1;
    }
    
    .progress-container:hover .progress-bar {
      height: 6px;
    }
    
    /* Ø§Ù„ØªØ­ÙƒÙ…Ø§Øª Ø§Ù„Ø³ÙÙ„ÙŠØ© */
    .controls-bottom {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    
    .controls-left, .controls-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .control-btn {
      background: none;
      border: none;
      color: #ffffff;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      position: relative;
    }
    
    .control-btn:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .control-btn i {
      font-size: 20px;
    }
    
    .play-pause-btn {
      width: 36px;
      height: 36px;
    }
    
    .play-pause-btn i {
      font-size: 16px;
    }
    
    /* Ø§Ù„ÙˆÙ‚Øª */
    .time-display {
      color: #ffffff;
      font-size: 13px;
      font-family: 'Roboto', sans-serif;
      min-width: 80px;
      text-align: center;
    }
    
    /* Ø´Ø±ÙŠØ· Ø§Ù„ØµÙˆØª */
    .volume-container {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .volume-slider-container {
      width: 0;
      overflow: hidden;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
    }
    
    .volume-container:hover .volume-slider-container {
      width: 80px;
    }
    
    .volume-slider {
      width: 80px;
      height: 4px;
      background: rgba(255,255,255,0.2);
      border-radius: 2px;
      position: relative;
      cursor: pointer;
    }
    
    .volume-level {
      height: 100%;
      background: #ffffff;
      border-radius: 2px;
      width: 100%;
      position: relative;
    }
    
    .volume-handle {
      position: absolute;
      right: -4px;
      top: 50%;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      background: #ffffff;
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .volume-slider:hover .volume-handle {
      opacity: 1;
    }
    
    /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
    .settings-menu {
      position: relative;
    }
    
    .menu-content {
      position: absolute;
      bottom: 100%;
      left: 0;
      background: #272727;
      border: 1px solid #303030;
      border-radius: 8px;
      padding: 8px 0;
      min-width: 150px;
      display: none;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      z-index: 1000;
    }
    
    .menu-content.show {
      display: block;
    }
    
    .menu-item {
      padding: 8px 16px;
      color: #ffffff;
      cursor: pointer;
      transition: background 0.2s ease;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    
    .menu-item:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .menu-item.active {
      color: #3ea6ff;
    }
    
    .menu-item i {
      font-size: 12px;
    }
    
    /* Ø§Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… */
    .skip-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      pointer-events: none;
      z-index: 5;
    }
    
    .skip-btn {
      pointer-events: auto;
      background: rgba(0, 0, 0, 0.7);
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
      font-size: 24px;
      opacity: 0;
      transform: scale(0.8);
    }
    
    .video-body:hover .skip-btn {
      opacity: 1;
      transform: scale(1);
    }
    
    .skip-btn:hover {
      background: rgba(62, 166, 255, 0.9);
      transform: scale(1.1);
    }
    
    /* Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… */
    .skip-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 20;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .skip-indicator.show {
      opacity: 1;
    }
    
    /* Ø¥Ø®ÙØ§Ø¡ ØªØ­ÙƒÙ…Ø§Øª video.js Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© */
    .video-js .vjs-control-bar {
      display: none !important;
    }
    
    /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
    #messages::-webkit-scrollbar {
      width: 8px;
    }
    
    #messages::-webkit-scrollbar-track {
      background: #0f0f0f;
    }
    
    #messages::-webkit-scrollbar-thumb {
      background: #303030;
      border-radius: 4px;
    }
    
    #messages::-webkit-scrollbar-thumb:hover {
      background: #404040;
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ */
    @media (max-width: 768px) {
      #pinnedVideoPlayer {
        top: 10px;
        left: 10px;
        right: 10px;
        width: auto;
      }
      
      .control-btn {
        width: 36px;
        height: 36px;
      }
      
      .control-btn i {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>

  <div id="loginScreen">
    <div id="loginBox">
      <h2>ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h2>
      <input type="text" id="usernameInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ (Ø¨Ø¯ÙˆÙ† Ø±Ù…ÙˆØ² Ø®Ø§ØµØ©)" maxlength="15" autofocus>
      <button id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>

  <div id="chat-container" style="display: none;">
    <div id="topButtons">
      <div class="btn" id="setVideoBtn" title="ØªØ«Ø¨ÙŠØª ÙÙŠØ¯ÙŠÙˆ">ğŸ“º</div>
      <div class="btn" id="onlineListBtn" title="Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†">ğŸ‘¥ <span id="count" class="count-text">0</span></div>
    </div>
    
    <div id="pinnedVideoPlayer"></div>
    
    <div id="setVideoModal">
      <h4>ØªØ«Ø¨ÙŠØª ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø¬Ù…ÙŠØ¹</h4>
      <input type="text" id="videoUrlInput" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ØŒ ØªÙˆÙŠØªØ±ØŒ M3UØŒ Ø£Ùˆ MP4"/>
      <button id="submitVideoUrlBtn">ØªØ«Ø¨ÙŠØª</button>
    </div>
    
    <div id="usersBox">
      <h4>Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†</h4>
      <div id="usersList"></div>
    </div>
    
    <div id="overlay"></div>
    
    <div id="messages" role="list"></div>
    
    <form id="inputArea">
      <button type="submit" id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button>
      <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." autocomplete="off" />
    </form>
  </div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const firebaseConfig = {
        apiKey: "AIzaSyB1AsEHXP05nQ8M66jYPusheLaE60q_JwU",
        authDomain: "mychat-2d881.firebaseapp.com",
        databaseURL: "https://mychat-2d881-default-rtdb.firebaseio.com",
      };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let username = '';
    let userRef, messagesRef, onlineRef, pinnedVideoRef;
    let serverTimeOffset = 0;
    let videoPlayerInstance = null;
    let youtubeControls = null;

    const loginScreen = document.getElementById('loginScreen');
    const usernameInput = document.getElementById('usernameInput');
    const loginBtn = document.getElementById('loginBtn');
    const chatContainer = document.getElementById('chat-container');
    const messagesDiv = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");
    const onlineListBtn = document.getElementById("onlineListBtn");
    const setVideoBtn = document.getElementById("setVideoBtn");
    const usersBox = document.getElementById("usersBox");
    const setVideoModal = document.getElementById("setVideoModal");
    const videoUrlInput = document.getElementById("videoUrlInput");
    const submitVideoUrlBtn = document.getElementById("submitVideoUrlBtn");
    const pinnedVideoPlayer = document.getElementById("pinnedVideoPlayer");
    const overlay = document.getElementById("overlay");

    function attemptLogin() {
        let inputName = usernameInput.value.trim();
        const invalidChars = /[.#$\[\]]/;
        if (invalidChars.test(inputName)) {
            alert("Ø§Ù„Ø§Ø³Ù… Ù„Ø§ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ù…ÙˆØ² Ø®Ø§ØµØ©");
            return;
        }
        if (inputName.length < 2) {
            alert("Ø§Ù„Ø§Ø³Ù… Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹");
            return;
        }

        username = inputName;
        userRef = db.ref("online/" + username);
        messagesRef = db.ref("messages");
        onlineRef = db.ref("online");
        pinnedVideoRef = db.ref("pinned_video");
        
        startChat();
    }

    loginBtn.onclick = attemptLogin;
    usernameInput.onkeypress = (e) => { if (e.key === 'Enter') attemptLogin(); };

    function startChat() {
      loginScreen.style.display = 'none';
      chatContainer.style.display = 'flex';

      db.ref('.info/serverTimeOffset').on('value', snap => serverTimeOffset = snap.val() || 0);

      userRef.set({ lastActive: firebase.database.ServerValue.TIMESTAMP });
      userRef.onDisconnect().remove();

      setInterval(() => {
        userRef.update({ lastActive: firebase.database.ServerValue.TIMESTAMP });
      }, 60000);

      setInterval(() => {
         const now = Date.now() + serverTimeOffset;
         onlineRef.once('value', snap => {
             snap.forEach(child => {
                 if (now - child.val().lastActive > 90000) child.ref.remove();
             });
         });
      }, 60000);

      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
      onlineListBtn.onclick = (e) => { e.stopPropagation(); usersBox.style.display = 'block'; overlay.style.display = 'block'; };
      setVideoBtn.onclick = (e) => { e.stopPropagation(); setVideoModal.style.display = 'block'; overlay.style.display = 'block'; };
      overlay.onclick = closeAllModals;
      
      document.getElementById("inputArea").onsubmit = (e) => {
        e.preventDefault();
        const text = messageInput.value.trim();
        if (!text) return;
        
        const time = new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', hour12: false});
        messagesRef.push({ user: username, text: text, time: time, timestamp: firebase.database.ServerValue.TIMESTAMP });
        messageInput.value = "";
        userRef.update({ lastActive: firebase.database.ServerValue.TIMESTAMP });
        scrollToBottom();
      };

      messagesRef.limitToLast(100).on("child_added", snap => {
        addMessageToUI(snap.key, snap.val());
      });

      messagesRef.on("child_removed", snap => {
        const msgElement = document.getElementById(`msg-${snap.key}`);
        if (msgElement) {
            msgElement.style.opacity = '0';
            setTimeout(() => msgElement.remove(), 300);
        }
      });

      // Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†
      onlineRef.on("value", snap => {
        document.getElementById("count").textContent = snap.numChildren();
        renderUsersList(snap.val() || {});
      });

      // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
      submitVideoUrlBtn.onclick = () => {
        const url = videoUrlInput.value.trim();
        if (!url) return;
        
        const youtubeId = getYoutubeVideoId(url);
        const tweetId = getTweetId(url);
        
        if (youtubeId) {
          pinnedVideoRef.set({ type: 'youtube', id: youtubeId, setBy: username });
        } else if (tweetId) {
          pinnedVideoRef.set({ type: 'twitter', id: tweetId, setBy: username });
        } else if (url.toLowerCase().includes('.m3u')) {
          pinnedVideoRef.set({ type: 'm3u', url: url, setBy: username });
        } else if (isDirectVideo(url)) {
          pinnedVideoRef.set({ type: 'direct', url: url, setBy: username });
        } else {
          alert("Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ….");
          return;
        }
        
        closeAllModals();
      };

      // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø«Ø¨Øª
      pinnedVideoRef.on("value", async (snap) => {
        const data = snap.val();
        if (videoPlayerInstance) {
          videoPlayerInstance.dispose();
          videoPlayerInstance = null;
        }
        if (youtubeControls) {
          youtubeControls.remove();
          youtubeControls = null;
        }
        pinnedVideoPlayer.innerHTML = '';

        if (data) {
          pinnedVideoPlayer.style.display = 'flex';
          const header = document.createElement('div');
          header.className = 'video-header';
          header.innerHTML = `<span>ğŸ¬ ${data.setBy}</span>`;
          const closeBtn = document.createElement('button');
          closeBtn.className = 'close-pinned-video';
          closeBtn.innerHTML = '<i class="fas fa-times"></i>';
          closeBtn.onclick = () => pinnedVideoRef.remove();
          header.appendChild(closeBtn);
          const body = document.createElement('div');
          body.className = 'video-body';
          
          const resizeHandle = document.createElement('div');
          resizeHandle.className = 'resize-handle';
          
          pinnedVideoPlayer.appendChild(header);
          pinnedVideoPlayer.appendChild(body);
          pinnedVideoPlayer.appendChild(resizeHandle);
          
          makeDraggable(pinnedVideoPlayer, header);
          makeResizable(pinnedVideoPlayer, resizeHandle);

          let videoSource = null;
          let videoType = '';

          if (data.type === 'youtube') {
            videoSource = `https://www.youtube.com/watch?v=${data.id}`;
            videoType = 'video/youtube';
          } else if (data.type === 'm3u') {
            videoSource = data.url;
            videoType = 'application/x-mpegURL';
          } else if (data.type === 'direct') {
            videoSource = data.url;
            videoType = 'video/mp4';
          } else if (data.type === 'twitter') {
            try {
              const response = await fetch(`https://api.vxtwitter.com/i/status/${data.id}`);
              const tweetData = await response.json();
              if (tweetData.media_extended && tweetData.media_extended.length > 0) {
                videoSource = tweetData.media_extended[0].url;
                videoType = 'video/mp4';
              } else {
                body.innerHTML = `<p style="color:white;padding:10px;">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙŠØ¯ÙŠÙˆ.</p>`;
              }
            } catch (error) {
              console.error("Error fetching Twitter video:", error);
              body.innerHTML = `<p style="color:white;padding:10px;">Ø­Ø¯Ø« Ø®Ø·Ø£.</p>`;
            }
          }

          if (videoSource) {
            const videoEl = document.createElement('video-js');
            videoEl.className = 'vjs-netflix-theme';
            body.appendChild(videoEl);

            let playerOptions = {
              autoplay: true,
              muted: true,
              controls: false,
              aspectRatio: '16:9',
              playsinline: true,
              techOrder: data.type === 'youtube' ? ['youtube'] : ['html5'],
              sources: [{ type: videoType, src: videoSource }],
              youtube: {
                iv_load_policy: 1,
                modestbranding: 1
              }
            };
            
            videoPlayerInstance = videojs(videoEl, playerOptions);
            
            // Ø¥Ø¶Ø§ÙØ© ØªØ­ÙƒÙ…Ø§Øª ÙŠÙˆØªÙŠÙˆØ¨ Ø¨Ø¹Ø¯ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø´ØºÙ„
            videoPlayerInstance.ready(() => {
              createYouTubeControls(body, videoPlayerInstance);
            });
          }

          addNotification(`${data.setBy} Ù‚Ø§Ù… Ø¨ØªØ´ØºÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ`);
        } else {
          pinnedVideoPlayer.style.display = 'none';
        }
      });
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ ØªØ­ÙƒÙ…Ø§Øª ÙŠÙˆØªÙŠÙˆØ¨
    function createYouTubeControls(container, player) {
      youtubeControls = document.createElement('div');
      youtubeControls.className = 'youtube-controls';
      
      // Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
      const progressContainer = document.createElement('div');
      progressContainer.className = 'progress-container';
      const progressBar = document.createElement('div');
      progressBar.className = 'progress-bar';
      const progressHandle = document.createElement('div');
      progressHandle.className = 'progress-handle';
      progressBar.appendChild(progressHandle);
      progressContainer.appendChild(progressBar);
      
      // Ø§Ù„ØªØ­ÙƒÙ…Ø§Øª Ø§Ù„Ø³ÙÙ„ÙŠØ©
      const controlsBottom = document.createElement('div');
      controlsBottom.className = 'controls-bottom';
      
      const controlsLeft = document.createElement('div');
      controlsLeft.className = 'controls-left';
      
      const controlsRight = document.createElement('div');
      controlsRight.className = 'controls-right';
      
      // Ø§Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙŠØ³Ø±Ù‰
      const playPauseBtn = createControlButton('play-pause-btn', 'fas fa-play', 'ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù');
      const rewindBtn = createControlButton('control-btn', 'fas fa-backward-step', 'Ø±Ø¬ÙˆØ¹ 10 Ø«ÙˆØ§Ù†ÙŠ');
      const forwardBtn = createControlButton('control-btn', 'fas fa-forward-step', 'ØªÙ‚Ø¯ÙŠÙ… 10 Ø«ÙˆØ§Ù†ÙŠ');
      const timeDisplay = document.createElement('div');
      timeDisplay.className = 'time-display';
      timeDisplay.textContent = '0:00 / 0:00';
      
      // Ø§Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙŠÙ…Ù†Ù‰
      const volumeBtn = createControlButton('control-btn', 'fas fa-volume-high', 'Ø§Ù„ØµÙˆØª');
      const settingsBtn = createControlButton('control-btn', 'fas fa-gear', 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
      const fullscreenBtn = createControlButton('control-btn', 'fas fa-expand', 'Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©');
      
      // ØªØ­ÙƒÙ… Ø§Ù„ØµÙˆØª
      const volumeContainer = document.createElement('div');
      volumeContainer.className = 'volume-container';
      const volumeSliderContainer = document.createElement('div');
      volumeSliderContainer.className = 'volume-slider-container';
      const volumeSlider = document.createElement('div');
      volumeSlider.className = 'volume-slider';
      const volumeLevel = document.createElement('div');
      volumeLevel.className = 'volume-level';
      const volumeHandle = document.createElement('div');
      volumeHandle.className = 'volume-handle';
      volumeLevel.appendChild(volumeHandle);
      volumeSlider.appendChild(volumeLevel);
      volumeSliderContainer.appendChild(volumeSlider);
      volumeContainer.appendChild(volumeBtn);
      volumeContainer.appendChild(volumeSliderContainer);
      
      // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
      const settingsMenu = createSettingsMenu();
      const settingsContainer = document.createElement('div');
      settingsContainer.className = 'settings-menu';
      settingsContainer.appendChild(settingsBtn);
      settingsContainer.appendChild(settingsMenu);
      
      // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
      controlsLeft.appendChild(playPauseBtn);
      controlsLeft.appendChild(rewindBtn);
      controlsLeft.appendChild(forwardBtn);
      controlsLeft.appendChild(timeDisplay);
      
      controlsRight.appendChild(volumeContainer);
      controlsRight.appendChild(settingsContainer);
      controlsRight.appendChild(fullscreenBtn);
      
      controlsBottom.appendChild(controlsLeft);
      controlsBottom.appendChild(controlsRight);
      
      // Ø§Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…
      const skipOverlay = document.createElement('div');
      skipOverlay.className = 'skip-overlay';
      const skipBackward = createSkipButton('âª', 'Ø±Ø¬ÙˆØ¹ 10 Ø«ÙˆØ§Ù†ÙŠ');
      const skipForward = createSkipButton('â©', 'ØªÙ‚Ø¯ÙŠÙ… 10 Ø«ÙˆØ§Ù†ÙŠ');
      skipOverlay.appendChild(skipBackward);
      skipOverlay.appendChild(skipForward);
      
      // Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…
      const skipIndicator = document.createElement('div');
      skipIndicator.className = 'skip-indicator';
      
      // ØªØ¬Ù…ÙŠØ¹ ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±
      youtubeControls.appendChild(progressContainer);
      youtubeControls.appendChild(controlsBottom);
      container.appendChild(youtubeControls);
      container.appendChild(skipOverlay);
      container.appendChild(skipIndicator);
      
      // Ø¥Ø¹Ø¯Ø§Ø¯ event listeners
      setupYouTubeControlEvents(player, {
        playPauseBtn,
        rewindBtn,
        forwardBtn,
        volumeBtn,
        volumeSlider,
        volumeLevel,
        settingsBtn,
        settingsMenu,
        fullscreenBtn,
        progressContainer,
        progressBar,
        timeDisplay,
        skipBackward,
        skipForward,
        skipIndicator
      });
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
    function createControlButton(className, icon, title) {
      const btn = document.createElement('button');
      btn.className = className;
      btn.innerHTML = `<i class="${icon}"></i>`;
      btn.title = title;
      return btn;
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…
    function createSkipButton(icon, title) {
      const btn = document.createElement('div');
      btn.className = 'skip-btn';
      btn.innerHTML = icon;
      btn.title = title;
      return btn;
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    function createSettingsMenu() {
      const menu = document.createElement('div');
      menu.className = 'menu-content';
      
      // Ø§Ù„Ø³Ø±Ø¹Ø©
      const speedItem = document.createElement('div');
      speedItem.className = 'menu-item';
      speedItem.innerHTML = `
        <span>Ø³Ø±Ø¹Ø© Ø§Ù„ØªØ´ØºÙŠÙ„</span>
        <i class="fas fa-chevron-left"></i>
      `;
      
      const speedSubmenu = document.createElement('div');
      speedSubmenu.className = 'menu-content';
      speedSubmenu.style.left = '100%';
      speedSubmenu.style.bottom = '0';
      
      const speeds = [
        { value: 0.25, label: '0.25' },
        { value: 0.5, label: '0.5' },
        { value: 0.75, label: '0.75' },
        { value: 1, label: 'Ø¹Ø§Ø¯ÙŠ' },
        { value: 1.25, label: '1.25' },
        { value: 1.5, label: '1.5' },
        { value: 2, label: '2' }
      ];
      
      speeds.forEach(speed => {
        const option = document.createElement('div');
        option.className = 'menu-item speed-option';
        option.dataset.speed = speed.value;
        option.textContent = speed.label;
        if (speed.value === 1) option.classList.add('active');
        speedSubmenu.appendChild(option);
      });
      
      speedItem.appendChild(speedSubmenu);
      
      // Ø§Ù„Ø¬ÙˆØ¯Ø©
      const qualityItem = document.createElement('div');
      qualityItem.className = 'menu-item';
      qualityItem.innerHTML = `
        <span>Ø§Ù„Ø¬ÙˆØ¯Ø©</span>
        <i class="fas fa-chevron-left"></i>
      `;
      
      const qualitySubmenu = document.createElement('div');
      qualitySubmenu.className = 'menu-content';
      qualitySubmenu.style.left = '100%';
      qualitySubmenu.style.bottom = '0';
      
      const qualities = ['ØªÙ„Ù‚Ø§Ø¦ÙŠ', '144p', '240p', '360p', '480p', '720p', '1080p', '4K'];
      
      qualities.forEach(quality => {
        const option = document.createElement('div');
        option.className = 'menu-item quality-option';
        option.textContent = quality;
        if (quality === 'ØªÙ„Ù‚Ø§Ø¦ÙŠ') option.classList.add('active');
        qualitySubmenu.appendChild(option);
      });
      
      qualityItem.appendChild(qualitySubmenu);
      
      menu.appendChild(speedItem);
      menu.appendChild(qualityItem);
      
      return menu;
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªØ­ÙƒÙ…
    function setupYouTubeControlEvents(player, controls) {
      const {
        playPauseBtn,
        rewindBtn,
        forwardBtn,
        volumeBtn,
        volumeSlider,
        volumeLevel,
        settingsBtn,
        settingsMenu,
        fullscreenBtn,
        progressContainer,
        progressBar,
        timeDisplay,
        skipBackward,
        skipForward,
        skipIndicator
      } = controls;

      // ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù
      let isPlaying = false;
      playPauseBtn.addEventListener('click', () => {
        if (player.paused()) {
          player.play();
          playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
          isPlaying = true;
        } else {
          player.pause();
          playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
          isPlaying = false;
        }
      });

      // Ø±Ø¬ÙˆØ¹ 10 Ø«ÙˆØ§Ù†ÙŠ
      rewindBtn.addEventListener('click', () => skipTime(-10, player, skipIndicator));
      skipBackward.addEventListener('click', () => skipTime(-10, player, skipIndicator));

      // ØªÙ‚Ø¯ÙŠÙ… 10 Ø«ÙˆØ§Ù†ÙŠ
      forwardBtn.addEventListener('click', () => skipTime(10, player, skipIndicator));
      skipForward.addEventListener('click', () => skipTime(10, player, skipIndicator));

      // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØµÙˆØª
      let isMuted = false;
      let currentVolume = 1;
      
      volumeBtn.addEventListener('click', () => {
        isMuted = !isMuted;
        player.muted(isMuted);
        volumeBtn.innerHTML = isMuted ? 
          '<i class="fas fa-volume-xmark"></i>' : 
          '<i class="fas fa-volume-high"></i>';
      });

      // Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
      let isSeeking = false;
      
      progressContainer.addEventListener('mousedown', (e) => {
        isSeeking = true;
        seekToPosition(e, player, progressBar);
      });
      
      progressContainer.addEventListener('mousemove', (e) => {
        if (isSeeking) {
          seekToPosition(e, player, progressBar);
        }
      });
      
      document.addEventListener('mouseup', () => {
        isSeeking = false;
      });

      // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      player.on('timeupdate', () => {
        if (!isSeeking) {
          const currentTime = player.currentTime();
          const duration = player.duration();
          const percent = (currentTime / duration) * 100;
          progressBar.style.width = percent + '%';
          
          timeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
        }
      });

      player.on('play', () => {
        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
        isPlaying = true;
      });

      player.on('pause', () => {
        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        isPlaying = false;
      });

      // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
      settingsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        settingsMenu.classList.toggle('show');
      });

      // Ø§Ù„Ø³Ø±Ø¹Ø©
      settingsMenu.querySelectorAll('.speed-option').forEach(option => {
        option.addEventListener('click', (e) => {
          e.stopPropagation();
          const speed = parseFloat(option.dataset.speed);
          player.playbackRate(speed);
          settingsMenu.querySelectorAll('.speed-option').forEach(opt => opt.classList.remove('active'));
          option.classList.add('active');
        });
      });

      // Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©
      fullscreenBtn.addEventListener('click', () => {
        if (player.isFullscreen()) {
          player.exitFullscreen();
          fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
        } else {
          player.requestFullscreen();
          fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
        }
      });

      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
      document.addEventListener('click', () => {
        settingsMenu.classList.remove('show');
      });

      // Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¯Ø§Ø®Ù„Ù‡Ø§
      settingsMenu.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }

    // Ø¯Ø§Ù„Ø© Ù„Ù„ØªÙ‚Ø¯ÙŠÙ…/Ø§Ù„ØªØ£Ø®ÙŠØ±
    function skipTime(seconds, player, indicator) {
      const currentTime = player.currentTime();
      const newTime = Math.max(0, Math.min(player.duration(), currentTime + seconds));
      player.currentTime(newTime);
      
      const message = seconds > 0 ? 
        `<i class="fas fa-forward"></i> +${seconds} Ø«Ø§Ù†ÙŠØ©` : 
        `<i class="fas fa-backward"></i> ${seconds} Ø«Ø§Ù†ÙŠØ©`;
      indicator.innerHTML = message;
      indicator.classList.add('show');
      
      setTimeout(() => {
        indicator.classList.remove('show');
      }, 1000);
    }

    // Ø¯Ø§Ù„Ø© Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ù…ÙˆØ¶Ø¹ ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    function seekToPosition(e, player, progressBar) {
      const rect = e.currentTarget.getBoundingClientRect();
      const percent = (e.clientX - rect.left) / rect.width;
      const newTime = player.duration() * percent;
      player.currentTime(newTime);
      progressBar.style.width = (percent * 100) + '%';
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
    function formatTime(seconds) {
      if (isNaN(seconds)) return '0:00';
      
      const hours = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = Math.floor(seconds % 60);
      
      if (hours > 0) {
        return `${hours}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      } else {
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      }
    }

    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ...
    function addMessageToUI(key, { user, text, time, timestamp }) {
      const div = document.createElement("div");
      div.className = "msg";
      div.id = `msg-${key}`;
      
      const isMe = user === username;
      
      const timeElement = document.createElement("span");
      timeElement.className = "time";
      timeElement.id = `time-${key}`;
      
      updateTimeDisplay(key, timestamp, timeElement);
      
      div.innerHTML = `
        <span class="user">${escapeHtml(user)}</span>
        <span style="flex:1; word-break: break-word;">${escapeHtml(text)}</span>
      `;
      
      div.appendChild(timeElement);

      if (isMe) {
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn";
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.onclick = () => {
          if(confirm("Ø­Ø°ÙØŸ")) messagesRef.child(key).remove();
        };
        div.appendChild(deleteBtn);
      }

      messagesDiv.appendChild(div);
      scrollToBottom();
      
      setInterval(() => {
        updateTimeDisplay(key, timestamp, timeElement);
      }, 60000);
    }

    function updateTimeDisplay(key, timestamp, timeElement) {
      if (!timestamp) return;
      
      const now = Date.now() + serverTimeOffset;
      const messageTime = timestamp + serverTimeOffset;
      const diffMs = now - messageTime;
      const diffSec = Math.floor(diffMs / 1000);
      const diffMin = Math.floor(diffSec / 60);
      const diffHours = Math.floor(diffMin / 60);
      const diffDays = Math.floor(diffHours / 24);
      const diffWeeks = Math.floor(diffDays / 7);
      const diffMonths = Math.floor(diffDays / 30);
      const diffYears = Math.floor(diffDays / 365);
      
      let timeText = "";
      
      if (diffSec < 5) {
        timeText = "Ø§Ù„Ø¢Ù†";
      } else if (diffSec < 60) {
        timeText = "Ø«ÙˆØ§Ù†ÙŠ";
      } else if (diffMin < 2) {
        timeText = "Ø¯1";
      } else if (diffMin < 60) {
        timeText = `Ø¯${diffMin}`;
      } else if (diffHours < 24) {
        timeText = `Ø³${diffHours}`;
      } else if (diffDays < 7) {
        timeText = `ÙŠ${diffDays}`;
      } else if (diffWeeks < 4) {
        timeText = `Ø£${diffWeeks}`;
      } else if (diffMonths < 12) {
        timeText = `Ø´${diffMonths}`;
      } else {
        timeText = `Ø¹${diffYears}`;
      }
      
      timeElement.textContent = timeText;
    }

    function addNotification(text) {
      const div = document.createElement("div");
      div.className = "sys";
      div.textContent = text;
      messagesDiv.appendChild(div);
      scrollToBottom();
    }

    function renderUsersList(users) {
        const list = document.getElementById("usersList");
        list.innerHTML = '';
        const now = Date.now() + serverTimeOffset;
        Object.keys(users).forEach(uName => {
            const uData = users[uName];
            const div = document.createElement("div");
            div.className = "user-item";
            let colorClass = 'status-green';
            const diff = now - (uData.lastActive || 0);
            if (diff > 60000) colorClass = 'status-gray';
            else if (diff > 30000) colorClass = 'status-yellow';
            div.innerHTML = `<span class="status-indicator ${colorClass}"></span><span>${escapeHtml(uName)}</span>`;
            list.appendChild(div);
        });
    }

    function closeAllModals() {
      usersBox.style.display = 'none';
      setVideoModal.style.display = 'none';
      overlay.style.display = 'none';
    }

    function makeDraggable(element, handle) {
      let offsetX = 0, offsetY = 0;
      let isDragging = false;
      
      const getPointerPosition = (e) => e.touches ? e.touches[0] : e;
      
      const onDragStart = (e) => {
        isDragging = true;
        const pointer = getPointerPosition(e);
        offsetX = pointer.clientX - element.offsetLeft;
        offsetY = pointer.clientY - element.offsetTop;
        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('touchmove', onDragMove, { passive: false });
        document.addEventListener('mouseup', onDragEnd);
        document.addEventListener('touchend', onDragEnd);
      };
      
      const onDragMove = (e) => {
        if (isDragging) {
          e.preventDefault();
          const pointer = getPointerPosition(e);
          element.style.left = (pointer.clientX - offsetX) + "px";
          element.style.top = (pointer.clientY - offsetY) + "px";
        }
      };
      
      const onDragEnd = () => {
        isDragging = false;
        document.removeEventListener('mousemove', onDragMove);
        document.removeEventListener('touchmove', onDragMove);
        document.removeEventListener('mouseup', onDragEnd);
        document.removeEventListener('touchend', onDragEnd);
      };
      
      handle.addEventListener('mousedown', onDragStart);
      handle.addEventListener('touchstart', onDragStart, { passive: false });
    }

    function makeResizable(element, handle) {
      let initialWidth, initialHeight, initialX, initialY;
      const getPointerPosition = (e) => e.touches ? e.touches[0] : e;

      function onResizeStart(e) {
        if(e.type === 'touchstart') e.preventDefault();
        const pointer = getPointerPosition(e);
        initialWidth = element.offsetWidth;
        initialHeight = element.offsetHeight;
        initialX = pointer.clientX;
        initialY = pointer.clientY;
        document.addEventListener('mousemove', onResizeMove);
        document.addEventListener('touchmove', onResizeMove, { passive: false });
        document.addEventListener('mouseup', onResizeEnd);
        document.addEventListener('touchend', onResizeEnd);
      }

      function onResizeMove(e) {
        if(e.type === 'touchmove') e.preventDefault();
        const pointer = getPointerPosition(e);
        const newWidth = initialWidth + (pointer.clientX - initialX);
        const newHeight = initialHeight + (pointer.clientY - initialY);
        if (newWidth > 300) { element.style.width = newWidth + 'px'; }
        if (newHeight > 200) { element.style.height = newHeight + 'px'; }
      }

      function onResizeEnd() {
        document.removeEventListener('mousemove', onResizeMove);
        document.removeEventListener('touchmove', onResizeMove);
        document.removeEventListener('mouseup', onResizeEnd);
        document.removeEventListener('touchend', onResizeEnd);
      }
      
      handle.addEventListener('mousedown', onResizeStart);
      handle.addEventListener('touchstart', onResizeStart, { passive: false });
    }

    function getYoutubeVideoId(url) {
      if (!url) return null;
      const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
      return (url.match(regex) || [])[1] || null;
    }

    function getTweetId(url) {
      if (!url) return null;
      const regex = /(?:https?:\/\/)?(?:www\.)?(?:twitter|x)\.com\/(?:\w+)\/status\/(\d+)/;
      return (url.match(regex) || [])[1] || null;
    }

    function isDirectVideo(url) {
      return /\.(mp4|webm|ogv)$/.test(url);
    }

    function scrollToBottom() { messagesDiv.scrollTop = messagesDiv.scrollHeight; }
    function escapeHtml(unsafe) { if(!unsafe) return ""; return unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
  });
</script>
</body>
</html>
