<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¯Ø±Ø¯Ø´Ø© ÙÙˆØ±ÙŠØ© Ù…ÙˆØ«ÙˆÙ‚Ø©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    body { font-family: 'Tajawal', sans-serif; background: #f4f7f9; display: flex; flex-direction: column; position: relative; }
    #chat-container { display: flex; flex-direction: column; height: 100%; }
    
    #messages { flex: 1; overflow-y: auto; padding: 15px; background: #fff; scroll-behavior: smooth; }
    
    .msg { margin: 8px 0; display: flex; gap: 10px; align-items: center; direction: ltr; text-align: left; font-size: 15px; line-height: 1.4; }
    .sys { text-align: center; color: #888; font-size: 12px; margin: 10px auto; font-style: italic; background-color: #f0f0f0; padding: 4px 10px; border-radius: 12px; transition: opacity 0.5s; }
    
    /* Ù„ÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ­Ø¯ Ù„Ù„Ø¬Ù…ÙŠØ¹ */
    .user { font-weight: bold; color: #005c97; }
    
    .time { font-size: 11px; color: #999; min-width: 40px; }
    
    #inputArea {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 8px;
      padding: 10px;
      background: #ffffff;
      border-top: none;
    }

    /* --- ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ù‡Ù†Ø§ --- */
    #messageInput { 
      flex: 1; 
      font-size: 16px; 
      height: 45px; /* Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª */
      padding: 0 15px; /* Ù‡ÙˆØ§Ù…Ø´ Ø¬Ø§Ù†Ø¨ÙŠØ© ÙÙ‚Ø· */
      border: 1px solid #eee;
      border-radius: 25px; 
      font-family: 'Tajawal', sans-serif; 
      background: #ffffff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.03); 
      box-sizing: border-box; /* Ù„Ø¶Ù…Ø§Ù† Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø¥Ø·Ø§Ø± Ø¶Ù…Ù† Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ */
    }
    #messageInput:focus { border-color: #3366cc; outline: none; }
    
    #sendBtn { 
      height: 45px; /* Ù†ÙØ³ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø­Ù‚Ù„ */
      padding: 0 25px; 
      border: none; 
      border-radius: 25px; 
      background: #3366cc; 
      color: white; 
      cursor: pointer; 
      font-family: 'Tajawal', sans-serif;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex; 
      align-items: center; 
      justify-content: center;
      box-sizing: border-box;
    }
    /* -------------------------- */

    #sendBtn:hover { background: #254e99; }
    
    #onlineList { position: fixed; top: 10px; right: 10px; border: 1px solid #ccc; background: white; padding: 8px 14px; border-radius: 20px; font-size: 14px; cursor: pointer; z-index: 1000; display: flex; align-items: center; gap: 5px; }
    #usersBox { position: fixed; top: 55px; right: 10px; background: white; border: 1px solid #ccc; border-radius: 8px; padding: 10px; z-index: 999; min-width: 160px; opacity: 0; transform: translateY(-10px); visibility: hidden; transition: all 0.2s; }
    #usersBox.visible { opacity: 1; transform: translateY(0); visibility: visible; }
    #usersList { max-height: 200px; overflow-y: auto; }
    .user-item { display: flex; align-items: center; gap: 8px; padding: 5px 2px; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
    .status-indicator { width: 10px; height: 10px; border-radius: 50%; }
    .status-green { background-color: #28a745; } .status-yellow { background-color: #ffc107; } .status-gray { background-color: #ccc; }
    
    .delete-btn { background: none; border: none; color: #d00; font-size: 12px; cursor: pointer; margin-left: auto; opacity: 0.6; }
    .delete-btn:hover { opacity: 1; background-color: #ffe5e5; border-radius: 4px; }

    #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 10000; }
    #loginBox { background: white; padding: 30px; border-radius: 15px; text-align: center; min-width: 300px; }
    #usernameInput { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; text-align: center; box-sizing: border-box; font-family: 'Tajawal', sans-serif;}
    #loginBtn { background: #3366cc; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; cursor: pointer; font-family: 'Tajawal', sans-serif; margin-top: 10px; }
  </style>
</head>
<body>

  <div id="loginScreen">
    <div id="loginBox">
      <h2>ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h2>
      <input type="text" id="usernameInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ (Ø¨Ø¯ÙˆÙ† Ø±Ù…ÙˆØ² Ø®Ø§ØµØ©)" maxlength="15" autofocus>
      <button id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>

  <div id="chat-container" style="display: none;">
    <div id="onlineList">ğŸ‘¥ <span id="count">0</span></div>
    <div id="usersBox">
      <h4 style="margin:0 0 10px 0; text-align:center; border-bottom:1px solid #eee; padding-bottom:5px;">Ø§Ù„Ù…ØªØµÙ„ÙˆÙ†</h4>
      <div id="usersList"></div>
    </div>
    <div id="messages" role="list"></div>
    <form id="inputArea">
      <button type="submit" id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button>
      <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." autocomplete="off" />
    </form>
  </div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const firebaseConfig = {
      apiKey: "AIzaSyB1AsEHXP05nQ8M66jYPusheLaE60q_JwU",
      authDomain: "mychat-2d881.firebaseapp.com",
      databaseURL: "https://mychat-2d881-default-rtdb.firebaseio.com",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let username = '';
    let userRef, messagesRef, onlineRef;
    let serverTimeOffset = 0;

    const loginScreen = document.getElementById('loginScreen');
    const usernameInput = document.getElementById('usernameInput');
    const loginBtn = document.getElementById('loginBtn');
    const chatContainer = document.getElementById('chat-container');
    const messagesDiv = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");
    const onlineListBtn = document.getElementById("onlineList");
    const usersBox = document.getElementById("usersBox");

    function attemptLogin() {
        let inputName = usernameInput.value.trim();
        const invalidChars = /[.#$\[\]]/;
        if (invalidChars.test(inputName)) {
            alert("Ø§Ù„Ø§Ø³Ù… Ù„Ø§ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ù…ÙˆØ² Ø®Ø§ØµØ©");
            return;
        }
        if (inputName.length < 2) {
            alert("Ø§Ù„Ø§Ø³Ù… Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹");
            return;
        }

        username = inputName;
        userRef = db.ref("online/" + username);
        messagesRef = db.ref("messages");
        onlineRef = db.ref("online");
        
        startChat();
    }

    loginBtn.onclick = attemptLogin;
    usernameInput.onkeypress = (e) => { if (e.key === 'Enter') attemptLogin(); };

    function startChat() {
      loginScreen.style.display = 'none';
      chatContainer.style.display = 'flex';

      db.ref('.info/serverTimeOffset').on('value', snap => serverTimeOffset = snap.val() || 0);

      userRef.set({ lastActive: firebase.database.ServerValue.TIMESTAMP });
      userRef.onDisconnect().remove();

      setInterval(() => {
        userRef.update({ lastActive: firebase.database.ServerValue.TIMESTAMP });
      }, 60000);

      setInterval(() => {
         const now = Date.now() + serverTimeOffset;
         onlineRef.once('value', snap => {
             snap.forEach(child => {
                 if (now - child.val().lastActive > 90000) child.ref.remove();
             });
         });
      }, 60000);

      onlineListBtn.onclick = (e) => { e.stopPropagation(); usersBox.classList.toggle('visible'); };
      document.onclick = () => usersBox.classList.remove('visible');
      usersBox.onclick = (e) => e.stopPropagation();

      onlineRef.on("value", snap => {
        document.getElementById("count").textContent = snap.numChildren();
        renderUsersList(snap.val() || {});
      });

      document.getElementById("inputArea").onsubmit = (e) => {
        e.preventDefault();
        const text = messageInput.value.trim();
        if (!text) return;
        
        const time = new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', hour12: false});
        messagesRef.push({ user: username, text: text, time: time, timestamp: firebase.database.ServerValue.TIMESTAMP });
        messageInput.value = "";
        userRef.update({ lastActive: firebase.database.ServerValue.TIMESTAMP });
        scrollToBottom();
      };

      messagesRef.limitToLast(100).on("child_added", snap => {
        addMessageToUI(snap.key, snap.val());
      });

      messagesRef.on("child_removed", snap => {
        const msgElement = document.getElementById(`msg-${snap.key}`);
        if (msgElement) {
            msgElement.style.opacity = '0';
            setTimeout(() => msgElement.remove(), 300);
        }
      });
    }

    function addMessageToUI(key, { user, text, time }) {
      const div = document.createElement("div");
      div.className = "msg";
      div.id = `msg-${key}`;
      
      const isMe = user === username;
      
      // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø±Ø· Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù„ÙˆÙ†ØŒ Ø§Ù„Ø¢Ù† Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙ„Ø§Ø³ .user
      div.innerHTML = `
        <span class="user">${escapeHtml(user)}</span>
        <span style="flex:1; word-break: break-word;">${escapeHtml(text)}</span>
        <span class="time">${escapeHtml(time)}</span>
      `;

      if (isMe) {
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn";
        deleteBtn.innerHTML = "ğŸ—‘ï¸";
        deleteBtn.onclick = () => {
          if(confirm("Ø­Ø°ÙØŸ")) messagesRef.child(key).remove();
        };
        div.appendChild(deleteBtn);
      }

      messagesDiv.appendChild(div);
      scrollToBottom();
    }

    function renderUsersList(users) {
        const list = document.getElementById("usersList");
        list.innerHTML = '';
        const now = Date.now() + serverTimeOffset;
        Object.keys(users).forEach(uName => {
            const uData = users[uName];
            const div = document.createElement("div");
            div.className = "user-item";
            let colorClass = 'status-green';
            const diff = now - (uData.lastActive || 0);
            if (diff > 60000) colorClass = 'status-gray';
            else if (diff > 30000) colorClass = 'status-yellow';
            div.innerHTML = `<span class="status-indicator ${colorClass}"></span><span>${escapeHtml(uName)}</span>`;
            list.appendChild(div);
        });
    }

    function scrollToBottom() { messagesDiv.scrollTop = messagesDiv.scrollHeight; }
    function escapeHtml(unsafe) { if(!unsafe) return ""; return unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
  });
</script>
</body>
</html>
