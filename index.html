<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>public-room</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

<!-- YouTube API -->
<script src="https://www.youtube.com/iframe_api"></script>
<!-- HLS.js -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: 'Tajawal', sans-serif;
    background: #020617;
    color: #e5e7eb;
  }

  /* الهيدر */
  .header {
    height: 55px;
    display: flex;
    align-items: center;
    justify-content: flex-start; /* لتغيير الزر لليمين */
    padding: 0 15px;
    position: sticky;
    top: 0;
    z-index: 20;
    background: rgba(2,6,23,0.8);
    backdrop-filter: blur(6px);
  }

  .online-pill {
    margin-left: auto; /* تحريك للجانب الأيمن */
    padding: 8px 14px;
    border-radius: 999px;
    background: #1e293b;
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-size: 14px;
  }
  .online-dot {
    width: 8px;
    height: 8px;
    background: #22c55e;
    border-radius: 999px;
  }

  /* المشغل */
  #player-wrapper {
    width: 800px;
    max-width: 100%;
    margin: 20px auto;
  }
  #player-container {
    width: 100%;
    aspect-ratio: 16/9;
  }
  video, iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: block;
  }

  /* أزرار التشغيل */
  #controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 10px auto;
  }
  #url-input {
    padding: 8px;
    border-radius: 6px;
    border: none;
    background: #1e293b;
    color: white;
    width: 250px;
  }
  #load-btn, #file-btn {
    background: none;
    border: 1px solid #6366f1;
    color: #6366f1;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
  }

  #twitter-selector {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin-top: 5px;
  }
  #twitter-selector button {
    background: none;
    border: 1px solid #334155;
    color: white;
    padding: 4px 8px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }
  #twitter-selector button.active {
    border-color: #6366f1;
    color: #6366f1;
  }

  /* الدردشة */
  .chat {
    padding: 15px;
    height: calc(100vh - 55px - 350px);
    overflow-y: auto;
    transition: all 0.3s ease;
  }
  .message {
    margin-bottom: 12px;
    font-size: 15px;
    opacity: 0;
    transform: translateY(10px);
    animation: fadeIn 0.3s forwards;
  }
  @keyframes fadeIn {
    to { opacity: 1; transform: translateY(0); }
  }
  .name {
    font-weight: bold;
    color: #93c5fd;
  }
  .timestamp {
    color: #64748b;
    font-size: 12px;
    margin-right: 6px;
  }

  /* مربع الإدخال */
  .input-area {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(2,6,23,0.9);
    padding: 10px;
    display: flex;
    gap: 10px;
  }
  .input-area input {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: none;
    background: #1e293b;
    color: white;
  }
  .input-area button {
    padding: 10px 16px;
    border-radius: 8px;
    border: none;
    background: #6366f1;
    color: white;
    cursor: pointer;
  }

  /* نافذة المتواجدين */
  #membersOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    display: none;
    z-index: 50;
  }
  #membersPanel {
    position: absolute;
    top: 0;
    right: -50%;
    width: 50%;
    max-width: 320px;
    height: 100%;
    background: #0f172a;
    padding: 20px;
    transition: 0.25s ease;
    overflow-y: auto;
  }
  #membersPanel.open {
    right: 0;
  }

  .member {
    padding: 8px 0;
    border-bottom: 1px solid #1e293b;
  }
</style>
</head>
<body>

<div class="header">
  <div class="online-pill" id="openMembers">
    <div class="online-dot"></div>
    <span id="onlineText">0 متواجد الآن</span>
  </div>
</div>

<div id="player-wrapper">
  <div id="player-container">
    <video id="video-element" controls autoplay muted></video>
  </div>
</div>

<div id="controls">
  <input id="url-input" type="text" placeholder="رابط فيديو">
  <button id="load-btn">تشغيل</button>
  <input id="file-input" type="file" accept="video/*" style="display:none;">
  <button id="file-btn">رفع ملف</button>
</div>

<div id="twitter-selector"></div>

<div class="chat" id="messages"></div>

<div class="input-area">
  <input id="chatInput" type="text" placeholder="اكتب رسالة...">
  <button id="sendChat">إرسال</button>
</div>

<div id="membersOverlay">
  <div id="membersPanel">
    <h3>المتواجدون الآن</h3>
    <div id="membersList"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyB1AsEHXP05nQ8M66jYPusheLaE60q_JwU",
  authDomain: "mychat-2d881.firebaseapp.com",
  databaseURL: "https://mychat-2d881-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const ROOM = "public-room";

/* ======== المتواجدون ======== */
const openMembers = document.getElementById("openMembers");
const membersOverlay = document.getElementById("membersOverlay");
const membersPanel = document.getElementById("membersPanel");

openMembers.onclick = () => {
  membersOverlay.style.display = "block";
  setTimeout(() => membersPanel.classList.add("open"), 10);
};
membersOverlay.onclick = e => {
  if (e.target === membersOverlay) {
    membersPanel.classList.remove("open");
    setTimeout(() => membersOverlay.style.display = "none", 200);
  }
};

const presenceRef = db.ref(`rooms/${ROOM}/presence`);
const connectedRef = db.ref(".info/connected");
let myPresence = presenceRef.push();
let myName = "مستخدم";

connectedRef.on("value", snap => {
  if (snap.val() === true) {
    myPresence.onDisconnect().remove();
    myPresence.set({ name: myName, ts: Date.now() });
  }
});

presenceRef.on("value", snap => {
  document.getElementById("onlineText").textContent =
    snap.numChildren() + " متواجد الآن";

  const list = document.getElementById("membersList");
  list.innerHTML = "";
  snap.forEach(child => {
    const v = child.val();
    list.innerHTML += `<div class="member">${v.name}</div>`;
  });
});

/* ======== الدردشة ======== */
const messages = document.getElementById("messages");
const chatInput = document.getElementById("chatInput");
const sendChat = document.getElementById("sendChat");
const chatRef = db.ref(`rooms/${ROOM}/chat`);

function addMessage(msg){
  messages.innerHTML += `
    <div class="message">
      <span class="name">${msg.name}</span>
      <span class="timestamp">${new Date(msg.ts).toLocaleTimeString()}</span>
      <div>${msg.text}</div>
    </div>
  `;
  // عرض آخر 10 رسائل فقط
  const allMessages = messages.querySelectorAll(".message");
  if(allMessages.length>10){
    allMessages[0].remove();
  }
  messages.scrollTop = messages.scrollHeight;
}

sendChat.onclick = () => {
  const text = chatInput.value.trim();
  if (!text) return;
  chatRef.push({ name: myName, text, ts: Date.now() });
  chatInput.value = "";
};

chatRef.on("child_added", snap => {
  addMessage(snap.val());
});

/* ======== المشغل + مزامنة الفيديو ======== */
const videoEl = document.getElementById("video-element");
const urlInput = document.getElementById("url-input");
const loadBtn = document.getElementById("load-btn");
const fileBtn = document.getElementById("file-btn");
const fileInput = document.getElementById("file-input");
const twitterSelector = document.getElementById("twitter-selector");

let videoStateRef = db.ref(`rooms/${ROOM}/videoState`);
let isSyncing = false;
let ytPlayer = null;
let currentType = "video";
let hls = null;

/* ===== دوال مساعدة ===== */
function isYouTube(url){ return /youtube\.com|youtu\.be/.test(url); }
function getYouTubeID(url){ const m=url.match(/(?:v=|\/)([a-zA-Z0-9_-]{11})/); return m?m[1]:null; }
function isTwitter(url){ return /twitter\.com|x\.com/.test(url); }
function isDirect(url){ return /\.(mp4|webm|ogg)$/i.test(url); }
function isM3U8(url){ return /\.m3u8$/i.test(url); }

function detectType(url){
  if(isYouTube(url)) return "youtube";
  if(isTwitter(url)) return "twitter";
  if(isM3U8(url)) return "m3u8";
  if(isDirect(url)) return "video";
  return "unknown";
}

/* ===== دالة تحميل يوتيوب احترافية ===== */
function loadYouTube(videoId){
  currentType = "youtube";

  document.getElementById("player-container").innerHTML =
    `<div id="yt-player"></div>`;

  ytPlayer = new YT.Player('yt-player', {
    videoId: videoId,
    playerVars: { autoplay: 1, rel: 0 },
    events: {
      onReady: () => {},
      onStateChange: (event) => {
        if(isSyncing) return;
        if(event.data === YT.PlayerState.PLAYING){
          videoStateRef.update({ playing:true, currentTime:ytPlayer.getCurrentTime(), updatedAt:Date.now() });
        }
        if(event.data === YT.PlayerState.PAUSED){
          videoStateRef.update({ playing:false, currentTime:ytPlayer.getCurrentTime(), updatedAt:Date.now() });
        }
      }
    }
  });
}

/* ===== دالة تطبيق حالة الفيديو ===== */
function applyState(state){
  if(!state) return;
  if(state.type==="youtube" && ytPlayer){
    ytPlayer.seekTo(state.currentTime||0,true);
    state.playing?ytPlayer.playVideo():ytPlayer.pauseVideo();
  }
  if(state.type==="video"){
    const v = document.querySelector("#video-element");
    if(!v) return;
    v.currentTime = state.currentTime||0;
    state.playing?v.play().catch(()=>{}):v.pause();
  }
  if(state.type==="m3u8" && videoEl){
    if(!hls) hls = new Hls();
    hls.loadSource(state.url);
    hls.attachMedia(videoEl);
    videoEl.currentTime = state.currentTime||0;
    state.playing?videoEl.play():videoEl.pause();
  }
}

/* ===== تحميل أي رابط ===== */
loadBtn.onclick = async () => {
  const url = urlInput.value.trim();
  if(!url) return;

  videoEl.src = "";
  twitterSelector.innerHTML = "";

  const type = detectType(url);
  currentType = type;

  if(type==="youtube"){
    const id = getYouTubeID(url);
    loadYouTube(id);
    await videoStateRef.set({ url:url, type:"youtube", playing:true, currentTime:0, updatedAt:Date.now() });
    return;
  }

  if(type==="video"){
    videoEl.src = url;
    videoEl.play();
    await videoStateRef.set({ url:url, type:"video", playing:true, currentTime:0, updatedAt:Date.now() });
    return;
  }

  if(type==="m3u8"){
    if(Hls.isSupported()){
      if(hls) hls.destroy();
      hls = new Hls();
      hls.loadSource(url);
      hls.attachMedia(videoEl);
      videoEl.play();
    }
    await videoStateRef.set({ url:url, type:"m3u8", playing:true, currentTime:0, updatedAt:Date.now() });
    return;
  }

  if(type==="twitter"){
    const id = url.match(/status\/(\d+)/)[1];
    const res = await fetch(`https://api.vxtwitter.com/i/status/${id}`);
    const data = await res.json();
    data.media_extended.forEach((m,i)=>{
      const btn = document.createElement("button");
      btn.textContent = "مقطع "+(i+1);
      btn.onclick=()=>{
        twitterSelector.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        videoEl.src=m.url;
        videoEl.play();
        videoStateRef.set({ url:m.url, type:"video", playing:true, currentTime:0, updatedAt:Date.now() });
      };
      twitterSelector.appendChild(btn);
    });
    twitterSelector.querySelector("button").click();
  }
};

/* ===== رفع ملف ===== */
fileBtn.onclick=()=>fileInput.click();
fileInput.onchange=()=>{
  const file=fileInput.files[0];
  if(!file) return;
  videoEl.src=URL.createObjectURL(file);
  videoEl.play();
  videoStateRef.set({ url:videoEl.src, type:"video", playing:true, currentTime:0, updatedAt:Date.now() });
};

/* ===== مزامنة تشغيل/إيقاف الفيديو ===== */
document.addEventListener("play",e=>{
  if(currentType==="video" && e.target.tagName==="VIDEO" && !isSyncing){
    videoStateRef.update({ playing:true, currentTime:e.target.currentTime, updatedAt:Date.now() });
  }
},true);
document.addEventListener("pause",e=>{
  if(currentType==="video" && e.target.tagName==="VIDEO" && !isSyncing){
    videoStateRef.update({ playing:false, currentTime:e.target.currentTime, updatedAt:Date.now() });
  }
},true);

/* ===== الاستماع لجميع المستخدمين ===== */
videoStateRef.on("value",snap=>{
  const state = snap.val();
  if(!state) return;
  isSyncing = true;
  applyState(state);
  setTimeout(()=>isSyncing=false,500);
});
</script>
</body>
</html>
