<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø´Ø§Øª Ø®Ø§Øµ</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:tahoma}
body{background:#36393f;color:#fff;height:100vh;overflow:hidden}

/* ===== LOGIN ===== */
#loginScreen{
  height:100vh;display:flex;flex-direction:column;
  justify-content:center;align-items:center
}
#loginScreen input{padding:10px;margin-bottom:8px}
#loginScreen button{padding:8px 16px}

/* ===== CHAT ===== */
#chatScreen{display:none;height:100vh}

/* ===== TOP BAR ===== */
#topBar{
  position:fixed;top:0;width:100%;
  background:#2f3136;
  padding:8px 12px;
  font-size:13px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  z-index:20;
}

#onlineBtn{
  cursor:pointer;
  color:#9aff9a;
}

/* ===== POPUP ===== */
#overlay{
  position:fixed;top:0;left:0;
  width:100%;height:100%;
  background:rgba(0,0,0,0.5);
  display:none;
  z-index:30;
}

#onlinePopup{
  background:#2f3136;
  width:260px;
  max-height:70vh;
  overflow-y:auto;
  padding:12px;
  border-radius:8px;
  position:absolute;
  top:60px;
  right:10px;
}

#onlinePopup h4{
  margin-bottom:8px;
  font-size:14px;
  text-align:center;
}

.user{font-size:13px;margin-bottom:6px}

/* ===== MESSAGES ===== */
.messages{
  position:absolute;
  top:45px;
  bottom:110px;
  width:100%;
  overflow-y:auto;
  padding:10px;
}

.message{margin-bottom:10px}
.name{font-weight:bold;font-size:14px}
.text{margin-top:2px}

.video iframe,.video video{
  width:100%;max-width:560px;height:315px;
  margin-top:5px;border-radius:6px
}

/* ===== TYPING ===== */
#typingStatus{
  position:fixed;
  bottom:70px;
  padding:5px 10px;
  font-size:13px;
  color:#aaa;
}

/* ===== INPUT ===== */
.input-box{
  position:fixed;
  bottom:0;
  width:100%;
  background:#40444b;
}
.input-row{display:flex;padding:8px}
.input-row input{
  flex:1;border:none;padding:10px;border-radius:20px
}
.input-row button{
  margin-left:6px;border:none;border-radius:20px;
  padding:10px;background:#7289da;color:#fff
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen">
  <input id="usernameInput" placeholder="Ø§Ø³Ù…Ùƒ">
  <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- CHAT -->
<div id="chatScreen">

  <!-- TOP BAR -->
  <div id="topBar">
    <span id="myStatus">ðŸŸ¢ Ù…ØªØµÙ„</span>
    <span id="onlineBtn">Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† (<span id="onlineCount">0</span>)</span>
  </div>

  <!-- POPUP -->
  <div id="overlay" onclick="closePopup()">
    <div id="onlinePopup" onclick="event.stopPropagation()">
      <h4>Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø§Ù„Ø¢Ù†</h4>
      <div id="onlineUsersList"></div>
    </div>
  </div>

  <!-- CHAT -->
  <div class="messages" id="messages"></div>
  <div id="typingStatus"></div>

  <!-- INPUT -->
  <div class="input-box">
    <div class="input-row">
      <input id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø£Ùˆ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨">
      <button onclick="send()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>

</div>

<script>
// ===== FIREBASE =====
firebase.initializeApp({
  apiKey: "AIzaSyB1AsEHXP05nQ8M66jYPusheLaE60q_JwU",
  databaseURL: "https://mychat-2d881-default-rtdb.firebaseio.com"
});

const db = firebase.database();
const chatRef = db.ref("messages");
const typingRef = db.ref("typing");
const onlineRef = db.ref("onlineUsers");
const connectedRef = db.ref(".info/connected");

let username="";

// ===== LOGIN =====
function login(){
  username=usernameInput.value.trim();
  if(!username)return;

  loginScreen.style.display="none";
  chatScreen.style.display="block";

  connectedRef.on("value",snap=>{
    if(snap.val()){
      const ref=onlineRef.child(username);
      ref.set({status:"online",lastActive:Date.now()});
      ref.onDisconnect().remove();
    }
  });
}

// ===== VIDEO =====
function extractVideo(text){
  const yt=text.match(/(?:youtube\.com\/(?:watch\?v=|shorts\/)|youtu\.be\/)([A-Za-z0-9_-]{11})/);
  if(yt)return{type:"youtube",id:yt[1]};
  const mp4=text.match(/https?:\/\/\S+\.(mp4|webm|ogg)/i);
  if(mp4)return{type:"file",id:mp4[0]};
  return null;
}

// ===== SEND =====
function send(){
  const txt=messageInput.value.trim();
  if(!txt)return;
  const v=extractVideo(txt);

  chatRef.push({
    user:username,
    text:txt,
    videoType:v?v.type:null,
    videoId:v?v.id:null,
    time:Date.now()
  });

  messageInput.value="";
  typingRef.child(username).remove();
}

// ENTER
messageInput.addEventListener("keydown",e=>{
  if(e.key==="Enter"){e.preventDefault();send();}
});

// ===== TYPING =====
let tmr;
messageInput.addEventListener("input",()=>{
  typingRef.child(username).set(true);
  clearTimeout(tmr);
  tmr=setTimeout(()=>typingRef.child(username).remove(),1500);
});

typingRef.on("value",snap=>{
  const u=Object.keys(snap.val()||{}).filter(x=>x!==username);
  typingStatus.textContent=u.length?`${u[0]} ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†...`:"";
});

// ===== ONLINE USERS =====
onlineRef.on("value",snap=>{
  const users=snap.val()||{};
  const names=Object.keys(users);
  onlineCount.textContent=names.length;
  onlineUsersList.innerHTML=names.map(n=>
    n===username?`ðŸŸ¢ <b>${n} (Ø£Ù†Øª)</b>`:`ðŸŸ¢ ${n}`
  ).join("<br>");
});

// POPUP
onlineBtn.onclick=()=>overlay.style.display="block";
function closePopup(){overlay.style.display="none";}

// ===== RENDER =====
chatRef.limitToLast(50).on("child_added",snap=>{
  const d=snap.val();
  const div=document.createElement("div");
  div.className="message";
  div.innerHTML=`<div class="name">${d.user}</div><div class="text">${d.text}</div>`;
  if(d.videoType==="youtube")
    div.innerHTML+=`<div class="video"><iframe src="https://www.youtube.com/embed/${d.videoId}" allowfullscreen></iframe></div>`;
  if(d.videoType==="file")
    div.innerHTML+=`<div class="video"><video controls src="${d.videoId}"></video></div>`;
  messages.appendChild(div);
  messages.scrollTop=messages.scrollHeight;
});
</script>

</body>
</html>
