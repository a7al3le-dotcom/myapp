<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>شات خاص</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:Tahoma;height:100vh;display:flex;flex-direction:column;}

/* شاشة تسجيل الاسم */
#loginScreen{display:flex;flex-direction:column;justify-content:center;align-items:center;flex:1;background:#ececec;}
#loginScreen input{padding:10px;font-size:16px;width:80%;max-width:300px;margin-bottom:10px;}
#loginScreen button{padding:10px 20px;font-size:16px;cursor:pointer;}

/* شاشة الدردشة */
#chatScreen{display:none;flex-direction:column;flex:1;height:100%;}

/* الرسائل */
.messages{flex:1;overflow-y:auto;padding:10px;background:#f5f5f5;}
.message{margin-bottom:12px;font-size:14px;width:100%;}
.message-header{display:flex;justify-content:space-between;margin-bottom:2px;}
.message .name{font-weight:bold;}
.message .time{color:gray;font-size:12px;}
.video{margin-top:4px;}
.thumb{width:100%;max-width:300px;border-radius:4px;cursor:pointer;}
.player{display:none;margin-top:4px;}
.player iframe{width:100%;height:210px;border:none;border-radius:4px;}

/* إدخال الرسائل */
.input-box{display:flex;border-top:1px solid #ddd;padding:6px;background:#fff;}
.input-box input{flex:1;padding:10px;font-size:16px;}
.input-box button{padding:0 16px;font-size:16px;margin-left:6px;cursor:pointer;}

/* Responsive للجوال */
@media(max-width:480px){
    .thumb, .player iframe{max-width:100%;}
}
</style>
</head>

<body>

<!-- شاشة تسجيل الاسم -->
<div id="loginScreen">
    <h3>أدخل اسمك للدخول للدردشة</h3>
    <input type="text" id="usernameInput" placeholder="اسمك">
    <div id="loginError" style="color:red;margin-top:6px;"></div>
    <button onclick="login()">دخول</button>
</div>

<!-- شاشة الدردشة -->
<div id="chatScreen">
    <div class="messages" id="messages"></div>
    <div class="input-box">
        <input type="text" id="messageInput" placeholder="اكتب رسالة أو رابط يوتيوب">
        <button onclick="sendMessageByButton()">إرسال</button>
    </div>
</div>

<script>
// ============================
// Firebase Config
// ============================
const firebaseConfig = {
    apiKey: "AIzaSyB1AsEHXP05nQ8M66jYPusheLaE60q_JwU",
    authDomain: "mychat-2d881.firebaseapp.com",
    databaseURL: "https://mychat-2d881-default-rtdb.firebaseio.com",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const chatRef = db.ref("messages");
const usersRef = db.ref("users"); 

// ============================
// المتغيرات
// ============================
let username = "";

// ============================
// تسجيل الدخول
// ============================
function login(){
    const input = document.getElementById("usernameInput");
    const name = input.value.trim();
    const error = document.getElementById("loginError");

    if(!name){
        error.textContent = "الرجاء إدخال اسم صالح";
        return;
    }

    usersRef.once("value", snap=>{
        const users = snap.val() || {};
        if(users[name]){
            error.textContent = "هذا الاسم موجود بالفعل، اختر اسم آخر";
        } else {
            usersRef.child(name).set(true);
            username = name;
            document.getElementById("loginScreen").style.display="none";
            document.getElementById("chatScreen").style.display="flex";
            document.getElementById("messageInput").focus();
        }
    });
}

// ============================
// YouTube Helpers
// ============================
function getYouTubeID(text){
    const reg = /(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
    const match = text.match(reg);
    return match ? match[1] : null;
}

function removeYouTubeURL(text){
    return text.replace(/(https?:\/\/)?(www\.)?(youtube\.com\/\S+|youtu\.be\/\S+)/g,"").trim();
}

function videoHTML(videoId){
    return `
        <div class="video">
            <img class="thumb"
                 src="https://img.youtube.com/vi/${videoId}/0.jpg"
                 onclick="this.style.display='none';
                          this.nextElementSibling.style.display='block'">
            <div class="player">
                <iframe
                  src="https://www.youtube.com/embed/${videoId}?autoplay=1"
                  allow="autoplay; encrypted-media"
                  allowfullscreen></iframe>
            </div>
        </div>
    `;
}

// ============================
// إرسال رسالة
// ============================
function sendMessage(input){
    const rawText = input.value.trim();
    if(!rawText || !username) return;

    const videoId = getYouTubeID(rawText);
    const cleanText = removeYouTubeURL(rawText);

    chatRef.push({
        user: username,
        text: cleanText || null,
        videoId: videoId || null,
        time: Date.now()  
    });

    input.value = "";
}

// زر الإرسال
function sendMessageByButton(){
    const input = document.getElementById("messageInput");
    sendMessage(input);
}

// Enter لإرسال
document.getElementById("messageInput").addEventListener("keydown", function(e){
    if(e.key === "Enter") sendMessage(this);
});

// ============================
// استقبال الرسائل لحظيًا
// ============================
chatRef.limitToLast(100).on("child_added", snap => {
    const data = snap.val();
    renderMessage(data);
});

// ============================
// عرض رسالة مع الوقت بالعربي
// ============================
function renderMessage(data){
    const messages = document.getElementById("messages");
    const msg = document.createElement("div");
    msg.className = "message";

    // header: الاسم + الوقت
    const headerDiv = document.createElement("div");
    headerDiv.className = "message-header";

    const nameDiv = document.createElement("span");
    nameDiv.className = "name";
    nameDiv.textContent = data.user;

    const timeDiv = document.createElement("span");
    timeDiv.className = "time";

    const date = new Date(data.time);
    let hours = date.getHours();
    const minutes = date.getMinutes().toString().padStart(2,'0');
    let period = "ص"; // صباحًا
    if(hours >= 12){
        period = "م"; // مساءً
        if(hours > 12) hours -= 12;
    }
    if(hours === 0) hours = 12;
    timeDiv.textContent = `${hours}:${minutes} ${period}`;

    headerDiv.appendChild(nameDiv);
    headerDiv.appendChild(timeDiv);
    msg.appendChild(headerDiv);

    // النص
    if(data.text){
        const t = document.createElement("div");
        t.textContent = data.text;
        msg.appendChild(t);
    }

    // الفيديو
    if(data.videoId){
        msg.insertAdjacentHTML("beforeend", videoHTML(data.videoId));
    }

    messages.appendChild(msg);
    messages.scrollTop = messages.scrollHeight;
}
</script>

</body>
</html>
