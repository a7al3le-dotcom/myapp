<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>شات خاص</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:tahoma}
body{background:#36393f;color:#fff;height:100vh;display:flex;flex-direction:column}
#loginScreen,#chatScreen{flex:1}
#loginScreen{display:flex;flex-direction:column;justify-content:center;align-items:center}
#chatScreen{display:none;flex-direction:column}
.messages{flex:1;overflow-y:auto;padding:10px;margin-bottom:70px}
.message{margin-bottom:10px}
.name{font-weight:bold}
.video iframe,.video video{width:100%;max-width:560px;height:315px;margin-top:5px;border-radius:6px}
.input-box{position:fixed;bottom:0;width:100%;display:flex;background:#40444b;padding:8px}
.input-box input{flex:1;border:none;padding:10px;border-radius:20px}
.input-box button{margin-left:6px;border:none;border-radius:20px;padding:10px;background:#7289da;color:#fff}
</style>
</head>

<body>

<div id="loginScreen">
    <input id="usernameInput" placeholder="اسمك">
    <button onclick="login()">دخول</button>
    <div id="loginError"></div>
</div>

<div id="chatScreen">
    <div class="messages" id="messages"></div>
    <div class="input-box">
        <input id="messageInput" placeholder="اكتب رسالة أو رابط يوتيوب">
        <button onclick="send()">إرسال</button>
    </div>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyB1AsEHXP05nQ8M66jYPusheLaE60q_JwU",
  databaseURL: "https://mychat-2d881-default-rtdb.firebaseio.com"
});

const db = firebase.database();
const chatRef = db.ref("messages");
let username="";

// ========= LOGIN =========
function login(){
  username=usernameInput.value.trim();
  if(!username)return;
  loginScreen.style.display="none";
  chatScreen.style.display="flex";
}

// ========= VIDEO DETECTION =========
function extractVideo(text){
  let yt = text.match(/(?:youtube\.com\/(?:watch\?v=|shorts\/)|youtu\.be\/)([A-Za-z0-9_-]{11})/);
  if(yt){
    return {type:"youtube",id:yt[1]};
  }

  let mp4=text.match(/https?:\/\/\S+\.(mp4|webm|ogg)/i);
  if(mp4){
    return {type:"file",id:mp4[0]};
  }

  return null;
}

// ========= SEND =========
function send(){
  const txt=messageInput.value.trim();
  if(!txt)return;

  const video=extractVideo(txt);

  chatRef.push({
    user:username,
    text: txt,
    videoType: video ? video.type : null,
    videoId: video ? video.id : null,
    time:Date.now()
  });

  messageInput.value="";
}

// ========= RENDER =========
chatRef.limitToLast(50).on("child_added",snap=>{
  const d=snap.val();
  const div=document.createElement("div");
  div.className="message";

  div.innerHTML=`<div class="name">${d.user}</div>
                 <div>${d.text}</div>`;

  if(d.videoType==="youtube"){
    div.innerHTML+=`
      <div class="video">
        <iframe src="https://www.youtube.com/embed/${d.videoId}"
        allowfullscreen></iframe>
      </div>`;
  }

  if(d.videoType==="file"){
    div.innerHTML+=`
      <div class="video">
        <video controls src="${d.videoId}"></video>
      </div>`;
  }

  messages.appendChild(div);
  messages.scrollTop=messages.scrollHeight;
});
</script>

</body>
</html>
