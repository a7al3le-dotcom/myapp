<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">

  <!-- الإضافة الوحيدة للجوال -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>غرفة الدردشة</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <style>
    /* الإضافة الوحيدة للجوال */
    html, body {
      width: 100%;
      overflow-x: hidden;
    }

    body {
      margin: 0; font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      background-color: #f9f9f9; display: flex; flex-direction: column;
      height: 100vh; overflow: hidden;
    }

    #login-screen {
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-color: #545E6B; z-index: 100;
    }
    .login-box { background-color: #fff; padding: 30px; text-align: center; width: 300px; }
    .login-box h2 { margin-top: 0; margin-bottom: 20px; color: #333; }
    #username-input { width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ccc; box-sizing: border-box; }
    #login-btn { width: 100%; padding: 10px; border: none; background-color: #545E6B; color: white; font-size: 16px; cursor: pointer; }
    #login-error { color: red; margin-top: 10px; display: none; }

    #chat-container { display: none; flex-direction: column; height: 100%; }

    .messages { flex: 1; overflow-y: auto; padding: 0; background: #fff; }
    .uzr {
      display: flex; width: 100%; border-bottom: 1px solid lavender;
      margin: 0; padding: 4px 2px; background: #fff;
    }
    .u-pic {
      min-width: 52px; width: 52px; height: 46px; background-color: #f3f3f3;
      background-size: cover; background-position: center; border: 1px solid #ddd; cursor: pointer;
    }
    .msg-body {
      flex: 1; padding-left: 5px; padding-top: 1px; display: flex;
      flex-direction: column; overflow: hidden;
    }
    .msg-top {
      display: flex; justify-content: space-between; height: 21px;
      align-items: center; width: 100%;
    }
    .user-wrapper { display: flex; align-items: center; }
    .u-ico { min-height: 14px; height: 14px; margin-right: 2px; }

    .u-topic {
      padding: 1px 4px;
      margin-left: 4px;
      border-radius: 0;
      color: #000;
      background-color: transparent;
      border: none;
      font-size: 14px;
      font-weight: bold;
    }
    .minix { font-size: 11px; color: grey; margin-right: 5px; }
    .u-msg {
      padding: 1px 1px 1px 5px; width: 100%; color: #000;
      font-size: 14px;
      word-wrap: break-word; text-align: left;
    }

    .tablebox.footer {
      width: 100%; padding: 2px; background: #fff;
      display: flex; align-items: center;
    }
    .tablebox.footer img.emobox { padding: 5px; width: 34px; height: 34px; cursor: pointer; }
    .tablebox.footer .tbox {
      flex: 1; height: 34px; resize: none; border: 1px solid #ccc;
      padding: 5px; margin: 0; border-radius: 0;
      font-size: 14px;
    }

    .tablebox.footer .btn {
      height: 34px; margin: 0; border-radius: 0; width: auto;
      padding: 6px 8px;
      font-size: 14px;
    }

    .btn.btn-primary {
      background-color: #545E6B;
      border-color: #4A5361;
    }

    .actions-footer {
      display: flex; width: 100%; background-color: #545E6B;
      padding: 2px; justify-content: flex-start; gap: 3px;
    }

    .action-btn {
      width: 80px; height: 31.58px; display: flex;
      justify-content: center; align-items: center;
      border: 1px solid #000;
      padding: 0 5px;
      border-radius: 0;
      font-size: 14px;
      color: white;
      background-color: #545E6B; cursor: pointer;
      white-space: nowrap; flex-shrink: 0;
    }
  </style>
</head>

<body>

<div id="login-screen">
  <div class="login-box">
    <h2>دخول الدردشة</h2>
    <input type="text" id="username-input" placeholder="اكتب اسمك هنا">
    <button id="login-btn">دخول</button>
    <p id="login-error">الرجاء إدخال اسم.</p>
  </div>
</div>

<div id="chat-container">
  <div id="messages" class="messages"></div>

  <div class="tablebox footer">
    <img class="emobox" src="https://l7b.net/imgs/emoii.gif">
    <textarea id="message-input" placeholder="اكتب رسالتك هنا" class="tbox" style="text-align:left;"></textarea>
    <button id="send-btn" class="btn btn-primary"><i class="fa fa-send"></i>ارسال</button>
  </div>

  <div id="d0" class="actions-footer">
    <button id="btn-users" class="action-btn fa fa-user"><span id="busers">0</span></button>
    <button id="btn-chats" class="action-btn fa fa-comment">خاص</button>
    <button id="btn-rooms" class="action-btn fa fa-users">الغرف</button>
    <button id="btn-wall" class="action-btn fa fa-commenting"><span id="bwall">0</span>الحائط</button>
    <button id="btn-settings" class="action-btn fa fa-gear">الضبط</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getDatabase, ref, onChildAdded, push } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB1AsEHXP05nQ8M66jYPusheLaE60q_JwU",
    authDomain: "mychat-2d881.firebaseapp.com",
    databaseURL: "https://mychat-2d881-default-rtdb.firebaseio.com",
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const messagesRef = ref(db, "messages");

  let currentUsername = null;

  const loginScreen = document.getElementById("login-screen");
  const chatContainer = document.getElementById("chat-container");
  const usernameInput = document.getElementById("username-input");
  const loginButton = document.getElementById("login-btn");
  const loginError = document.getElementById("login-error");
  const messagesContainer = document.getElementById("messages");
  const messageInput = document.getElementById("message-input");
  const sendButton = document.getElementById("send-btn");

  function enterChat(username) {
    currentUsername = username;
    localStorage.setItem("chat_username", username);
    loginScreen.style.display = "none";
    chatContainer.style.display = "flex";

    onChildAdded(messagesRef, (snapshot) => {
      displayMessage(snapshot.val());
    });
  }

  loginButton.addEventListener("click", () => {
    const username = usernameInput.value.trim();
    if (username) enterChat(username);
    else loginError.style.display = "block";
  });

  const savedUsername = localStorage.getItem("chat_username");
  if (savedUsername) enterChat(savedUsername);

  function displayMessage(data) {
    const msgDiv = document.createElement("div");
    msgDiv.className = "uzr";
    msgDiv.innerHTML = `
      <div class="u-pic" style="background-image:url('https://l7b.net/pic/default.png')"></div>
      <div class="msg-body">
        <div class="msg-top">
          <div class="user-wrapper">
            <img class="u-ico" src="https://l7b.net/sico/z1g351o4em1018XOCi04iHr0.gif">
            <span class="u-topic">${data.user}</span>
          </div>
          <span class="minix">${data.time}</span>
        </div>
        <div class="u-msg">${data.text}</div>
      </div>`;
    messagesContainer.appendChild(msgDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function sendMessage() {
    const text = messageInput.value.trim();
    if (!text || !currentUsername) return;

    const now = new Date();
    push(messagesRef, {
      user: currentUsername,
      text: text,
      time: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
    });

    messageInput.value = "";
  }

  sendButton.addEventListener("click", sendMessage);
</script>

</body>
</html>
