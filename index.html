<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ø´Ø§Øª Ø®Ø§Øµ</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
body{background:#36393f;color:#fff;height:100vh;overflow:hidden;touch-action:pan-y}

/* ===== LOGIN ===== */
#loginScreen{height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:20px;background: linear-gradient(135deg, #36393f 0%, #2f3136 100%);}
#loginContainer{background:#2f3136;padding:30px;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.3);width:100%;max-width:400px;}
#loginScreen h2{margin-bottom:20px;text-align:center;color:#7289da;}
#loginScreen input{padding:12px 15px;margin-bottom:15px;width:100%;border:2px solid #40444b;border-radius:8px;background:#40444b;color:#fff;font-size:16px;}
#loginScreen input:focus{outline:none;border-color:#7289da;}
#loginScreen button{padding:12px 20px;width:100%;background:#7289da;color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;transition:background 0.3s;}
#loginScreen button:hover{background:#5f73bc;}
#loginScreen button:active{transform:scale(0.98);}

/* ===== CHAT ===== */
#chatScreen{display:none;height:100vh;position:relative}

/* ===== TOP BAR ===== */
#topBar{position:fixed;top:0;width:100%;background:#2f3136;padding:12px 16px;font-size:14px;display:flex;justify-content:space-between;align-items:center;z-index:20;border-bottom:1px solid #202225;height:60px;}
#myStatus{color:#43b581;font-weight:bold;}
#onlineBtn, #adminBtn{cursor:pointer;background:#202225;padding:6px 12px;border-radius:6px;font-size:13px;transition:background 0.3s;margin-left:8px;}
#onlineBtn:active, #adminBtn:active{background:#36393f;}

/* ===== POPUPS ===== */
#overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;z-index:30;animation:fadeIn 0.3s;}
@keyframes fadeIn{from{opacity:0} to{opacity:1}}
#onlinePopup,#adminPopup{background:#2f3136;width:90%;max-width:400px;max-height:80vh;overflow-y:auto;padding:16px;border-radius:12px;position:absolute;top:70px;right:5%;border:1px solid #202225;box-shadow:0 4px 20px rgba(0,0,0,0.5);}
#onlinePopup h4,#adminPopup h4{margin-bottom:12px;font-size:16px;text-align:center;color:#7289da;padding-bottom:8px;border-bottom:1px solid #40444b;}
.user{font-size:14px;margin-bottom:8px;padding:6px 10px;border-radius:6px;transition:background 0.2s;}
.user:hover{background:#40444b;}
.user.you{background:rgba(114,137,218,0.2);border-right:3px solid #7289da;}

/* ===== MESSAGES ===== */
.messages{position:absolute;top:60px;bottom:110px;width:100%;overflow-y:auto;padding:10px;display:flex;flex-direction:column-reverse;scroll-behavior:smooth;direction:rtl;}
.messages::-webkit-scrollbar{width:6px}
.messages::-webkit-scrollbar-track{background:#2f3136}
.messages::-webkit-scrollbar-thumb{background:#7289da;border-radius:3px}
.messages::-webkit-scrollbar-thumb:hover{background:#5f73bc}

.message{margin-bottom:12px;padding:8px 12px;border-radius:8px;animation:fadeInUp 0.3s;word-wrap:break-word;display:flex;align-items:center;gap:6px;}
@keyframes fadeInUp{from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)}}
.name{font-weight:bold;font-size:14px;color:#7289da;}
.text{font-size:15px;line-height:1.4;}
.time{font-size:11px;color:#aaa;}

/* ===== TYPING ===== */
#typingStatus{position:fixed;bottom:70px;padding:4px 12px;font-size:13px;color:#aaa;right:16px;}

/* ===== INPUT ===== */
.input-box{position:fixed;bottom:0;width:100%;background:#2f3136;border-top:1px solid #202225;padding:8px 0;}
.input-row{display:flex;padding:0 8px;gap:8px;}
.input-row input{flex:1;border:none;padding:12px 16px;border-radius:25px;background:#40444b;color:#fff;font-size:15px;min-height:44px;}
.input-row input:focus{outline:none;}
.input-row button{border:none;border-radius:50%;width:44px;height:44px;background:#7289da;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.3s;font-size:18px;}
.input-row button:active{background:#5f73bc;transform:scale(0.95);}

/* ===== CONNECTION STATUS ===== */
#connectionStatus{position:fixed;top:60px;width:100%;background:#faa81a;color:#000;text-align:center;padding:10px;font-size:14px;z-index:15;display:none;font-weight:bold;}

/* ===== LOADING ===== */
.loading{text-align:center;padding:20px;color:#aaa;font-size:14px;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
    <div id="loginContainer">
        <h2>ğŸ’¬ Ø´Ø§Øª Ø®Ø§Øµ</h2>
        <input id="usernameInput" placeholder="Ø§Ø³Ù…Ùƒ (Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)" autocomplete="off">
        <button onclick="login()" id="loginBtn">Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Øª</button>
    </div>
</div>

<!-- CHAT -->
<div id="chatScreen">
    <div id="topBar">
        <span id="myStatus">ğŸŸ¢ Ù…ØªØµÙ„</span>
        <div>
            <span id="onlineBtn">ğŸ‘¥ Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† (<span id="onlineCount">0</span>)</span>
            <span id="adminBtn">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
        </div>
    </div>

    <div id="connectionStatus">ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...</div>

    <!-- POPUPS -->
    <div id="overlay" onclick="closePopup()">
        <div id="onlinePopup" onclick="event.stopPropagation()">
            <h4>ğŸ‘¥ Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø§Ù„Ø¢Ù†</h4>
            <div id="onlineUsersList"></div>
        </div>
        <div id="adminPopup" onclick="event.stopPropagation()">
            <h4>âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h4>
            <div id="adminControls">
                <h5>ğŸ”¹ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø´Ø§Øª</h5>
                <button onclick="clearMessages()">ğŸ§¹ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</button>
                <button onclick="toggleTyping()">âœï¸ Ø§Ù„Ø³Ù…Ø§Ø­/Ø­Ø¸Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©</button>
                <h5>ğŸ”¹ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h5>
                <button onclick="kickAll()">ğŸš« Ø·Ø±Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
                <button onclick="kickUserPrompt()">ğŸ‘¤ Ø·Ø±Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯Ø¯</button>
            </div>
        </div>
    </div>

    <!-- CHAT -->
    <div class="messages" id="messages">
        <div class="loading">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</div>
    </div>
    <div id="typingStatus"></div>

    <!-- INPUT -->
    <div class="input-box">
        <div class="input-row">
            <input id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø£Ùˆ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨/ØµÙˆØ±Ø©" autocomplete="off">
            <button onclick="send()" id="sendBtn">â¤</button>
        </div>
    </div>
</div>

<script>
// ===== FIREBASE CONFIG =====
const firebaseConfig = {
    apiKey: "AIzaSyB1AsEHXP05nQ8M66jYPusheLaE60q_JwU",
    databaseURL: "https://mychat-2d881-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== GLOBAL VARIABLES =====
let username = "";
let messageListeners = [];
let typingListeners = [];
let onlineListeners = [];
let connectionListeners = [];
let lastMessageKey = null;
let isScrolledUp = false;
let adminName = "admin"; // ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§
let typingAllowed = true;

// ===== DOM ELEMENTS =====
const usernameInput = document.getElementById("usernameInput");
const loginScreen = document.getElementById("loginScreen");
const chatScreen = document.getElementById("chatScreen");
const messageInput = document.getElementById("messageInput");
const messages = document.getElementById("messages");
const typingStatus = document.getElementById("typingStatus");
const onlineCount = document.getElementById("onlineCount");
const onlineUsersList = document.getElementById("onlineUsersList");
const overlay = document.getElementById("overlay");
const onlineBtn = document.getElementById("onlineBtn");
const adminBtn = document.getElementById("adminBtn");
const connectionStatus = document.getElementById("connectionStatus");

// ===== LOGIN =====
function login() {
    const rawUsername = usernameInput.value.trim();
    if (!rawUsername || rawUsername.length < 2) { alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ­ÙŠØ­ (Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)"); return; }
    if (rawUsername.length > 20) { alert("Ø§Ù„Ø§Ø³Ù… Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹ (20 Ø­Ø±Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)"); return; }
    username = escapeHtml(rawUsername);
    loginScreen.style.display = "none";
    chatScreen.style.display = "block";
    loadMessages();
    setupConnection();
    setTimeout(()=>{messageInput.focus()},300);
}

// ===== CONNECTION =====
function setupConnection() {
    const connectedRef = db.ref(".info/connected");
    connectedRef.on("value", (snap)=>{
        if(snap.val()){
            connectionStatus.style.display="none";
            const onlineRef = db.ref("onlineUsers/"+encodeURIComponent(username));
            onlineRef.set({name:username,status:"online",lastActive:Date.now()});
            onlineRef.onDisconnect().remove();
            db.ref("typing/"+encodeURIComponent(username)).onDisconnect().remove();
        } else { connectionStatus.style.display="block"; }
    });
    setupOnlineUsers();
    setupTyping();
}

// ===== MESSAGES =====
function loadMessages(){
    const chatRef = db.ref("messages");
    chatRef.limitToLast(50).on("child_added",(snap)=>{
        const data = snap.val(); if(!data) return;
        renderMessage(data);
    });
}

function renderMessage(data){
    const div = document.createElement("div");
    div.className="message";
    div.innerHTML=`<span class="name">${escapeHtml(data.user)}:</span> <span class="text">${escapeHtml(data.text)}</span> <span class="time">${formatTime(data.time)}</span>`;
    messages.insertBefore(div,messages.firstChild);
    if(!isScrolledUp){setTimeout(()=>{messages.scrollTop=0},100);}
}

// ===== SEND MESSAGE =====
function send(){
    if(!typingAllowed){ alert("Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù…Ø­Ø¸ÙˆØ±Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±"); return; }
    const text = messageInput.value.trim();
    if(!text||!username) return;
    const chatRef = db.ref("messages");
    chatRef.push({user:username,text:text,time:Date.now()});
    messageInput.value="";
    db.ref("typing/"+encodeURIComponent(username)).remove();
    messageInput.focus();
}

// ===== TYPING =====
function setupTyping(){
    const typingRef=db.ref("typing");
    messageInput.addEventListener("input",()=>{
        if(!username) return;
        const userTypingRef = db.ref("typing/"+encodeURIComponent(username));
        userTypingRef.set(Date.now());
        clearTimeout(window.typingTimeout);
        window.typingTimeout=setTimeout(()=>{userTypingRef.remove()},2000);
    });
    typingRef.on("value",(snap)=>{
        const data = snap.val()||{}; const now = Date.now();
        const activeTyping = Object.keys(data).filter(key=>decodeURIComponent(key)!==username&&(now-data[key]<2000));
        typingStatus.textContent = activeTyping.length===0?"":`${activeTyping.map(k=>decodeURIComponent(k)).join(", ")} ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†...`;
    });
}

// ===== ONLINE USERS =====
function setupOnlineUsers(){
    const onlineRef = db.ref("onlineUsers");
    onlineRef.on("value",(snap)=>{
        const users = snap.val()||{};
        const userNames = Object.keys(users);
        onlineCount.textContent = userNames.length;
        onlineUsersList.innerHTML = userNames.map(key=>{
            const userData = users[key];
            const userName = userData.name||decodeURIComponent(key);
            const isYou = userName===username;
            return `<div class="user ${isYou?'you':''}">ğŸŸ¢ ${escapeHtml(userName)} ${isYou?'(Ø£Ù†Øª)':''}</div>`;
        }).join('');
    });
}

// ===== POPUPS =====
onlineBtn.onclick = ()=>{overlay.style.display="block";document.getElementById('onlinePopup').style.display="block";document.getElementById('adminPopup').style.display="none";}
adminBtn.onclick = ()=>{ if(username!==adminName){alert("Ù„ÙŠØ³Øª Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©"); return;} overlay.style.display="block";document.getElementById('adminPopup').style.display="block";document.getElementById('onlinePopup').style.display="none";}
function closePopup(){overlay.style.display="none";}

// ===== ADMIN FUNCTIONS =====
function clearMessages(){if(confirm("Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŸ")) db.ref("messages").remove();}
function toggleTyping(){typingAllowed=!typingAllowed;alert(typingAllowed?"ØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø©":"ØªÙ… Ø­Ø¸Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©");}
function kickAll(){if(confirm("Ø·Ø±Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŸ")) db.ref("onlineUsers").remove();}
function kickUserPrompt(){const u=prompt("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø·Ø±Ø¯"); if(u) db.ref("onlineUsers/"+encodeURIComponent(u)).remove();}

// ===== UTILITIES =====
function escapeHtml(text){if(!text) return ''; const div=document.createElement('div'); div.textContent=text; return div.innerHTML;}
function formatTime(ts){const d=new Date(ts); return d.toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit',hour12:true});}

// ===== SCROLL =====
messages.addEventListener('scroll',()=>{
    const scrollTop=messages.scrollTop,scrollHeight=messages.scrollHeight,clientHeight=messages.clientHeight;
    isScrolledUp=scrollTop<scrollHeight-clientHeight-100;
});

// ===== ENTER KEY =====
messageInput.addEventListener("keydown",(e)=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();send();}});

</script>
</body>
</html>
