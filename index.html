<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>public-room</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: 'Tajawal', sans-serif;
    background: #020617;
    color: #e5e7eb;
  }

  /* ===== المشغل ===== */
  #player-container {
    width: 100%;
    background: #000;
    aspect-ratio: 16/9;
  }
  #video-element, iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: block;
  }

  #controls {
    display: flex;
    gap: 10px;
    padding: 10px;
    flex-wrap: wrap;
    justify-content: center;
    background: #0f172a;
  }
  #url-input {
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #334155;
    width: 250px;
    background: #1e293b;
    color: #e5e7eb;
  }
  #load-btn, #file-btn {
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    background: #6366f1;
    color: white;
    cursor: pointer;
  }
  #twitter-selector {
    display: flex;
    gap: 5px;
    padding: 5px;
    justify-content: center;
    flex-wrap: wrap;
  }
  #twitter-selector button {
    padding: 4px 8px;
    background: #334155;
    border: none;
    border-radius: 5px;
    color: white;
    cursor: pointer;
  }
  #twitter-selector button.active {
    background: #6366f1;
  }

  /* ===== الهيدر ===== */
  .header {
    height: 50px;
    background: #0f172a;
    border-bottom: 1px solid #1e293b;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 0 12px;
    gap: 10px;
  }
  .online-pill {
    background: #1e293b;
    padding: 6px 12px;
    border-radius: 999px;
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
  }
  .online-dot {
    width: 8px;
    height: 8px;
    background: #22c55e;
    border-radius: 999px;
  }

  /* ===== الدردشة ===== */
  .chat {
    padding: 12px;
    height: calc(100vh - 50px - (100vw * 9/16) - 70px);
    overflow-y: auto;
  }
  .message {
    display: flex;
    gap: 10px;
    margin-bottom: 12px;
  }
  .avatar {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #0ea5e9, #6366f1);
    border-radius: 999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
  }
  .bubble {
    background: #0f172a;
    padding: 8px 12px;
    border-radius: 10px;
    border: 1px solid #1e293b;
    max-width: 85%;
  }
  .bubble-header {
    display: flex;
    gap: 6px;
    font-size: 12px;
    margin-bottom: 4px;
  }
  .timestamp {
    color: #64748b;
  }

  .input-area {
    display: flex;
    gap: 8px;
    padding: 10px;
    background: #0f172a;
    border-top: 1px solid #1e293b;
  }
  .input-area input {
    flex: 1;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #334155;
    background: #1e293b;
    color: #e5e7eb;
  }
  .input-area button {
    padding: 8px 14px;
    border-radius: 8px;
    border: none;
    background: #6366f1;
    color: white;
    cursor: pointer;
  }

  /* ===== نافذة المتواجدين ===== */
  #membersOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    display: none;
  }
  #membersPanel {
    position: absolute;
    top: 0;
    right: -50%;
    width: 50%;
    height: 100%;
    background: #0f172a;
    border-left: 1px solid #1e293b;
    padding: 15px;
    transition: 0.25s ease;
  }
  #membersPanel.open {
    right: 0;
  }
  .member {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 0;
  }
  .member-avatar {
    width: 28px;
    height: 28px;
    background: #1e293b;
    border-radius: 999px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .member-status-dot {
    width: 8px;
    height: 8px;
    background: #22c55e;
    border-radius: 999px;
  }

  /* ===== شاشة الدخول ===== */
  #loginOverlay {
    position: fixed;
    inset: 0;
    background: #020617;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #loginCard {
    background: #0f172a;
    padding: 20px;
    border-radius: 12px;
    width: 90%;
    max-width: 350px;
    border: 1px solid #1e293b;
  }
  #loginCard input {
    width: 100%;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #334155;
    background: #1e293b;
    color: white;
    margin-bottom: 10px;
  }
  #loginCard button {
    width: 100%;
    padding: 10px;
    background: #6366f1;
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
  }
</style>
</head>
<body>

<!-- شاشة الدخول -->
<div id="loginOverlay">
  <div id="loginCard">
    <h3 style="margin:0 0 10px;">أدخل اسم المستخدم</h3>
    <input id="loginName" type="text" placeholder="مثال: هـ..ــلآ">
    <button id="loginBtn">دخول</button>
    <div id="loginError" style="color:#f87171; font-size:12px; margin-top:6px;"></div>
  </div>
</div>

<!-- المشغل -->
<div id="player-container">
  <video id="video-element" controls autoplay muted></video>
</div>

<div id="twitter-selector"></div>

<div id="controls">
  <input type="text" id="url-input" placeholder="أدخل رابط YouTube / Twitter / M3U8 / MP4">
  <button id="load-btn">تشغيل</button>
  <input type="file" id="file-input" accept="video/*" style="display:none;">
  <button id="file-btn">رفع ملف</button>
</div>

<!-- الهيدر -->
<div class="header">
  <div class="online-pill" id="openMembers">
    <div class="online-dot"></div>
    <span id="onlineText">0 متواجد الآن</span>
  </div>
</div>

<!-- الدردشة -->
<div class="chat" id="messages"></div>

<div class="input-area">
  <input id="chatInput" type="text" placeholder="اكتب رسالة...">
  <button id="sendChat">إرسال</button>
</div>

<!-- نافذة المتواجدين -->
<div id="membersOverlay">
  <div id="membersPanel">
    <h3 style="margin-top:0;">المتواجدون الآن</h3>
    <div id="membersList"></div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey: "AIzaSyB1AsEHXP05nQ8M66jYPusheLaE60q_JwU",
  authDomain: "mychat-2d881.firebaseapp.com",
  databaseURL: "https://mychat-2d881-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const ROOM = "public-room";

/* ===== الدخول ===== */
const loginOverlay = document.getElementById("loginOverlay");
const loginBtn = document.getElementById("loginBtn");
const loginName = document.getElementById("loginName");
const loginError = document.getElementById("loginError");

let myName = null;
let myPresenceRef = null;

loginBtn.onclick = () => {
  const name = loginName.value.trim();
  if (!name) return loginError.textContent = "الرجاء إدخال اسم.";
  if (name.length < 2) return loginError.textContent = "الاسم قصير جدًا.";

  myName = name;
  loginOverlay.style.display = "none";
  startPresence();
};

/* ===== المتواجدون ===== */
function startPresence() {
  const presenceRef = db.ref(`rooms/${ROOM}/presence`);
  const connectedRef = db.ref(".info/connected");
  myPresenceRef = presenceRef.push();

  connectedRef.on("value", snap => {
    if (snap.val() === true) {
      myPresenceRef.onDisconnect().remove();
      myPresenceRef.set({ name: myName, ts: Date.now() });
    }
  });

  presenceRef.on("value", snap => {
    const count = snap.numChildren();
    document.getElementById("onlineText").textContent = count + " متواجد الآن";
    renderMembers(snap);
  });
}

function renderMembers(snapshot) {
  const list = document.getElementById("membersList");
  list.innerHTML = "";
  snapshot.forEach(child => {
    const v = child.val();
    const div = document.createElement("div");
    div.className = "member";
    div.innerHTML = `
      <div class="member-avatar">${v.name.slice(0,2)}</div>
      <div>${v.name}</div>
      <div class="member-status-dot"></div>
    `;
    list.appendChild(div);
  });
}

/* ===== نافذة المتواجدين ===== */
const membersOverlay = document.getElementById("membersOverlay");
const membersPanel = document.getElementById("membersPanel");
document.getElementById("openMembers").onclick = () => {
  membersOverlay.style.display = "block";
  setTimeout(() => membersPanel.classList.add("open"), 10);
};
membersOverlay.onclick = e => {
  if (e.target === membersOverlay) {
    membersPanel.classList.remove("open");
    setTimeout(() => membersOverlay.style.display = "none", 200);
  }
};

/* ===== الدردشة ===== */
const messagesEl = document.getElementById("messages");
const chatInput = document.getElementById("chatInput");
const sendChat = document.getElementById("sendChat");
const chatRef = db.ref(`rooms/${ROOM}/chat`);

sendChat.onclick = () => {
  const text = chatInput.value.trim();
  if (!text || !myName) return;
  chatRef.push({ name: myName, text, ts: Date.now() });
  chatInput.value = "";
};

chatRef.orderByChild("ts").on("child_added", snap => {
  const v = snap.val();
  const msg = document.createElement("div");
  msg.className = "message";
  msg.innerHTML = `
    <div class="avatar">${v.name.slice(0,1)}</div>
    <div class="bubble">
      <div class="bubble-header">
        <span>${v.name}</span>
        <span class="timestamp">${new Date(v.ts).toLocaleTimeString()}</span>
      </div>
      <div>${v.text}</div>
    </div>
  `;
  messagesEl.appendChild(msg);
  messagesEl.scrollTop = messagesEl.scrollHeight;
});

/* ===== المشغل ===== */
const videoContainer = document.getElementById('player-container');
const videoEl = document.getElementById('video-element');
const urlInput = document.getElementById('url-input');
const loadBtn = document.getElementById('load-btn');
const fileInput = document.getElementById('file-input');
const fileBtn = document.getElementById('file-btn');
const twitterSelector = document.getElementById('twitter-selector');

function isYouTube(url){ return /youtube\.com|youtu\.be/.test(url); }
function getYouTubeID(url){ const m=url.match(/(?:v=|\/)([a-zA-Z0-9_-]{11})/); return m?m[1]:null; }
function isTwitter(url){ return /twitter\.com|x\.com/.test(url); }
function isDirectVideo(url){ return /\.(mp4|webm|ogg)$/i.test(url); }
function isM3U8(url){ return /\.m3u8$/i.test(url); }

loadBtn.onclick = async () => {
  const url = urlInput.value.trim();
  if (!url) return;

  videoEl.pause();
  videoEl.src = "";
  videoContainer.innerHTML = "";
  videoContainer.appendChild(videoEl);
  twitterSelector.innerHTML = "";

  if (isYouTube(url)) {
    const id = getYouTubeID(url);
    if (!id) return alert("رابط يوتيوب غير صالح");
    const iframe = document.createElement("iframe");
    iframe.src = `https://www.youtube.com/embed/${id}?autoplay=1&mute=1`;
    iframe.allow = "autoplay; encrypted-media";
    iframe.allowFullscreen = true;
    videoContainer.innerHTML = "";
    videoContainer.appendChild(iframe);
  }

  else if (isTwitter(url)) {
    try {
      const idMatch = url.match(/status\/(\d+)/);
      if (!idMatch) return alert("رابط تويتر غير صالح");
      const id = idMatch[1];
      const resp = await fetch(`https://api.vxtwitter.com/i/status/${id}`);
      const data = await resp.json();
      if (!data.media_extended) return alert("لا يوجد فيديو");

      data.media_extended.forEach((item,i)=>{
        const btn=document.createElement("button");
        btn.textContent=`المقطع ${i+1}`;
        btn.onclick=()=>{
          twitterSelector.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
          btn.classList.add("active");
          videoEl.src=item.url;
          videoEl.play();
        };
        twitterSelector.appendChild(btn);
      });
      twitterSelector.querySelector("button").click();
    } catch(e){ alert("خطأ في تويتر"); }
  }

  else if (isM3U8(url)) {
    if (Hls.isSupported()) {
      const hls = new Hls();
      hls.loadSource(url);
      hls.attachMedia(videoEl);
      videoEl.play();
    } else alert("M3U8 غير مدعوم");
  }

  else if (isDirectVideo(url)) {
    videoEl.src = url;
    videoEl.play();
  }

  else alert("نوع الرابط غير مدعوم");
};

fileBtn.onclick = ()=>fileInput.click();
fileInput.onchange = ()=>{
  const file=fileInput.files[0];
  if (!file) return;
  const url=URL.createObjectURL(file);
  videoEl.src=url;
  videoEl.play();
};
</script>

</body>
</html>
